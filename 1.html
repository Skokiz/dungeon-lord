<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Dungeon Lord: Siege Defense</title>
    <style>
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           RESET + BASE
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

        html {
            height: 100%;
            /* iOS Safari: Ğ²Ğ¸ĞºĞ¾Ñ€Ğ¸ÑÑ‚Ğ¾Ğ²ÑƒÑ”Ğ¼Ğ¾ -webkit-fill-available */
            height: -webkit-fill-available;
        }
        body {
            width: 100%;
            height: 100%;
            min-height: -webkit-fill-available;
            overflow: hidden;
            background: #0d0820;
            font-family: -apple-system, 'Segoe UI', sans-serif;
            color: white;
            user-select: none;
            -webkit-user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        /* ĞšĞ½Ğ¾Ğ¿ĞºĞ¸: ÑĞºĞ¸Ğ´Ğ°Ñ”Ğ¼Ğ¾ user-select Ñ‰Ğ¾Ğ± iOS WKWebView Ğ½Ğµ Ğ±Ğ»Ğ¾ĞºÑƒĞ²Ğ°Ğ² click */
        button {
            user-select: none;
            -webkit-user-select: none;
            cursor: pointer;
            -webkit-touch-callout: none;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           LAYOUT: canvas fixed top, controls fixed bottom
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        #app {
            width: 100%;
            height: 100%;
        }

        #canvas-wrap {
            position: fixed;
            top: 0; left: 0; right: 0;
            bottom: var(--controls-h, 120px);
            background: #0d0820;
            overflow: hidden;
        }

        canvas {
            display: block;
            position: absolute;
            top: 0; left: 0;
            touch-action: pan-x pan-y;
            -webkit-touch-callout: none;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           HUD (Ğ¿Ğ¾Ğ²ĞµÑ€Ñ… canvas, Ñ‚Ñ–Ğ»ÑŒĞºĞ¸ ÑÑ‚Ğ°Ñ‚ÑƒÑ)
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        #hud {
            position: absolute;
            top: 0; left: 0; right: 0;
            pointer-events: none;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 8px;
            gap: 6px;
            z-index: 5;
        }
        .resource-box {
            font-weight: bold; color: #00ffcc;
            background: rgba(0,0,0,0.75);
            border-radius: 10px; border: 1px solid rgba(0,255,204,0.3);
            text-shadow: 0 0 8px #00ffcc88;
            white-space: nowrap;
        }
        .hud-right {
            background: rgba(0,0,0,0.75);
            border-radius: 10px;
            text-align: right;
        }
        .hp-label       { color: #ff6666; display: block; }
        .hp-label-lord  { color: #cc66ff; display: block; margin-top: 3px; }
        .hp-bar         { background: #333; border-radius: 3px; overflow: hidden; margin-top: 2px; }
        .hp-fill        { height: 100%; transition: width 0.2s; }
        .threat-line    { color: #ff8844; display: block; }

        /* ĞšĞ½Ğ¾Ğ¿ĞºĞ° Ğ¿Ğ°ÑƒĞ·Ğ¸ â€” Ğ°Ğ±ÑĞ¾Ğ»ÑÑ‚Ğ½Ğ¾ Ğ½Ğ°Ğ´ canvas */
        #pause-toggle-btn {
            position: absolute;
            top: 6px; left: 50%; transform: translateX(-50%);
            background: rgba(50,20,80,0.9); border: 1px solid #aa66ff;
            color: #cc99ff; border-radius: 8px;
            cursor: pointer;
            pointer-events: auto;
            -webkit-appearance: none;
            touch-action: manipulation;
            z-index: 10;
            white-space: nowrap;
        }

        /* ĞšĞ½Ğ¾Ğ¿ĞºĞ° reset save */
        #btn-hard-reset {
            position: absolute; bottom: 4px; left: 4px;
            background: rgba(40,40,40,0.8); color: #555;
            border: none; border-radius: 4px;
            pointer-events: auto; cursor: pointer;
            -webkit-appearance: none;
            touch-action: manipulation; z-index: 10;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           ĞŸĞĞĞ•Ğ›Ğ¬ Ğ£ĞŸĞ ĞĞ’Ğ›Ğ†ĞĞĞ¯
           ĞŸĞ¾Ğ²Ğ½Ñ–ÑÑ‚Ñ Ğ½ĞµĞ·Ğ°Ğ»ĞµĞ¶Ğ½Ğ° Ğ²Ñ–Ğ´ canvas â€” ĞĞ• Ğ¼Ğ°Ñ” pointer-events:none
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        #controls {
            position: fixed;
            bottom: 0; left: 0; right: 0;
            background: #09040f;
            border-top: 2px solid #1e0d35;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-bottom: env(safe-area-inset-bottom, 0px);
            z-index: 20;
        }

        .ctrl-circles {
            display: flex;
            justify-content: center;
            align-items: flex-end;
        }
        .ctrl-rects {
            display: flex;
            justify-content: center;
        }

        /* â”€â”€ ĞšÑ€ÑƒĞ³Ğ»Ğ° ĞºĞ½Ğ¾Ğ¿ĞºĞ°-Ğ¼ĞµĞ½Ñ â”€â”€ */
        .circle-menu { position: relative; display: flex; flex-direction: column; align-items: center; }

        .circle-main-btn {
            border-radius: 50%;
            border: 2px solid;
            color: white; font-weight: bold;
            cursor: pointer;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            text-align: center; line-height: 1.2;
            box-shadow: 0 3px 10px rgba(0,0,0,0.6);
            -webkit-appearance: none;
            touch-action: manipulation;
            transition: transform 0.1s;
        }
        .circle-main-btn:active { transform: scale(0.9); }

        /* ĞŸÑ–Ğ´Ğ¼ĞµĞ½Ñ */
        .circle-sub-menu {
            position: absolute;
            left: 50%; transform: translateX(-50%);
            display: none; flex-direction: column;
            align-items: center;
            background: rgba(6,3,16,0.98); border: 1px solid #444;
            border-radius: 14px;
            z-index: 100;
        }
        .circle-sub-menu.open { display: flex; animation: popUp 0.15s ease-out; }
        @keyframes popUp {
            from { opacity: 0; transform: translateX(-50%) translateY(5px); }
            to   { opacity: 1; transform: translateX(-50%) translateY(0); }
        }

        .sub-btn {
            border-radius: 50%; border: 2px solid;
            color: white; font-weight: bold; cursor: pointer;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            text-align: center; line-height: 1.2;
            -webkit-appearance: none;
            touch-action: manipulation;
            transition: transform 0.1s;
        }
        .sub-btn:active { transform: scale(0.9); }

        /* ĞšĞ¾Ğ»ÑŒĞ¾Ñ€Ğ¸ ĞºĞ½Ğ¾Ğ¿Ğ¾Ğº */
        .cmain-lord    { background: linear-gradient(145deg,#9900ee,#6600aa); border-color: #cc66ff; }
        .cmain-monster { background: linear-gradient(145deg,#005c1e,#003a12); border-color: #00cc44; }
        .cmain-trap    { background: linear-gradient(145deg,#886600,#554400); border-color: #ffcc00; }
        .s-atk   { background: linear-gradient(145deg,#cc2222,#881111); border-color: #ff5555; }
        .s-vit   { background: linear-gradient(145deg,#1a8822,#115511); border-color: #44ff66; }
        .s-spike { background: linear-gradient(145deg,#888,#555);       border-color: #bbb; }
        .s-tele  { background: linear-gradient(145deg,#2244cc,#112288); border-color: #6699ff; }
        .s-daze  { background: linear-gradient(145deg,#cc8800,#886600); border-color: #ffcc44; }

        /* ĞŸÑ€ÑĞ¼Ğ¾ĞºÑƒÑ‚Ğ½Ñ– ĞºĞ½Ğ¾Ğ¿ĞºĞ¸ */
        .rect-btn {
            border-radius: 10px; border: none; color: white;
            font-weight: bold; cursor: pointer;
            box-shadow: 0 3px 0 #000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            -webkit-appearance: none;
            touch-action: manipulation;
            transition: transform 0.1s;
        }
        .rect-btn:active { transform: translateY(2px); box-shadow: none; }
        .rect-btn small  { font-weight: normal; opacity: 0.9; }
        .btn-floor { background: #1a66dd; }
        .btn-wave  { background: #cc1130; animation: pulse 2s infinite; }
        @keyframes pulse {
            0%   { box-shadow: 0 0 0 0 rgba(220,30,60,.7), 0 3px 0 #000; }
            70%  { box-shadow: 0 0 0 8px rgba(220,30,60,0), 0 3px 0 #000; }
            100% { box-shadow: 0 0 0 0 rgba(220,30,60,0), 0 3px 0 #000; }
        }
        @keyframes can-afford {
            0%,100% { box-shadow: 0 0 0 0 rgba(255,220,50,0.6), 0 3px 6px #000; }
            50%      { box-shadow: 0 0 0 7px rgba(255,220,50,0), 0 3px 6px #000; }
        }
        .can-afford { animation: can-afford 1.4s ease-in-out infinite; }
        button:disabled { opacity: 0.45; cursor: not-allowed; }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           ĞĞ’Ğ•Ğ Ğ›Ğ•Ğ‡ (position:fixed â€” Ğ¿Ğ¾Ğ²ĞµÑ€Ñ… ÑƒÑÑŒĞ¾Ğ³Ğ¾)
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .overlay-base {
            position: fixed; top: 0; left: 0;
            width: 100%; height: 100%;
            display: none; flex-direction: column;
            justify-content: center; align-items: center;
            pointer-events: none;
        }
        /* ĞšĞ¾Ğ»Ğ¸ Ğ¾Ğ²ĞµÑ€Ğ»ĞµĞ¹ Ğ¿Ğ¾ĞºĞ°Ğ·Ğ°Ğ½Ğ¸Ğ¹ â€” Ğ²Ñ–Ğ´Ğ½Ğ¾Ğ²Ğ»ÑÑ”Ğ¼Ğ¾ pointer-events */
        .overlay-base[style*="flex"] {
            pointer-events: auto;
        }

        #game-over {
            background: rgba(0,0,0,0.93);
            gap: 16px; z-index: 200;
        }
        #game-over h1 { color: #ff3333; text-transform: uppercase; text-align: center; }
        #game-over p  { color: #999; text-align: center; }
        #btn-try-again {
            background: #ffcc00; color: #332200;
            border: none; border-radius: 10px; font-weight: bold;
            cursor: pointer; -webkit-appearance: none; touch-action: manipulation;
        }

        #pause-overlay {
            background: rgba(0,0,0,0.85);
            gap: 14px; z-index: 190;
        }
        #pause-overlay h2 { color: #cc88ff; }
        .pause-btn {
            background: rgba(80,40,120,0.95); border: 2px solid #cc88ff;
            color: #fff; border-radius: 10px;
            cursor: pointer; -webkit-appearance: none; touch-action: manipulation;
        }
        .pause-btn:active { transform: scale(0.95); }
        .threat-cap-row { display: flex; align-items: center; gap: 10px; color: #ffcc88; flex-wrap: wrap; justify-content: center; }
        .threat-cap-row input {
            width: 65px; border-radius: 6px;
            border: 1px solid #cc88ff; background: #1a0d30; color: #fff;
            text-align: center; -webkit-appearance: none; touch-action: manipulation;
        }

        #trap-hint {
            position: fixed; top: 38%; left: 50%; transform: translate(-50%,-50%);
            background: rgba(10,5,25,0.97); border: 2px solid #ffcc00;
            border-radius: 14px; text-align: center;
            z-index: 180; pointer-events: none; display: none;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           Ğ¡Ğ¢ĞĞ Ğ¢ĞĞ’Ğ˜Ğ™ Ğ•ĞšĞ ĞĞ
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        #start-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(ellipse at center, #1a0a35 0%, #0d0820 60%, #050310 100%);
            display: flex; flex-direction: column;
            justify-content: center; align-items: center; gap: 16px;
            z-index: 300;
        }
        #start-screen h1 {
            color: #cc88ff; text-shadow: 0 0 30px #aa00ff;
            text-transform: uppercase; letter-spacing: 3px; text-align: center;
        }
        #start-screen .subtitle { color: #886699; letter-spacing: 2px; }
        #start-screen .diff-label { color: #cc99ff; font-size: 13px; letter-spacing: 1px; }
        .diff-grid {
            display: grid; grid-template-columns: 1fr 1fr;
            gap: 10px; width: 90%; max-width: 340px;
        }
        .diff-btn {
            display: flex; flex-direction: column; align-items: center;
            gap: 4px; padding: 10px 6px;
            background: rgba(40,10,70,0.93); border: 2px solid #5522aa;
            border-radius: 14px; color: #fff; cursor: pointer;
            -webkit-appearance: none; touch-action: manipulation;
            transition: border-color 0.15s, transform 0.1s;
        }
        .diff-btn:active { transform: scale(0.95); }
        .diff-btn .d-name { font-weight: bold; font-size: 13px; }
        .diff-btn .d-stat { font-size: 10px; color: #bb99dd; line-height: 1.4; }
        .diff-btn.d1 { border-color: #44aa44; }
        .diff-btn.d1 .d-name { color: #66ff66; }
        .diff-btn.d2 { border-color: #88aa00; }
        .diff-btn.d2 .d-name { color: #ccee44; }
        .diff-btn.d3 { border-color: #cc6600; }
        .diff-btn.d3 .d-name { color: #ff9944; }
        .diff-btn.d4 { border-color: #cc0000; }
        .diff-btn.d4 .d-name { color: #ff4444; }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           ĞœĞ•Ğ”Ğ†ĞĞ—ĞĞŸĞ˜Ğ¢Ğ˜ â€” Ñ€Ğ¾Ğ·Ğ¼Ñ–Ñ€Ğ¸ Ğ¿Ñ–Ğ´ ĞºĞ¾Ğ¶ĞµĞ½ ĞµĞºÑ€Ğ°Ğ½
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

        /* â”€â”€ ĞœĞ°Ğ»ĞµĞ½ÑŒĞºĞ¸Ğ¹ Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½: â‰¤360px ÑˆĞ¸Ñ€Ğ¸Ğ½Ğ° (ÑÑ‚Ğ°Ñ€Ñ– Android, SE) â”€â”€ */
        @media (max-width: 360px) {
            #hud { padding: 5px 6px; }
            .resource-box { font-size: 13px; padding: 4px 8px; border-radius: 8px; }
            .hud-right { font-size: 9px; padding: 4px 7px; border-radius: 8px; }
            .hp-bar { width: 85px; height: 6px; }
            .threat-line { font-size: 8px; }
            #pause-toggle-btn { font-size: 11px; padding: 4px 10px; }
            #btn-hard-reset { font-size: 8px; padding: 2px 5px; }

            #controls { padding: 5px 4px; gap: 5px; }
            .ctrl-circles { gap: 7px; }
            .circle-main-btn { width: 58px; height: 58px; font-size: 9px; }
            .circle-main-btn .icon { font-size: 20px; }
            .circle-sub-menu { bottom: 65px; gap: 6px; padding: 7px 5px; min-width: 64px; }
            .sub-btn { width: 56px; height: 56px; font-size: 9px; }
            .sub-btn .sicon { font-size: 17px; }
            .sub-btn .scost { font-size: 9px; }
            .sub-btn .slabel { font-size: 8px; }
            .ctrl-rects { gap: 6px; }
            .rect-btn { padding: 7px 14px; font-size: 12px; border-radius: 8px; }
            .rect-btn small { font-size: 9px; }

            #start-screen h1 { font-size: 26px; letter-spacing: 2px; }
            #start-screen .subtitle { font-size: 10px; margin-top: -8px; }
            .diff-grid { gap: 8px; max-width: 300px; }
            .diff-btn { padding: 8px 5px; }
            .diff-btn .d-name { font-size: 12px; }
            .diff-btn .d-stat { font-size: 9px; }

            #pause-overlay h2 { font-size: 24px; }
            .pause-btn { font-size: 14px; padding: 10px 22px; }
            .threat-cap-row { font-size: 12px; gap: 7px; }
            .threat-cap-row input { width: 55px; font-size: 13px; padding: 4px; }
            #trap-hint { padding: 10px 14px; }
            #game-over h1 { font-size: 32px; }
            #btn-try-again { font-size: 14px; padding: 11px 22px; }
        }

        /* â”€â”€ Ğ¡Ñ‚Ğ°Ğ½Ğ´Ğ°Ñ€Ñ‚Ğ½Ğ¸Ğ¹ Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½: 361â€“414px (iPhone 8/X/11/12, Ğ±Ñ–Ğ»ÑŒÑˆÑ–ÑÑ‚ÑŒ Android) â”€â”€ */
        @media (min-width: 361px) and (max-width: 414px) {
            #hud { padding: 7px 8px; }
            .resource-box { font-size: 15px; padding: 5px 10px; border-radius: 9px; }
            .hud-right { font-size: 10px; padding: 5px 9px; border-radius: 9px; }
            .hp-bar { width: 100px; height: 7px; }
            .threat-line { font-size: 9px; }
            #pause-toggle-btn { font-size: 12px; padding: 5px 13px; }
            #btn-hard-reset { font-size: 9px; padding: 3px 6px; }

            #controls { padding: 7px 5px; gap: 6px; }
            .ctrl-circles { gap: 9px; }
            .circle-main-btn { width: 64px; height: 64px; font-size: 10px; }
            .circle-main-btn .icon { font-size: 22px; }
            .circle-sub-menu { bottom: 72px; gap: 7px; padding: 8px 6px; min-width: 70px; }
            .sub-btn { width: 62px; height: 62px; font-size: 10px; }
            .sub-btn .sicon { font-size: 19px; }
            .sub-btn .scost { font-size: 10px; }
            .sub-btn .slabel { font-size: 9px; }
            .ctrl-rects { gap: 7px; }
            .rect-btn { padding: 9px 18px; font-size: 13px; }
            .rect-btn small { font-size: 10px; }

            #start-screen h1 { font-size: 30px; letter-spacing: 2px; margin-bottom: 4px; }
            #start-screen .subtitle { font-size: 11px; margin-top: -10px; }
            #start-screen { gap: 14px; }
            .diff-grid { gap: 9px; max-width: 310px; }
            .diff-btn { padding: 9px 5px; }
            .diff-btn .d-name { font-size: 12px; }
            .diff-btn .d-stat { font-size: 10px; }

            #pause-overlay h2 { font-size: 26px; }
            .pause-btn { font-size: 15px; padding: 11px 26px; }
            .threat-cap-row { font-size: 13px; gap: 8px; }
            .threat-cap-row input { width: 58px; font-size: 14px; padding: 4px; }
            #trap-hint { padding: 12px 16px; }
            #game-over h1 { font-size: 36px; }
            #btn-try-again { font-size: 15px; padding: 12px 24px; }
        }

        /* â”€â”€ Ğ’ĞµĞ»Ğ¸ĞºĞ¸Ğ¹ Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½: 415â€“480px (iPhone Plus/Pro Max, Ğ²ĞµĞ»Ğ¸ĞºĞ¸Ğ¹ Android) â”€â”€ */
        @media (min-width: 415px) and (max-width: 480px) {
            #hud { padding: 8px 10px; }
            .resource-box { font-size: 17px; padding: 6px 12px; border-radius: 10px; }
            .hud-right { font-size: 11px; padding: 6px 10px; border-radius: 10px; }
            .hp-bar { width: 115px; height: 8px; }
            .threat-line { font-size: 10px; }
            #pause-toggle-btn { font-size: 13px; padding: 5px 15px; }
            #btn-hard-reset { font-size: 9px; padding: 3px 7px; }

            #controls { padding: 8px 6px; gap: 7px; }
            .ctrl-circles { gap: 11px; }
            .circle-main-btn { width: 70px; height: 70px; font-size: 11px; }
            .circle-main-btn .icon { font-size: 25px; }
            .circle-sub-menu { bottom: 78px; gap: 8px; padding: 9px 7px; min-width: 76px; }
            .sub-btn { width: 68px; height: 68px; font-size: 11px; }
            .sub-btn .sicon { font-size: 21px; }
            .sub-btn .scost { font-size: 11px; }
            .sub-btn .slabel { font-size: 10px; }
            .ctrl-rects { gap: 8px; }
            .rect-btn { padding: 10px 22px; font-size: 15px; }
            .rect-btn small { font-size: 11px; }

            #start-screen h1 { font-size: 34px; letter-spacing: 3px; }
            #start-screen .subtitle { font-size: 12px; margin-top: -12px; }
            #start-screen { gap: 16px; }
            .diff-grid { gap: 10px; max-width: 320px; }
            .diff-btn { padding: 10px 6px; }
            .diff-btn .d-name { font-size: 13px; }
            .diff-btn .d-stat { font-size: 10px; }

            #pause-overlay h2 { font-size: 28px; }
            .pause-btn { font-size: 16px; padding: 12px 28px; }
            .threat-cap-row { font-size: 14px; gap: 9px; }
            .threat-cap-row input { width: 62px; font-size: 15px; padding: 5px; }
            #trap-hint { padding: 13px 18px; }
            #game-over h1 { font-size: 40px; }
            #btn-try-again { font-size: 16px; padding: 13px 26px; }
        }

        /* â”€â”€ ĞŸĞ»Ğ°Ğ½ÑˆĞµÑ‚ / Ğ²ĞµĞ»Ğ¸ĞºĞ¸Ğ¹ ĞµĞºÑ€Ğ°Ğ½: 481px+ â”€â”€ */
        @media (min-width: 481px) {
            #hud { padding: 10px 14px; }
            .resource-box { font-size: 20px; padding: 7px 16px; border-radius: 12px; }
            .hud-right { font-size: 12px; padding: 8px 12px; border-radius: 12px; }
            .hp-bar { width: 140px; height: 9px; }
            .threat-line { font-size: 11px; }
            #pause-toggle-btn { font-size: 15px; padding: 7px 20px; }
            #btn-hard-reset { font-size: 10px; padding: 4px 8px; }

            #controls { padding: 10px 8px; gap: 8px; }
            .ctrl-circles { gap: 16px; }
            .circle-main-btn { width: 82px; height: 82px; font-size: 13px; }
            .circle-main-btn .icon { font-size: 30px; }
            .circle-sub-menu { bottom: 90px; gap: 10px; padding: 12px 9px; min-width: 88px; }
            .sub-btn { width: 78px; height: 78px; font-size: 13px; }
            .sub-btn .sicon { font-size: 24px; }
            .sub-btn .scost { font-size: 13px; }
            .sub-btn .slabel { font-size: 12px; }
            .ctrl-rects { gap: 12px; }
            .rect-btn { padding: 13px 30px; font-size: 17px; }
            .rect-btn small { font-size: 13px; }

            #start-screen h1 { font-size: 44px; letter-spacing: 4px; }
            #start-screen .subtitle { font-size: 15px; margin-top: -14px; }
            #start-screen { gap: 22px; }
            .diff-grid { gap: 12px; max-width: 380px; }
            .diff-btn { padding: 14px 8px; border-radius: 16px; }
            .diff-btn .d-name { font-size: 15px; }
            .diff-btn .d-stat { font-size: 12px; }

            #pause-overlay h2 { font-size: 34px; }
            .pause-btn { font-size: 18px; padding: 14px 34px; }
            .threat-cap-row { font-size: 16px; gap: 12px; }
            .threat-cap-row input { width: 70px; font-size: 16px; padding: 6px; }
            #trap-hint { padding: 16px 24px; }
            #game-over h1 { font-size: 50px; }
            #btn-try-again { font-size: 18px; padding: 14px 30px; }
        }

        /* â”€â”€ Ğ’Ğ¸ÑĞ¾Ñ‚Ğ° ĞµĞºÑ€Ğ°Ğ½Ñƒ: ĞºĞ¾Ğ¼Ğ¿ĞµĞ½ÑÑƒÑ”Ğ¼Ğ¾ Ğ´ÑƒĞ¶Ğµ Ğ½Ğ¸Ğ·ÑŒĞºÑ– ĞµĞºÑ€Ğ°Ğ½Ğ¸ â”€â”€ */
        @media (max-height: 650px) {
            #controls { padding-top: 4px; padding-bottom: 4px; gap: 4px; }
            .circle-main-btn { width: 56px !important; height: 56px !important; }
            .circle-main-btn .icon { font-size: 19px !important; }
            .sub-btn { width: 54px !important; height: 54px !important; }
            .circle-sub-menu { bottom: 63px !important; }
            .rect-btn { padding-top: 6px !important; padding-bottom: 6px !important; }
        }
    </style>
</head>
<body>

<!-- â”€â”€ Ğ¡Ğ¢ĞĞ Ğ¢ĞĞ’Ğ˜Ğ™ Ğ•ĞšĞ ĞĞ â”€â”€ -->
<div id="start-screen">
    <h1>ğŸ‘‘ Dungeon Lord</h1>
    <div class="subtitle">Siege Defense</div>
    <div class="diff-label">ĞĞ±ĞµÑ€Ñ–Ñ‚ÑŒ ÑĞºĞ»Ğ°Ğ´Ğ½Ñ–ÑÑ‚ÑŒ</div>
    <div class="diff-grid">
        <button class="diff-btn d1" onclick="startGame(1)">
            <div class="d-name">âš”ï¸ Ğ›ĞµĞ³ĞºĞ¸Ğ¹</div>
            <div class="d-stat">ğŸ° 2000 HP Ğ¼Ñ–ÑÑ‚Ğ°</div>
            <div class="d-stat">ğŸ‘¤ Ğ¡Ñ‚Ğ°Ğ½Ğ´Ğ°Ñ€Ñ‚</div>
            <div class="d-stat">ğŸ’€ Ğ—Ğ°Ğ³Ñ€Ğ¾Ğ·Ğ° Ğ´Ğ¾ 20</div>
        </button>
        <button class="diff-btn d2" onclick="startGame(2)">
            <div class="d-name">ğŸ—¡ï¸ ĞĞ¾Ñ€Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¸Ğ¹</div>
            <div class="d-stat">ğŸ° 4000 HP Ğ¼Ñ–ÑÑ‚Ğ°</div>
            <div class="d-stat">ğŸ‘¤ +10% Ğ³ĞµÑ€Ğ¾Ñ—</div>
            <div class="d-stat">ğŸ’€ Ğ—Ğ°Ğ³Ñ€Ğ¾Ğ·Ğ° Ğ´Ğ¾ 40</div>
        </button>
        <button class="diff-btn d3" onclick="startGame(3)">
            <div class="d-name">ğŸ”¥ Ğ’Ğ°Ğ¶ĞºĞ¸Ğ¹</div>
            <div class="d-stat">ğŸ° 8000 HP Ğ¼Ñ–ÑÑ‚Ğ°</div>
            <div class="d-stat">ğŸ‘¤ +20% Ğ³ĞµÑ€Ğ¾Ñ—</div>
            <div class="d-stat">ğŸ’€ Ğ—Ğ°Ğ³Ñ€Ğ¾Ğ·Ğ° Ğ´Ğ¾ 60</div>
        </button>
        <button class="diff-btn d4" onclick="startGame(4)">
            <div class="d-name">ğŸ’€ ĞŸĞµĞºĞ»Ğ¾</div>
            <div class="d-stat">ğŸ° 15000 HP Ğ¼Ñ–ÑÑ‚Ğ°</div>
            <div class="d-stat">ğŸ‘¤ +30% Ğ³ĞµÑ€Ğ¾Ñ—</div>
            <div class="d-stat">ğŸ’€ Ğ—Ğ°Ğ³Ñ€Ğ¾Ğ·Ğ° Ğ´Ğ¾ 80</div>
        </button>
    </div>
</div>

<!-- â”€â”€ ĞŸĞĞ£Ğ—Ğ â”€â”€ -->
<div id="pause-overlay" class="overlay-base">
    <h2>â¸ ĞŸĞĞ£Ğ—Ğ</h2>
    <div class="threat-cap-row">
        <span>ĞœĞ°ĞºÑ Ğ·Ğ°Ğ³Ñ€Ğ¾Ğ·Ğ°:</span>
        <input type="number" id="threat-cap-input" min="1" max="100" value="100">
        <button class="pause-btn" id="pause-set-threat-btn" onclick="setThreatCap()">âœ”</button>
    </div>
    <button class="pause-btn" id="pause-resume-btn" onclick="togglePause()">â–¶ ĞŸÑ€Ğ¾Ğ´Ğ¾Ğ²Ğ¶Ğ¸Ñ‚Ğ¸</button>
    <button class="pause-btn" id="pause-restart-btn" onclick="hardReset()" style="margin-top:8px;background:rgba(180,30,30,0.85);border-color:#ff4444;">ğŸ”„ Ğ ĞµÑÑ‚Ğ°Ñ€Ñ‚</button>
</div>

<!-- â”€â”€ GAME OVER â”€â”€ -->
<div id="game-over" class="overlay-base">
    <h1 id="go-title">ĞŸĞĞ ĞĞ—ĞšĞ</h1>
    <p id="go-desc" style="color:#aaa;font-size:16px;margin-top:8px;">Ğ’Ğ¾Ğ»Ğ¾Ğ´Ğ°Ñ€Ñ Ğ²Ğ±Ğ¸Ñ‚Ğ¾...</p>
    <button id="btn-try-again" onclick="hardReset()">ğŸ”„ Ğ¡Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ²Ğ°Ñ‚Ğ¸ Ğ·Ğ½Ğ¾Ğ²Ñƒ</button>
</div>

<!-- â”€â”€ ĞŸĞ†Ğ”ĞšĞĞ—ĞšĞ ĞŸĞĞ¡Ğ¢ĞšĞ˜ â”€â”€ -->
<div id="trap-hint">
    <div style="font-size:20px;margin-bottom:4px" id="trap-hint-icon">ğŸŒ€</div>
    <div style="font-size:13px;font-weight:bold;color:#ffcc00;">ĞĞ°Ñ‚Ğ¸ÑĞ½Ğ¸ Ğ½Ğ° Ğ¿Ğ¾Ğ²ĞµÑ€Ñ…</div>
    <div style="font-size:10px;color:#aaa;margin-top:3px;">Ğ´Ğ»Ñ Ğ²ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ Ğ¿Ğ°ÑÑ‚ĞºĞ¸</div>
</div>

<!-- â”€â”€ Ğ“ĞĞ›ĞĞ’ĞĞ˜Ğ™ LAYOUT â”€â”€ -->
<div id="app">

    <!-- Canvas area -->
    <div id="canvas-wrap">
        <canvas id="gameCanvas"></canvas>

        <!-- HUD Ğ¿Ğ¾Ğ²ĞµÑ€Ñ… canvas (Ñ‚Ñ–Ğ»ÑŒĞºĞ¸ Ñ‡Ğ¸Ñ‚Ğ°Ğ½Ğ½Ñ, pointer-events:none) -->
        <div id="hud">
            <div class="resource-box">ğŸ’€ <span id="souls-display">150</span></div>
            <div class="hud-right">
                <div class="hp-label">â¤ï¸ ĞœÑ–ÑÑ‚Ğ¾</div>
                <div class="hp-bar"><div id="city-hp" class="hp-fill" style="width:100%;background:#ff4444"></div></div>
                <div class="hp-label-lord">ğŸ’œ Ğ’Ğ¾Ğ»Ğ¾Ğ´Ğ°Ñ€</div>
                <div class="hp-bar"><div id="lord-hp" class="hp-fill" style="width:100%;background:#aa00ff"></div></div>
                <div class="threat-line">âš”ï¸ <span id="difficulty-level">0</span> | +<span id="hero-scale">0</span>%</div>
            </div>
        </div>

        <!-- ĞšĞ½Ğ¾Ğ¿ĞºĞ° Ğ¿Ğ°ÑƒĞ·Ğ¸ -->
        <button id="pause-toggle-btn" onclick="togglePause()">â¸ ĞŸĞ°ÑƒĞ·Ğ°</button>

    </div>

    <!-- â”€â”€ ĞŸĞĞĞ•Ğ›Ğ¬ Ğ£ĞŸĞ ĞĞ’Ğ›Ğ†ĞĞĞ¯ â”€â”€ -->
    <div id="controls">

        <!-- Ğ ÑĞ´ 1: ĞºÑ€ÑƒĞ³Ğ»Ñ– ĞºĞ½Ğ¾Ğ¿ĞºĞ¸ -->
        <div class="ctrl-circles">

            <div class="circle-menu" id="menu-lord">
                <div class="circle-sub-menu" id="sub-lord">
                    <button class="sub-btn s-atk" id="btn-lord-atk" onclick="upgradeLordAttack()">
                        <span class="sicon">âš”ï¸</span>
                        <span class="slabel">ĞÑ‚Ğ°ĞºĞ°</span>
                        <span class="scost" id="lord-atk-cost">80ğŸ’€</span>
                    </button>
                    <button class="sub-btn s-vit" id="btn-lord-vit" onclick="upgradeLordVit()">
                        <span class="sicon">ğŸ’š</span>
                        <span class="slabel">HP+Ğ ĞµĞ³ĞµĞ½</span>
                        <span class="scost" id="lord-vit-cost">70ğŸ’€</span>
                    </button>
                </div>
                <button class="circle-main-btn cmain-lord" id="btn-menu-lord" onclick="toggleMenu('lord')">
                    <span class="icon">ğŸ‘‘</span>
                    <span>Ğ’Ğ¾Ğ»Ğ¾Ğ´Ğ°Ñ€</span>
                </button>
            </div>

            <div class="circle-menu" id="menu-monster">
                <div class="circle-sub-menu" id="sub-monster">
                    <button class="sub-btn s-atk" id="btn-mob-atk" onclick="upgradeMonsterAtk()">
                        <span class="sicon">ğŸ—¡ï¸</span>
                        <span class="slabel">ĞÑ‚Ğº+Ğ¨Ğ</span>
                        <span class="scost" id="mob-atk-cost">75ğŸ’€</span>
                    </button>
                    <button class="sub-btn s-vit" id="btn-mob-vit" onclick="upgradeMonsterVit()">
                        <span class="sicon">ğŸ›¡ï¸</span>
                        <span class="slabel">HP+Ğ ĞµĞ³ĞµĞ½</span>
                        <span class="scost" id="mob-vit-cost">60ğŸ’€</span>
                    </button>
                </div>
                <button class="circle-main-btn cmain-monster" id="btn-menu-monster" onclick="toggleMenu('monster')">
                    <span class="icon">ğŸ§Ÿ</span>
                    <span>ĞœĞ¾Ğ½ÑÑ‚Ñ€Ğ¸</span>
                </button>
            </div>

            <div class="circle-menu" id="menu-trap">
                <div class="circle-sub-menu" id="sub-trap">
                    <button class="sub-btn s-spike" id="btn-trap-spike" onclick="buyTrap('spike')">
                        <span class="sicon">ğŸ—¡ï¸</span>
                        <span class="slabel">Ğ¨Ğ¸Ğ¿Ğ¸</span>
                        <span class="scost">50ğŸ’€</span>
                    </button>
                    <button class="sub-btn s-tele" id="btn-trap-tele" onclick="buyTrap('teleport')">
                        <span class="sicon">ğŸŒ€</span>
                        <span class="slabel">Ğ¢ĞµĞ»ĞµĞ¿Ğ¾Ñ€Ñ‚</span>
                        <span class="scost">120ğŸ’€</span>
                    </button>
                    <button class="sub-btn s-daze" id="btn-trap-daze" onclick="buyTrap('daze')">
                        <span class="sicon">ğŸ’«</span>
                        <span class="slabel">Ğ—Ğ°Ğ¿Ğ°Ğ¼Ğ¾Ñ€.</span>
                        <span class="scost">200ğŸ’€</span>
                    </button>
                </div>
                <button class="circle-main-btn cmain-trap" id="btn-menu-trap" onclick="toggleMenu('trap')">
                    <span class="icon">ğŸª¤</span>
                    <span>ĞŸĞ°ÑÑ‚ĞºĞ¸</span>
                </button>
            </div>

        </div>

        <!-- Ğ ÑĞ´ 2: ĞŸĞ¾Ğ²ĞµÑ€Ñ… + Ğ¥Ğ²Ğ¸Ğ»Ñ -->
        <div class="ctrl-rects">
            <button class="rect-btn btn-floor" id="btn-floor" onclick="buyFloor()">
                ğŸ—ï¸ ĞŸĞ¾Ğ²ĞµÑ€Ñ…<br><small id="floor-cost-lbl">100ğŸ’€</small>
            </button>
            <button class="rect-btn btn-wave" id="btn-wave" onclick="triggerWave()">âš”ï¸ Ğ¥Ğ’Ğ˜Ğ›Ğ¯</button>
        </div>

    </div>
</div>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');

// Ğ›Ğ¾Ğ³Ñ–Ñ‡Ğ½Ñ– Ñ€Ğ¾Ğ·Ğ¼Ñ–Ñ€Ğ¸ ĞµĞºÑ€Ğ°Ğ½Ñƒ (CSS px) â€” Ğ¾Ğ½Ğ¾Ğ²Ğ»ÑÑÑ‚ÑŒÑÑ Ğ¿Ñ€Ğ¸ resize
let gW = window.innerWidth;
let gH = window.innerHeight;

const isMobile = window.innerWidth < 768;
// CFG â€” Ğ¼ÑƒÑ‚Ğ°Ğ±ĞµĞ»ÑŒĞ½Ğ¸Ğ¹, Ğ¾Ğ½Ğ¾Ğ²Ğ»ÑÑ”Ñ‚ÑŒÑÑ Ğ² resize() Ğ¿Ñ–Ğ´ Ñ€Ğ¾Ğ·Ğ¼Ñ–Ñ€ ĞµĞºÑ€Ğ°Ğ½Ñƒ
let CFG = {
    floorH: 80,
    floorW: Math.min(window.innerWidth - 60, 380),
    surfaceY: 110,
};

// =================== GAME STATE ===================
let GAME = {
    souls: 150,
    floorCost: 100,
    cityHP: 2000, maxCityHP: 2000,
    maxLordHP: 500, lordDmg: 20,
    lordBaseAtkSpeed: 0.8,   // Ğ±Ğ°Ğ·Ğ¾Ğ²Ğ° Ğ¨Ğ (Dota2-ÑÑ‚Ğ¸Ğ»ÑŒ)
    lordAtkSpeedBonus: 0,    // Ğ±Ğ¾Ğ½ÑƒÑ Ğ¨Ğ Ğ²Ñ–Ğ´ Ğ°Ğ¿Ğ³Ñ€ĞµĞ¹Ğ´Ñ–Ğ²
    lordArmor: 5,            // Ğ±Ñ€Ğ¾Ğ½Ñ Ğ»Ğ¾Ñ€Ğ´Ğ° (5 Ğ±Ğ°Ğ·Ğ¾Ğ²Ğ¾ + Ğ°Ğ¿Ğ³Ñ€ĞµĞ¹Ğ´Ğ¸)
    lordRegen: 1,            // Ğ±Ğ°Ğ·Ğ¾Ğ²Ğ¸Ğ¹ Ñ€ĞµĞ³ĞµĞ½ HP/ÑĞµĞº (Ğ·Ğ°Ğ²Ğ¶Ğ´Ğ¸ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ¸Ğ¹)
    lordRegenPct: 0,         // % Ğ¼Ğ°ĞºÑ HP/ÑĞµĞº (Ğ½Ğ°ĞºĞ¾Ğ¿Ğ¸Ñ‡ÑƒÑ”Ñ‚ÑŒÑÑ Ğ· Ğ°Ğ¿Ğ³Ñ€ĞµĞ¹Ğ´Ñ–Ğ²)
    // Ğ¦Ñ–Ğ½Ğ¸ â€” Ğ’Ğ¾Ğ»Ğ¾Ğ´Ğ°Ñ€
    lordAtkCost: 80,
    lordVitCost: 70,
    // Ğ¦Ñ–Ğ½Ğ¸ â€” ĞœĞ¾Ğ½ÑÑ‚Ñ€Ğ¸
    mobAtkCost: 75,
    mobVitCost: 60,
    monsterHpBonus: 0,
    monsterDmgBonus: 0,
    monsterArmorBonus: 0,    // Ğ±Ñ€Ğ¾Ğ½Ñ Ğ¼Ğ¾Ğ½ÑÑ‚Ñ€Ñ–Ğ² Ğ²Ñ–Ğ´ Ğ°Ğ¿Ğ³Ñ€ĞµĞ¹Ğ´Ñ–Ğ²
    monsterAtkSpeedBonus: 0, // Ğ±Ğ¾Ğ½ÑƒÑ Ğ¨Ğ Ñƒ ÑÑ‚Ğ¸Ğ»Ñ– Dota2 (Ğ±Ğ°Ğ·Ğ¾Ğ²Ğ° Ğ¨Ğ = 0.83 Ğ°Ñ‚Ğº/ÑĞµĞº)
    isWave: false,
    gameOver: false,
    cameraY: 0,
    // Ğ§Ğ°Ñ Ñ– Ğ¼Ğ°ÑÑˆÑ‚Ğ°Ğ±ÑƒĞ²Ğ°Ğ½Ğ½Ñ
    gameTime: 0,
    heroScalePercent: 0,
    waveCount: 0,
    eliteChance: 0,    // +1% ĞºĞ¾Ğ¶Ğ½Ñ– 60Ñ, Ğ¼Ğ°ĞºÑ 100%
    captainChance: 0,  // +1% ĞºĞ¾Ğ¶Ğ½Ñ– 60Ñ, Ğ¼Ğ°ĞºÑ 100%
    extraHeroChance: 0,// +4% Ğ·Ğ° Ñ€Ñ–Ğ²ĞµĞ½ÑŒ Ğ·Ğ°Ğ³Ñ€Ğ¾Ğ·Ğ¸, Ğ¼Ğ°ĞºÑ 100%
    difficultyLevel: 0,
    bossSent75: false, // Ñ‡Ğ¸ Ğ²Ğ¶Ğµ Ğ¿Ğ¾ÑĞ¸Ğ»Ğ°Ğ»Ğ¸ Ğ±Ğ¾ÑĞ° Ğ¿Ñ€Ğ¸ 75%
    bossSent50: false,
    bossSent20: false,
    maxThreatLevel: 999,
};

let floors = [];
let units = [];
let particles = [];
let dmgTexts = [];        // Ğ¿Ğ»Ğ°Ğ²Ğ°ÑÑ‡Ñ– Ñ‡Ğ¸ÑĞ»Ğ° Ğ¿Ğ¾ÑˆĞºĞ¾Ğ´Ğ¶ĞµĞ½ÑŒ
let screenShake = 0;      // ĞºĞ°Ğ´Ñ€Ğ¸ Ñ‚Ñ€ĞµĞ¼Ñ‚Ñ–Ğ½Ğ½Ñ ĞµĞºÑ€Ğ°Ğ½Ñƒ
let axeProjectiles = []; // ÑĞ½Ğ°Ñ€ÑĞ´Ğ¸ Ğ³Ğ¾Ğ±Ğ»Ñ–Ğ½Ñ–Ğ²
let centerX = gW / 2;
let CAVE_X = centerX + CFG.floorW * 0.35; // Ñ‚Ğ¾Ñ‡ĞºĞ° Ğ²Ğ¸Ñ…Ğ¾Ğ´Ñƒ Ğ¼Ğ¾Ğ½ÑÑ‚Ñ€Ñ–Ğ² Ğ· Ğ¿Ñ–Ğ´Ğ·ĞµĞ¼ĞµĞ»Ğ»Ñ
let CITY_GATE_X = 104; // X Ğ²Ğ¾Ñ€Ñ–Ñ‚ Ğ¼Ñ–ÑÑ‚Ğ° (Ğ¾Ğ½Ğ¾Ğ²Ğ»ÑÑ”Ñ‚ÑŒÑÑ Ğ² resize Ñ– Ğ¿Ñ€Ğ¸ Ğ¼Ğ°Ğ»ÑĞ²Ğ°Ğ½Ğ½Ñ–)

// Drag/touch
let isDragging = false;
let lastDragY = 0;
let manualCameraY = null;
let cameraReturnTimer = 0;

// =================== ĞšĞ›ĞĞ¡ ĞŸĞĞ’Ğ•Ğ Ğ¥ ===================
class Floor {
    constructor(depth) {
        this.depth = depth;
        this.y = 250 + depth * CFG.floorH;
        this.spawnTimer = 0;
        this.hasTrap = false;
        this.trapType = null; // 'spike','teleport','daze'
        this.teleportCooldown = 0;
        this.maxMonsters = 2;
        this.floorUpgradeCost = 60;
        this.ladderX = (depth % 2 === 0)
            ? centerX - CFG.floorW/2 + 25   // 25px Ğ²Ñ–Ğ´ Ğ»Ñ–Ğ²Ğ¾Ñ— ÑÑ‚Ñ–Ğ½Ğ¸
            : centerX + CFG.floorW/2 - 25;  // 25px Ğ²Ñ–Ğ´ Ğ¿Ñ€Ğ°Ğ²Ğ¾Ñ— ÑÑ‚Ñ–Ğ½Ğ¸
    }

    draw(camY) {
        let fx  = centerX - CFG.floorW/2;
        let fy  = this.y - camY;           // Ğ½Ğ¸Ğ· (Ğ¿Ñ–Ğ´Ğ»Ğ¾Ğ³Ğ°)
        let fty = fy - CFG.floorH;         // Ğ²ĞµÑ€Ñ… ĞºÑ–Ğ¼Ğ½Ğ°Ñ‚Ğ¸
        let fw  = CFG.floorW;
        let fh  = CFG.floorH;
        let lordFloorIdx = floors.length - 1;
        let isLordFloor  = this.depth === lordFloorIdx;

        // â”€â”€ 1. Ğ—Ğ°Ğ¿Ğ¾Ğ²Ğ½ĞµĞ½Ğ½Ñ ĞºÑ–Ğ¼Ğ½Ğ°Ñ‚Ğ¸ (ĞºĞ°Ğ¼'ÑĞ½Ğ° Ğ¿Ğ¾Ñ€Ğ¾Ğ´Ğ°) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        let roomGrad = ctx.createLinearGradient(fx, fty, fx, fy);
        roomGrad.addColorStop(0,   '#1a1218');
        roomGrad.addColorStop(0.5, '#231828');
        roomGrad.addColorStop(1,   '#1a1218');
        ctx.fillStyle = roomGrad;
        ctx.fillRect(fx, fty, fw, fh);

        // â”€â”€ 2. ĞšĞ°Ğ¼'ÑĞ½Ñ– ÑÑ‚Ñ–Ğ½Ğ¸ (Ğ»Ñ–Ğ²Ğ° Ñ– Ğ¿Ñ€Ğ°Ğ²Ğ°) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        let wallW = 22;
        // Ğ»Ñ–Ğ²Ğ° ÑÑ‚Ñ–Ğ½Ğ°
        let wgL = ctx.createLinearGradient(fx - wallW, 0, fx, 0);
        wgL.addColorStop(0, '#0d0a10'); wgL.addColorStop(1, '#2e2040');
        ctx.fillStyle = wgL;
        ctx.fillRect(fx - wallW, fty, wallW, fh + 15);
        // Ğ¿Ñ€Ğ°Ğ²Ğ° ÑÑ‚Ñ–Ğ½Ğ°
        let wgR = ctx.createLinearGradient(fx + fw, 0, fx + fw + wallW, 0);
        wgR.addColorStop(0, '#2e2040'); wgR.addColorStop(1, '#0d0a10');
        ctx.fillStyle = wgR;
        ctx.fillRect(fx + fw, fty, wallW, fh + 15);

        // ĞºĞ°Ğ¼'ÑĞ½Ğ° Ñ‚ĞµĞºÑÑ‚ÑƒÑ€Ğ° â€” Ğ³Ğ¾Ñ€Ğ¸Ğ·Ğ¾Ğ½Ñ‚Ğ°Ğ»ÑŒĞ½Ñ– Ñ‚Ñ€Ñ–Ñ‰Ğ¸Ğ½Ğ¸
        ctx.strokeStyle = 'rgba(0,0,0,0.35)';
        ctx.lineWidth = 1;
        for (let row = 0; row < 3; row++) {
            let ry = fty + (fh / 3) * row + fh / 6;
            // Ğ»Ñ–Ğ²Ğ° ÑÑ‚Ñ–Ğ½Ğ° Ñ†ĞµĞ³Ğ»Ğ°
            ctx.beginPath(); ctx.moveTo(fx - wallW, ry); ctx.lineTo(fx, ry); ctx.stroke();
            ctx.beginPath(); ctx.moveTo(fx - wallW + 4, ry - 7); ctx.lineTo(fx - wallW + 4, ry); ctx.stroke();
            // Ğ¿Ñ€Ğ°Ğ²Ğ° ÑÑ‚Ñ–Ğ½Ğ° Ñ†ĞµĞ³Ğ»Ğ°
            ctx.beginPath(); ctx.moveTo(fx + fw, ry); ctx.lineTo(fx + fw + wallW, ry); ctx.stroke();
            ctx.beginPath(); ctx.moveTo(fx + fw + wallW - 4, ry - 7); ctx.lineTo(fx + fw + wallW - 4, ry); ctx.stroke();
        }

        // â”€â”€ 3. ĞŸÑ–Ğ´Ğ»Ğ¾Ğ³Ğ° â€” ĞºĞ°Ğ¼'ÑĞ½Ñ– Ğ¿Ğ»Ğ¸Ñ‚Ğ¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        let floorGrad = ctx.createLinearGradient(0, fy, 0, fy + 14);
        floorGrad.addColorStop(0, '#4a3060'); floorGrad.addColorStop(1, '#2a1840');
        ctx.fillStyle = floorGrad;
        ctx.fillRect(fx, fy, fw, 14);
        // Ğ¿Ğ»Ğ¸Ñ‚ĞºĞ¾Ğ²Ñ– Ğ»Ñ–Ğ½Ñ–Ñ— Ğ½Ğ° Ğ¿Ñ–Ğ´Ğ»Ğ¾Ğ·Ñ–
        ctx.strokeStyle = 'rgba(0,0,0,0.5)'; ctx.lineWidth = 1;
        let tileW = 40;
        for (let tx = fx; tx < fx + fw; tx += tileW) {
            ctx.beginPath(); ctx.moveTo(tx, fy); ctx.lineTo(tx, fy + 14); ctx.stroke();
        }
        // Ğ’Ñ–Ğ´Ğ±Ğ»Ğ¸ÑĞº Ğ·Ğ²ĞµÑ€Ñ…Ñƒ Ğ¿Ñ–Ğ´Ğ»Ğ¾Ğ³Ğ¸
        ctx.fillStyle = 'rgba(180,140,255,0.08)';
        ctx.fillRect(fx, fy, fw, 3);

        // â”€â”€ 4. Ğ¡Ñ‚ĞµĞ»Ñ â€” ÑÑ‚Ğ°Ğ»Ğ°ĞºÑ‚Ğ¸Ñ‚Ğ¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        ctx.fillStyle = '#120e1a';
        ctx.fillRect(fx, fty, fw, 8);
        // Ğ´ĞµÑ‚ĞµÑ€Ğ¼Ñ–Ğ½Ğ¾Ğ²Ğ°Ğ½Ñ– ÑÑ‚Ğ°Ğ»Ğ°ĞºÑ‚Ğ¸Ñ‚Ğ¸ Ñ‡ĞµÑ€ĞµĞ· seed Ğ³Ğ»Ğ¸Ğ±Ğ¸Ğ½Ğ¸
        let seed = this.depth * 137 + 42;
        let pseudo = (n) => { seed = (seed * 1664525 + 1013904223) & 0xffffffff; return Math.abs(seed % n); };
        let stCount = 6 + pseudo(6);
        for (let s = 0; s < stCount; s++) {
            let sx = fx + 20 + pseudo(fw - 40);
            let sh = 10 + pseudo(22);
            let sw = 4 + pseudo(7);
            ctx.fillStyle = '#1e1428';
            ctx.beginPath();
            ctx.moveTo(sx - sw/2, fty + 8);
            ctx.lineTo(sx + sw/2, fty + 8);
            ctx.lineTo(sx, fty + 8 + sh);
            ctx.closePath(); ctx.fill();
            // ĞšÑ€Ğ°Ğ¿Ğ»Ñ
            if (pseudo(3) === 0) {
                let dropAlpha = 0.4 + 0.4 * Math.sin(Date.now()/800 + s);
                ctx.fillStyle = `rgba(100,180,255,${dropAlpha})`;
                ctx.beginPath(); ctx.arc(sx, fty + 8 + sh + 3, 2, 0, Math.PI*2); ctx.fill();
            }
        }

        // â”€â”€ 5. Ğ¤Ğ°ĞºĞµĞ»Ğ¸ Ğ½Ğ° ÑÑ‚Ñ–Ğ½Ğ°Ñ… â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        let torchPositions = [fx - wallW + 11, fx + fw + 11];
        let torchY = fty + fh * 0.45;
        torchPositions.forEach((tx, ti) => {
            // Ğ´ĞµÑ€Ğ¶Ğ°Ğº
            ctx.fillStyle = '#6b4c1e';
            ctx.fillRect(tx - 3, torchY, 6, 14);
            // Ğ²Ğ¾Ğ³Ğ¾Ğ½ÑŒ (Ğ°Ğ½Ñ–Ğ¼Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğ¹)
            let t = Date.now() / 200 + ti * 3.7;
            let flicker = Math.sin(t) * 3;
            let fg = ctx.createRadialGradient(tx, torchY - 4 + flicker*0.3, 1, tx, torchY, 12);
            fg.addColorStop(0,   'rgba(255,240,100,0.95)');
            fg.addColorStop(0.4, 'rgba(255,120,20,0.75)');
            fg.addColorStop(1,   'rgba(180,30,0,0)');
            ctx.fillStyle = fg;
            ctx.beginPath();
            ctx.ellipse(tx, torchY - 3 + flicker*0.2, 7 + Math.abs(flicker)*0.3, 12, 0, 0, Math.PI*2);
            ctx.fill();
            // ÑĞ²Ñ–Ñ‚Ğ»Ğ¾ Ğ½Ğ° ÑÑ‚Ñ–Ğ½Ñ–
            let lg = ctx.createRadialGradient(tx, torchY, 0, tx, torchY, 35);
            lg.addColorStop(0,   `rgba(255,160,30,0.12)`);
            lg.addColorStop(1,   `rgba(255,160,30,0)`);
            ctx.fillStyle = lg;
            ctx.beginPath(); ctx.arc(tx, torchY, 35, 0, Math.PI*2); ctx.fill();
        });

        // â”€â”€ 6. Ğ¢ÑƒĞ½ĞµĞ»ÑŒ/ÑÑ…Ğ¾Ğ´Ğ¸ Ğ¼Ñ–Ğ¶ Ğ¿Ğ¾Ğ²ĞµÑ€Ñ…Ğ°Ğ¼Ğ¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        if (this.depth >= 0) {
            let ladderTopY = (this.depth === 0) ? CFG.surfaceY : this.y - CFG.floorH;
            let ladderBotY = this.y;
            let ladX = (this.depth === 0) ? CAVE_X : (this.depth > 0 ? floors[this.depth-1].ladderX : CAVE_X);
            let tw = 28; // ÑˆĞ¸Ñ€Ğ¸Ğ½Ğ° Ñ‚ÑƒĞ½ĞµĞ»Ñ

            // Ğ¢Ñ–Ğ»Ğ¾ Ñ‚ÑƒĞ½ĞµĞ»Ñ (Ñ‚ĞµĞ¼Ğ½Ğ¸Ğ¹ Ğ¿Ñ€Ğ¾Ñ…Ñ–Ğ´)
            let tg = ctx.createLinearGradient(ladX - tw/2, 0, ladX + tw/2, 0);
            tg.addColorStop(0,   '#0a0810');
            tg.addColorStop(0.5, '#15101e');
            tg.addColorStop(1,   '#0a0810');
            ctx.fillStyle = tg;
            ctx.fillRect(ladX - tw/2, ladderTopY - camY, tw, ladderBotY - ladderTopY);

            // Ğ‘Ñ–Ñ‡Ğ½Ñ– ĞºÑ€Ğ°Ñ— Ñ‚ÑƒĞ½ĞµĞ»Ñ (ĞºĞ°Ğ¼Ñ–Ğ½ÑŒ)
            ctx.fillStyle = '#2a1e3a';
            ctx.fillRect(ladX - tw/2 - 4, ladderTopY - camY, 4, ladderBotY - ladderTopY);
            ctx.fillRect(ladX + tw/2,     ladderTopY - camY, 4, ladderBotY - ladderTopY);

            // Ğ¡Ñ…Ğ¾Ğ´Ğ¸
            ctx.fillStyle = '#4a3860';
            let stepH = 12;
            for (let ly = ladderTopY; ly < ladderBotY - stepH; ly += stepH * 1.5) {
                ctx.fillRect(ladX - tw/2 + 2, ly - camY + stepH, tw - 4, 3);
            }
        }

        // â”€â”€ 7. ĞŸĞ°ÑÑ‚ĞºĞ¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        if (this.hasTrap) {
            let ladX = this.depth > 0 ? floors[this.depth-1].ladderX : CAVE_X;
            if (this.trapType === 'spike') {
                for (let i = -3; i <= 3; i++) {
                    let sx = ladX + i * 10;
                    let sh2 = 14 + (i % 2 === 0 ? 4 : 0);
                    let spg = ctx.createLinearGradient(sx, fy, sx, fy - sh2);
                    spg.addColorStop(0, '#888'); spg.addColorStop(1, '#eee');
                    ctx.fillStyle = spg;
                    ctx.beginPath();
                    ctx.moveTo(sx - 4, fy);
                    ctx.lineTo(sx + 4, fy);
                    ctx.lineTo(sx, fy - sh2);
                    ctx.closePath(); ctx.fill();
                }
            } else if (this.trapType === 'teleport') {
                let alpha = 0.5 + 0.5 * Math.sin(Date.now() / 400);
                let rg = ctx.createRadialGradient(ladX, fy - 6, 2, ladX, fy - 6, 22);
                rg.addColorStop(0,   `rgba(120,180,255,${alpha})`);
                rg.addColorStop(0.6, `rgba(60,80,220,${alpha * 0.5})`);
                rg.addColorStop(1,   `rgba(20,0,100,0)`);
                ctx.fillStyle = rg;
                ctx.beginPath(); ctx.arc(ladX, fy - 6, 22, 0, Math.PI*2); ctx.fill();
                ctx.strokeStyle = `rgba(160,200,255,${alpha})`;
                ctx.lineWidth = 2;
                ctx.beginPath(); ctx.arc(ladX, fy - 6, 18, 0, Math.PI*2); ctx.stroke();
            } else if (this.trapType === 'daze') {
                ctx.font = '16px Arial'; ctx.textAlign = 'center';
                for (let i = -1; i <= 1; i++)
                    ctx.fillText('ğŸ’«', ladX + i * 24, fy - 4);
            }
        }

        // â”€â”€ 8. ĞŸÑ–Ğ´ÑĞ²Ñ–Ñ‡ÑƒĞ²Ğ°Ğ½Ğ½Ñ Ğ²Ğ¸Ğ±Ğ¾Ñ€Ñƒ Ğ¿Ğ°ÑÑ‚ĞºĞ¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        if (pendingTrapType !== null && !isLordFloor && !this.hasTrap) {
            let pulse = 0.12 + 0.08 * Math.sin(Date.now() / 250);
            ctx.fillStyle = `rgba(255,204,0,${pulse})`;
            ctx.fillRect(fx, fty, fw, fh);
            ctx.strokeStyle = '#ffcc00'; ctx.lineWidth = 2;
            ctx.setLineDash([6, 4]);
            ctx.strokeRect(fx, fty, fw, fh);
            ctx.setLineDash([]);
        }

        // â”€â”€ 9. ĞĞ¾Ğ¼ĞµÑ€ Ğ¿Ğ¾Ğ²ĞµÑ€Ñ…Ñƒ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        ctx.fillStyle = 'rgba(255,255,255,0.07)';
        ctx.font = 'bold 38px Arial';
        ctx.textAlign = 'center';
        ctx.fillText(this.depth + 1, centerX, fy - 28);

        // â”€â”€ 9Ğ±. Ğ¢Ğ°Ğ¹Ğ¼ĞµÑ€ ÑĞ¿Ğ°Ğ²Ğ½Ñƒ Ğ¼Ğ¾Ğ½ÑÑ‚Ñ€Ñ–Ğ² (Ğ¿Ğ¾ Ñ†ĞµĞ½Ñ‚Ñ€Ñƒ Ğ¿Ğ¾Ğ²ĞµÑ€Ñ…Ñƒ) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        if (!isLordFloor) {
            let monCount     = units.filter(u => u.type === 'monster' && u.floorIdx === this.depth).length;
            let spawnInterval = 4 + this.depth * 3;
            let cr       = isMobile ? 12 : 15;
            let timerY   = fty + cr + 6;  // Ğ±Ğ»Ğ¸Ğ·ÑŒĞºĞ¾ Ğ´Ğ¾ ÑÑ‚ĞµĞ»Ñ–, Ğ· Ğ½ĞµĞ²ĞµĞ»Ğ¸ĞºĞ¸Ğ¼ Ğ²Ñ–Ğ´ÑÑ‚ÑƒĞ¿Ğ¾Ğ¼

            if (monCount < this.maxMonsters) {
                // ĞĞºÑ‚Ğ¸Ğ²Ğ½Ğ¸Ğ¹ Ğ·Ğ²Ğ¾Ñ€Ğ¾Ñ‚Ğ½Ñ–Ğ¹ Ğ²Ñ–Ğ´Ğ»Ñ–Ğº
                let remaining = spawnInterval - this.spawnTimer;
                let progress  = this.spawnTimer / spawnInterval; // 0..1

                ctx.save();
                // Ğ—Ğ¾Ğ²Ğ½Ñ–ÑˆĞ½Ñ” ĞºÑ–Ğ»ÑŒÑ†Ğµ (Ñ„Ğ¾Ğ½)
                ctx.lineWidth = isMobile ? 2 : 3;
                ctx.strokeStyle = 'rgba(255,255,255,0.10)';
                ctx.beginPath(); ctx.arc(centerX, timerY, cr, 0, Math.PI * 2); ctx.stroke();
                // ĞšĞ¾Ğ»ÑŒĞ¾Ñ€Ğ¾Ğ²Ğ° Ğ´ÑƒĞ³Ğ° Ğ¿Ñ€Ğ¾Ğ³Ñ€ĞµÑÑƒ (Ğ²Ñ–Ğ´ 12 Ğ³Ğ¾Ğ´ Ğ·Ğ° Ğ³Ğ¾Ğ´Ğ¸Ğ½Ğ½Ğ¸ĞºĞ¾Ğ²Ğ¾Ñ)
                let startA = -Math.PI / 2;
                let endA   = startA + Math.PI * 2 * progress;
                let hue    = Math.round(120 * (1 - progress)); // Ğ·ĞµĞ»ĞµĞ½Ğ¸Ğ¹â†’Ñ‡ĞµÑ€Ğ²Ğ¾Ğ½Ğ¸Ğ¹
                ctx.strokeStyle = `hsla(${hue},90%,55%,0.85)`;
                ctx.beginPath(); ctx.arc(centerX, timerY, cr, startA, endA); ctx.stroke();
                // Ğ¦Ğ¸Ñ„Ñ€Ğ°
                ctx.fillStyle = `hsla(${hue},80%,70%,0.90)`;
                ctx.font = 'bold ' + (isMobile ? '10px' : '12px') + ' Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(remaining, centerX, timerY);
                ctx.textBaseline = 'alphabetic';
                ctx.restore();
            } else {
                // ĞŸĞ¾Ğ²ĞµÑ€Ñ… Ğ·Ğ°Ğ¿Ğ¾Ğ²Ğ½ĞµĞ½Ğ¸Ğ¹ â€” Ñ–ĞºĞ¾Ğ½ĞºĞ° Â«Ğ¿Ğ¾Ğ²Ğ½Ğ¸Ğ¹Â»
                ctx.save();
                ctx.font = (isMobile ? '11px' : '13px') + ' Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillStyle = 'rgba(255,255,255,0.30)';
                ctx.fillText('ğŸ§Ÿ', centerX, timerY);
                ctx.textBaseline = 'alphabetic';
                ctx.restore();
            }
        }

        // â”€â”€ 10. Ğ›Ñ–Ğ¼Ñ–Ñ‚ Ğ¼Ğ¾Ğ½ÑÑ‚Ñ€Ñ–Ğ² â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        if (!isLordFloor) {
            ctx.fillStyle = 'rgba(255,255,255,0.28)';
            ctx.font = '12px Arial';
            ctx.textAlign = 'left';
            ctx.fillText('ğŸ§Ÿ ' + this.maxMonsters + '/5', fx + 5, fy - 5);
        }

        // â”€â”€ 11 + 12. Ğ”Ğ²Ñ– ĞºĞ½Ğ¾Ğ¿ĞºĞ¸ Ğ³Ğ¾Ñ€Ğ¸Ğ·Ğ¾Ğ½Ñ‚Ğ°Ğ»ÑŒĞ½Ğ¾, Ñ‡ĞµÑ€Ğ³ÑƒÑÑ‚ÑŒ ÑÑ‚Ğ¾Ñ€Ğ¾Ğ½Ñƒ Ğ¿Ğ¾ Ğ³Ğ»Ğ¸Ğ±Ğ¸Ğ½Ñ– â”€
        // depth Ğ¿Ğ°Ñ€Ğ½Ğ¸Ğ¹ (0,2,4â€¦) â†’ Ğ»Ñ–Ğ²Ğ¾Ñ€ÑƒÑ‡; Ğ½ĞµĞ¿Ğ°Ñ€Ğ½Ğ¸Ğ¹ (1,3,5â€¦) â†’ Ğ¿Ñ€Ğ°Ğ²Ğ¾Ñ€ÑƒÑ‡
        if (!isLordFloor) {
            let bh  = isMobile ? 26 : 30;
            let bw  = isMobile ? 62 : 78;
            let gap = 4;
            let pad = 6;
            let byBtn = fty + pad; // Ğ²ĞµÑ€Ñ…Ğ½Ñ–Ğ¹ ĞºÑ€Ğ°Ğ¹ â€” Ğ¿Ñ–Ğ´ ÑÑ‚ĞµĞ»ĞµÑ ĞºÑ–Ğ¼Ğ½Ğ°Ñ‚Ğ¸
            let onRight = (this.depth % 2 === 1); // Ğ½ĞµĞ¿Ğ°Ñ€Ğ½Ñ– â†’ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ¹ ĞºÑƒÑ‚

            // Ğ’Ğ¸Ğ·Ğ½Ğ°Ñ‡Ğ°Ñ”Ğ¼Ğ¾ x Ğ¿ĞµÑ€ÑˆĞ¾Ñ— ĞºĞ½Ğ¾Ğ¿ĞºĞ¸ (Ğ»Ñ–Ğ²Ğ¾Ñ€ÑƒÑ‡ Ñƒ Ğ¿Ğ°Ñ€Ñ–)
            let bxFirst, bxSecond;
            if (onRight) {
                // Ğ¾Ğ±Ğ¸Ğ´Ğ²Ñ– ĞºĞ½Ğ¾Ğ¿ĞºĞ¸ Ğ¿Ñ€Ğ¸Ñ‚Ğ¸ÑĞ½ÑƒÑ‚Ñ– Ğ´Ğ¾ Ğ¿Ñ€Ğ°Ğ²Ğ¾Ñ— ÑÑ‚Ñ–Ğ½Ğ¸
                bxSecond = fx + fw - pad - bw;           // Ğ¿Ñ€Ğ°Ğ²Ğ° ĞºĞ½Ğ¾Ğ¿ĞºĞ° (ĞºÑ€Ğ°Ğ¹Ğ½Ñ Ğ¿Ñ€Ğ°Ğ²Ğ°)
                bxFirst  = bxSecond - gap - bw;          // Ğ»Ñ–Ğ²Ğ° ĞºĞ½Ğ¾Ğ¿ĞºĞ° (Ğ·Ğ»Ñ–Ğ²Ğ° Ğ²Ñ–Ğ´ Ğ¿Ñ€Ğ°Ğ²Ğ¾Ñ—)
            } else {
                // Ğ¾Ğ±Ğ¸Ğ´Ğ²Ñ– ĞºĞ½Ğ¾Ğ¿ĞºĞ¸ Ğ¿Ñ€Ğ¸Ñ‚Ğ¸ÑĞ½ÑƒÑ‚Ñ– Ğ´Ğ¾ Ğ»Ñ–Ğ²Ğ¾Ñ— ÑÑ‚Ñ–Ğ½Ğ¸
                bxFirst  = fx + pad;                     // Ğ»Ñ–Ğ²Ğ° ĞºĞ½Ğ¾Ğ¿ĞºĞ° (ĞºÑ€Ğ°Ğ¹Ğ½Ñ Ğ»Ñ–Ğ²Ğ°)
                bxSecond = bxFirst + bw + gap;           // Ğ¿Ñ€Ğ°Ğ²Ğ° ĞºĞ½Ğ¾Ğ¿ĞºĞ° (Ğ¿Ñ€Ğ°Ğ²Ğ¾Ñ€ÑƒÑ‡ Ğ²Ñ–Ğ´ Ğ»Ñ–Ğ²Ğ¾Ñ—)
            }

            // â”€â”€ "ĞĞ¿Ğ³Ñ€ĞµĞ¹Ğ´ Ğ¿Ğ¾Ğ²ĞµÑ€Ñ…Ñƒ" (Ğ¿ĞµÑ€ÑˆĞ° ĞºĞ½Ğ¾Ğ¿ĞºĞ°) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            if (this.maxMonsters < 5) {
                this._btnX = bxFirst; this._btnY = byBtn + camY; this._btnW = bw; this._btnH = bh;
                let can = GAME.souls >= this.floorUpgradeCost;
                ctx.fillStyle = can ? 'rgba(0,140,55,0.90)' : 'rgba(40,40,40,0.85)';
                ctx.beginPath(); ctx.roundRect(bxFirst, byBtn, bw, bh, 5); ctx.fill();
                ctx.strokeStyle = can ? '#00ff66' : '#444'; ctx.lineWidth = 1; ctx.stroke();
                ctx.fillStyle = can ? '#fff' : '#666';
                ctx.textAlign = 'center';
                let _fs1 = isMobile ? '8px' : '9px';
                ctx.font = 'bold ' + _fs1 + ' Arial';
                ctx.fillText('Ğ Ñ–Ğ²ĞµĞ½ÑŒ', bxFirst + bw/2, byBtn + bh/2 - (isMobile ? 2 : 2));
                ctx.font = _fs1 + ' Arial';
                ctx.fillText(this.floorUpgradeCost + ' Ğ´ÑƒÑˆ', bxFirst + bw/2, byBtn + bh/2 + (isMobile ? 8 : 9));
            } else {
                this._btnX = null;
            }

            // â”€â”€ "ĞšÑƒĞ¿Ğ¸Ñ‚Ğ¸ Ğ¼Ğ¾Ğ½ÑÑ‚Ñ€Ğ°" (Ğ´Ñ€ÑƒĞ³Ğ° ĞºĞ½Ğ¾Ğ¿ĞºĞ°) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            let count   = units.filter(u => u.type==='monster' && u.floorIdx===this.depth).length;
            let buyCost = 15 + this.depth * 5;
            let canBuy  = GAME.souls >= buyCost && count < this.maxMonsters;
            this._buyBtnX = bxSecond; this._buyBtnY = byBtn + camY; this._buyBtnW = bw; this._buyBtnH = bh;
            ctx.fillStyle = canBuy ? 'rgba(180,60,0,0.90)' : 'rgba(40,40,40,0.85)';
            ctx.beginPath(); ctx.roundRect(bxSecond, byBtn, bw, bh, 5); ctx.fill();
            ctx.strokeStyle = canBuy ? '#ff8844' : '#444'; ctx.lineWidth = 1; ctx.stroke();
            ctx.fillStyle = canBuy ? '#fff' : '#666';
            ctx.textAlign = 'center';
            let _fs2 = isMobile ? '8px' : '9px';
            ctx.font = 'bold ' + _fs2 + ' Arial';
            ctx.fillText('ĞœĞ¾Ğ½ÑÑ‚Ñ€', bxSecond + bw/2, byBtn + bh/2 - (isMobile ? 2 : 2));
            ctx.font = _fs2 + ' Arial';
            ctx.fillText(buyCost + ' Ğ´ÑƒÑˆ', bxSecond + bw/2, byBtn + bh/2 + (isMobile ? 8 : 9));
        } else {
            this._btnX    = null;
            this._buyBtnX = null;
        }
    }
}

// =================== ĞšĞ›ĞĞ¡ Ğ®ĞĞ†Ğ¢ ===================
class Unit {
    constructor(type, x, y, floorIdx, level) {
        this.type = type;
        this.x = x; this.y = y;
        this.floorIdx = floorIdx;
        this.level = level || 1;
        this.heroRank = 'normal';

        if (type === 'monster') {
            let n = this.level - 1;

            // â”€â”€ Ğ’Ğ¸Ğ·Ğ½Ğ°Ñ‡Ğ°Ñ”Ğ¼Ğ¾ Ğ²Ğ¸Ğ´ Ğ¼Ğ¾Ğ½ÑÑ‚Ñ€Ğ° Ğ·Ğ° Ñ€Ñ–Ğ²Ğ½ĞµĞ¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            // armor: Dota-formula â†’ ĞµÑ„ĞµĞºÑ‚Ğ¸Ğ²Ğ½Ğµ Ğ·Ğ½Ğ¸Ğ¶ĞµĞ½Ğ½Ñ = armor*0.06/(1+armor*0.06)
            // ability: ĞºĞ»ÑÑ‡ Ğ¿Ğ°ÑĞ¸Ğ²Ğ½Ğ¾Ñ—/Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾Ñ— Ğ·Ğ´Ñ–Ğ±Ğ½Ğ¾ÑÑ‚Ñ–
            const MONSTER_KINDS = {
                1:  { name:'slime',       color:'#44dd44', baseAtk:5,  baseSpd:0.7,  hpMult:1.0,  armor:0,  ability:'atk_slow'    },
                2:  { name:'skeleton',    color:'#d4c89a', baseAtk:7,  baseSpd:1.0,  hpMult:0.85, armor:2,  ability:'rebirth'     },
                3:  { name:'hounds',      color:'#c87040', baseAtk:6,  baseSpd:1.3,  hpMult:0.75, armor:1,  ability:'bleed'       },
                4:  { name:'zombie',      color:'#5a8c3a', baseAtk:9,  baseSpd:0.55, hpMult:1.5,  armor:3,  ability:'infect'      },
                5:  { name:'spirit',      color:'#aabbff', baseAtk:7,  baseSpd:1.1,  hpMult:0.9,  armor:2,  ability:'scare'       },
                6:  { name:'bat',         color:'#553366', baseAtk:6,  baseSpd:1.4,  hpMult:0.65, armor:0,  ability:'dodge'       },
                7:  { name:'golem',       color:'#887766', baseAtk:12, baseSpd:0.5,  hpMult:2.0,  armor:8,  ability:'stun'        },
                8:  { name:'minotaur',    color:'#885522', baseAtk:10, baseSpd:0.7,  hpMult:1.6,  armor:5,  ability:'aoe4th'      },
                9:  { name:'shadow',      color:'#334455', baseAtk:9,  baseSpd:1.2,  hpMult:1.0,  armor:4,  ability:'invis'       },
                10: { name:'necromancer', color:'#6622aa', baseAtk:8,  baseSpd:0.8,  hpMult:1.1,  armor:3,  ability:'raise_dead'  },
                11: { name:'water_ele',   color:'#4488ff', baseAtk:9,  baseSpd:0.9,  hpMult:1.2,  armor:4,  ability:'absorb'      },
                12: { name:'earth_ele',   color:'#887733', baseAtk:11, baseSpd:0.6,  hpMult:1.8,  armor:9,  ability:'knockback'   },
                13: { name:'air_ele',     color:'#ccddff', baseAtk:8,  baseSpd:1.5,  hpMult:0.8,  armor:2,  ability:'no_die'      },
                14: { name:'fire_ele',    color:'#ff5500', baseAtk:10, baseSpd:0.85, hpMult:1.3,  armor:4,  ability:'explode'     },
                15: { name:'lightning',   color:'#ffee44', baseAtk:10, baseSpd:1.1,  hpMult:1.0,  armor:3,  ability:'chain'       },
                16: { name:'dark_knight', color:'#223355', baseAtk:13, baseSpd:0.75, hpMult:1.4,  armor:10, ability:'reflect'     },
                17: { name:'banshee',     color:'#88aacc', baseAtk:9,  baseSpd:1.0,  hpMult:1.1,  armor:4,  ability:'scream'      },
                18: { name:'lich',        color:'#aa44cc', baseAtk:12, baseSpd:0.9,  hpMult:1.2,  armor:5,  ability:'armor_pierce'},
                19: { name:'abyss',       color:'#110022', baseAtk:14, baseSpd:0.8,  hpMult:1.5,  armor:7,  ability:'absorb_hero' },
                20: { name:'dragon',      color:'#cc2200', baseAtk:18, baseSpd:0.7,  hpMult:2.5,  armor:12, ability:'breath'      },
            };
            let kind = MONSTER_KINDS[this.level] || MONSTER_KINDS[20];
            this.monsterKind  = kind.name;
            this.ability      = kind.ability || 'none';
            this.armor        = (kind.armor || 0) + GAME.monsterArmorBonus;

            // â”€â”€ HP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            this.hp = (80 + n * 20 + GAME.monsterHpBonus) * kind.hpMult;

            // â”€â”€ DMG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            let scaledAtk = kind.baseAtk + (n < 5 ? n * 1 : 4 + (n - 4) * 2);
            let dmgVariance = 0.75 + Math.random() * 0.5;
            this.baseDmg = scaledAtk + GAME.monsterDmgBonus;
            this.dmg = Math.round(this.baseDmg * dmgVariance);

            // â”€â”€ Ğ¨Ğ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            this.baseAtkSpeed = kind.baseSpd;
            this.atkSpeedBonus = GAME.monsterAtkSpeedBonus;
            let mSpeedMult = 0.9 + Math.random() * 0.2;
            this.speed = 1 * mSpeedMult;
            this.color = kind.color;
            this.size  = 25;

            // â”€â”€ ĞŸĞ¾Ğ»Ñ Ğ´Ğ»Ñ Ğ·Ğ´Ñ–Ğ±Ğ½Ğ¾ÑÑ‚ĞµĞ¹ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            if (this.ability === 'atk_slow')   { this.atkSlowStacks = 0; }
            if (this.ability === 'rebirth')     { this.rebirthUsed = false; }
            if (this.ability === 'bleed')       { /* on-hit */ }
            if (this.ability === 'invis')       { this.invisCooldown = 360; this.invisTimer = 0; this.invisActive = false; }
            if (this.ability === 'aoe4th')      { this.aoeHitCount = 0; }
            if (this.ability === 'raise_dead')  { /* on-kill */ }
            if (this.ability === 'absorb')      { this.absorbShield = this.hp * 0.2; }
            if (this.ability === 'knockback')   { /* on-hit */ }
            if (this.ability === 'no_die')      { this.noDieUsed = false; }
            if (this.ability === 'explode')     { /* on-death */ }
            if (this.ability === 'chain')       { /* on-hit */ }
            if (this.ability === 'reflect')     { /* on-hit */ }
            if (this.ability === 'scream')      { this.screamCooldown = 480; }
            if (this.ability === 'absorb_hero') { this.absorbCooldown = 600; this.absorbedHero = null; this.absorbTimer = 0; }
            if (this.ability === 'breath')      { this.breathCooldown = 480; }
        } else if (type === 'hero') {
            let n = this.level - 1;
            let scale = 1 + GAME.heroScalePercent / 100;

            // â”€â”€ Ğ¢Ğ¸Ğ¿Ğ¸ Ğ³ĞµÑ€Ğ¾Ñ—Ğ² Ğ·Ğ° Ñ€Ñ–Ğ²Ğ½ĞµĞ¼ (10 Ñ‚Ğ¸Ğ¿Ñ–Ğ² Ã— 2 Ñ€Ñ–Ğ²Ğ½Ñ– = 20 Ñ€Ñ–Ğ²Ğ½Ñ–Ğ²) â”€â”€â”€â”€
            // Tier II: ÑƒÑĞ¿Ğ°Ğ´ĞºĞ¾Ğ²ÑƒÑ” + Ğ¿Ğ¾ÑĞ¸Ğ»ÑÑ” Ğ¿Ğ°ÑĞ¸Ğ² Tier I
            const HERO_TYPES = {
                1:  { name:'recruit',     label:'Ğ ĞµĞºÑ€ÑƒÑ‚ I',       cloak:'#551122', body:'#cc2233', helmet:'#555566', weapon:'sword',  passive:'none'       }, // Ğ±ĞµĞ· Ğ¿Ğ°ÑĞ¸Ğ²Ñƒ
                2:  { name:'recruit2',    label:'Ğ ĞµĞºÑ€ÑƒÑ‚ II',      cloak:'#661122', body:'#dd2233', helmet:'#6a6a7a', weapon:'sword',  passive:'hardened'   }, // +3 Ğ±Ñ€Ğ¾Ğ½Ñ–
                3:  { name:'soldier',     label:'Ğ¡Ğ¾Ğ»Ğ´Ğ°Ñ‚ I',       cloak:'#772200', body:'#cc4400', helmet:'#778899', weapon:'sword',  passive:'toughness'  }, // +6 Ğ±Ñ€Ğ¾Ğ½Ñ–
                4:  { name:'soldier2',    label:'Ğ¡Ğ¾Ğ»Ğ´Ğ°Ñ‚ II',      cloak:'#883300', body:'#dd5500', helmet:'#99aabb', weapon:'spear',  passive:'veteran'    }, // +8 Ğ±Ñ€Ğ¾Ğ½Ñ– + Ñ€ĞµĞ³ĞµĞ½ 1
                5:  { name:'scout',       label:'Ğ Ğ¾Ğ·Ğ²Ñ–Ğ´Ğ½Ğ¸Ğº I',    cloak:'#224400', body:'#448822', helmet:'#556655', weapon:'spear',  passive:'swift'      }, // ÑˆĞ²Ğ¸Ğ´ĞºÑ–ÑÑ‚ÑŒ Ã—1.5
                6:  { name:'scout2',      label:'Ğ Ğ¾Ğ·Ğ²Ñ–Ğ´Ğ½Ğ¸Ğº II',   cloak:'#336600', body:'#559933', helmet:'#66aa55', weapon:'dagger', passive:'hunter'     }, // Ã—1.5 ÑˆĞ²Ğ¸Ğ´Ğº + Ğ¿ĞµÑ€ÑˆĞ¸Ğ¹ ÑƒĞ´Ğ°Ñ€ Ã—2
                7:  { name:'knight',      label:'Ğ›Ğ¸Ñ†Ğ°Ñ€ I',        cloak:'#334455', body:'#446688', helmet:'#99aabb', weapon:'spear',  passive:'armor'      }, // +12 Ğ±Ñ€Ğ¾Ğ½Ñ–
                8:  { name:'knight2',     label:'Ğ›Ğ¸Ñ†Ğ°Ñ€ II',       cloak:'#445566', body:'#557799', helmet:'#aabbcc', weapon:'spear',  passive:'guardian'   }, // +12 Ğ±Ñ€Ğ¾Ğ½Ñ– + Ñ€ĞµĞ³ĞµĞ½ 1.5
                9:  { name:'mage',        label:'ĞœĞ°Ğ³ I',          cloak:'#330066', body:'#6600cc', helmet:'#aa66ff', weapon:'staff',  passive:'spellburn'  }, // +25% dmg
                10: { name:'mage2',       label:'ĞœĞ°Ğ³ II',         cloak:'#440077', body:'#7711dd', helmet:'#cc88ff', weapon:'staff',  passive:'arcane'     }, // +35% dmg + Ğ¿Ñ€Ğ¾Ğ±Ğ¸Ğ²Ğ°Ñ” Ğ±Ñ€Ğ¾Ğ½Ñ
                11: { name:'paladin',     label:'ĞŸĞ°Ğ»Ğ°Ğ´Ñ–Ğ½ I',      cloak:'#553300', body:'#bb6600', helmet:'#ddbb44', weapon:'spear',  passive:'holyaura'   }, // Ñ€ĞµĞ³ĞµĞ½ 2 + Ğ±Ñ€Ğ¾Ğ½Ñ 4
                12: { name:'paladin2',    label:'ĞŸĞ°Ğ»Ğ°Ğ´Ñ–Ğ½ II',     cloak:'#664400', body:'#cc7700', helmet:'#eeccaa', weapon:'spear',  passive:'divine'     }, // Ñ€ĞµĞ³ĞµĞ½ 3 + Ğ±Ñ€Ğ¾Ğ½Ñ 6
                13: { name:'berserker',   label:'Ğ‘ĞµÑ€ÑĞµÑ€Ğº I',      cloak:'#440000', body:'#aa0000', helmet:'#882222', weapon:'axe',    passive:'rage'       }, // ĞºÑ€Ğ¸Ñ‚ 20% Ã—2, ÑˆĞ²Ğ¸Ğ´Ğº 1.3
                14: { name:'berserker2',  label:'Ğ‘ĞµÑ€ÑĞµÑ€Ğº II',     cloak:'#660000', body:'#cc0000', helmet:'#aa3333', weapon:'axe',    passive:'fury'       }, // ĞºÑ€Ğ¸Ñ‚ 25% Ã—2, ÑˆĞ²Ğ¸Ğ´Ğº 1.4
                15: { name:'assassin',    label:'ĞÑĞ°ÑÑ–Ğ½ I',       cloak:'#111111', body:'#333344', helmet:'#224433', weapon:'dagger', passive:'firstblood' }, // Ğ¿ĞµÑ€ÑˆĞ¸Ğ¹ ÑƒĞ´Ğ°Ñ€ Ã—2, ÑˆĞ²Ğ¸Ğ´Ğº 1.4
                16: { name:'assassin2',   label:'ĞÑĞ°ÑÑ–Ğ½ II',      cloak:'#222222', body:'#444455', helmet:'#335544', weapon:'dagger', passive:'shadowstrike'}, // Ğ¿ĞµÑ€ÑˆĞ¸Ğ¹ ÑƒĞ´Ğ°Ñ€ Ã—2 + Ğ¿Ñ€Ğ¾Ğ±Ğ¸Ğ²Ğ°Ñ” Ğ±Ñ€Ğ¾Ğ½Ñ
                17: { name:'warlord',     label:'Ğ’Ğ¾Ñ”Ğ½Ğ°Ñ‡Ğ°Ğ»ÑŒĞ½Ğ¸Ğº I', cloak:'#552200', body:'#884400', helmet:'#ccaa66', weapon:'sword',  passive:'warcry'     }, // ÑĞ¾ÑĞ·Ğ½Ğ¸ĞºĞ¸ +10% dmg
                18: { name:'warlord2',    label:'Ğ’Ğ¾Ñ”Ğ½Ğ°Ñ‡Ğ°Ğ»ÑŒĞ½Ğ¸Ğº II',cloak:'#663300', body:'#995500', helmet:'#ddbb77', weapon:'sword',  passive:'warcry2'    }, // ÑĞ¾ÑĞ·Ğ½Ğ¸ĞºĞ¸ +10% dmg + ĞºÑ€Ğ¸Ñ‚ 15%
                19: { name:'champion',    label:'Ğ§ĞµĞ¼Ğ¿Ñ–Ğ¾Ğ½ I',      cloak:'#550055', body:'#aa00aa', helmet:'#ff88ff', weapon:'staff',  passive:'unstoppable'}, // +25% dmg + Ğ¿Ñ€Ğ¾Ğ±Ğ¸Ğ²Ğ°Ñ” Ğ±Ñ€Ğ¾Ğ½Ñ
                20: { name:'champion2',   label:'Ğ§ĞµĞ¼Ğ¿Ñ–Ğ¾Ğ½ II',     cloak:'#660066', body:'#bb00bb', helmet:'#ffaaff', weapon:'staff',  passive:'conqueror'  }, // +25% dmg + Ğ¿Ñ€Ğ¾Ğ±Ğ¸Ğ²Ğ°Ñ” Ğ±Ñ€Ğ¾Ğ½Ñ + ĞºÑ€Ğ¸Ñ‚ 20%
            };
            let htype = HERO_TYPES[Math.min(this.level, 20)] || HERO_TYPES[20];
            this.heroType    = htype.name;
            this.heroLabel   = htype.label;
            this.heroPassive = htype.passive;
            this.heroCloakCol  = htype.cloak;
            this.heroBodyCol   = htype.body;
            this.heroHelmetCol = htype.helmet;
            this.heroWeapon    = htype.weapon;

            // â”€â”€ Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ Ğ³ĞµÑ€Ğ¾Ñ—Ğ² â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            let monHp  = 90 + n * 22;
            let monDmg = (n < 5) ? 6 + n : 6 + 4 + (n - 4) * 2;
            this.hp   = monHp  * scale;
            this.dmg  = monDmg * scale;

            // â”€â”€ Ğ‘Ğ°Ğ·Ğ¾Ğ²Ğ° Ğ±Ñ€Ğ¾Ğ½Ñ Ğ¿Ğ¾ Ñ‚Ğ¸Ğ¿Ñƒ (Ğ´Ğ¾ Ğ¿Ğ°ÑĞ¸Ğ²Ğ½Ğ¸Ñ… Ğ±Ğ¾Ğ½ÑƒÑÑ–Ğ²) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            const HERO_ARMOR = {
                recruit:0, recruit2:0,
                soldier:0, soldier2:0,
                scout:1,   scout2:1,
                knight:0,  knight2:0,
                mage:0,    mage2:0,
                paladin:0, paladin2:0,
                berserker:2, berserker2:2,
                assassin:1,  assassin2:1,
                warlord:4,   warlord2:4,
                champion:3,  champion2:3,
            };
            this.armor = HERO_ARMOR[htype.name] || 0;

            // â”€â”€ ĞŸĞ°ÑĞ¸Ğ²Ğ½Ñ– Ğ¼Ğ¾Ğ´Ğ¸Ñ„Ñ–ĞºĞ°Ñ‚Ğ¾Ñ€Ğ¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            if (htype.passive === 'hardened')     this.armor += 3;                                    // Ğ ĞµĞºÑ€ÑƒÑ‚ II: +3 Ğ±Ñ€Ğ¾Ğ½Ñ–
            if (htype.passive === 'toughness')    this.armor += 6;                                    // Ğ¡Ğ¾Ğ»Ğ´Ğ°Ñ‚ I: +6 Ğ±Ñ€Ğ¾Ğ½Ñ–
            if (htype.passive === 'veteran')    { this.armor += 8;  this.regen = 1; }                 // Ğ¡Ğ¾Ğ»Ğ´Ğ°Ñ‚ II: +8 Ğ±Ñ€Ğ¾Ğ½Ñ– + Ñ€ĞµĞ³ĞµĞ½ 1
            if (htype.passive === 'swift')        this.speed = 1.5;                                   // Ğ Ğ¾Ğ·Ğ²Ñ–Ğ´Ğ½Ğ¸Ğº I: ÑˆĞ²Ğ¸Ğ´Ğº Ã—1.5
            if (htype.passive === 'hunter')     { this.speed = 1.5; this.firstBlood = true; }         // Ğ Ğ¾Ğ·Ğ²Ñ–Ğ´Ğ½Ğ¸Ğº II: + Ğ¿ĞµÑ€ÑˆĞ¸Ğ¹ ÑƒĞ´Ğ°Ñ€ Ã—2
            if (htype.passive === 'armor')        this.armor += 12;                                   // Ğ›Ğ¸Ñ†Ğ°Ñ€ I: +12 Ğ±Ñ€Ğ¾Ğ½Ñ–
            if (htype.passive === 'guardian')   { this.armor += 12; this.regen = 1.5; }               // Ğ›Ğ¸Ñ†Ğ°Ñ€ II: +12 Ğ±Ñ€Ğ¾Ğ½Ñ– + Ñ€ĞµĞ³ĞµĞ½ 1.5
            if (htype.passive === 'spellburn')    this.dmg *= 1.25;                                   // ĞœĞ°Ğ³ I: +25% dmg
            if (htype.passive === 'arcane')     { this.dmg *= 1.35; this.armorPierce = true; }        // ĞœĞ°Ğ³ II: +35% dmg + Ğ¿Ñ€Ğ¾Ğ±Ğ¸Ğ²Ğ°Ñ” Ğ±Ñ€Ğ¾Ğ½Ñ
            if (htype.passive === 'holyaura')   { this.armor += 4;  this.regen = 2; }                 // ĞŸĞ°Ğ»Ğ°Ğ´Ñ–Ğ½ I: Ğ±Ñ€Ğ¾Ğ½Ñ 4 + Ñ€ĞµĞ³ĞµĞ½ 2
            if (htype.passive === 'divine')     { this.armor += 6;  this.regen = 3; }                 // ĞŸĞ°Ğ»Ğ°Ğ´Ñ–Ğ½ II: Ğ±Ñ€Ğ¾Ğ½Ñ 6 + Ñ€ĞµĞ³ĞµĞ½ 3
            if (htype.passive === 'rage')       { this.critChance = 0.20; this.speed = 1.3; }         // Ğ‘ĞµÑ€ÑĞµÑ€Ğº I: ĞºÑ€Ğ¸Ñ‚ 20% + ÑˆĞ²Ğ¸Ğ´Ğº 1.3
            if (htype.passive === 'fury')       { this.critChance = 0.25; this.speed = 1.4; }         // Ğ‘ĞµÑ€ÑĞµÑ€Ğº II: ĞºÑ€Ğ¸Ñ‚ 25% + ÑˆĞ²Ğ¸Ğ´Ğº 1.4
            if (htype.passive === 'firstblood') { this.firstBlood = true; this.speed = 1.4; }         // ĞÑĞ°ÑÑ–Ğ½ I: Ğ¿ĞµÑ€ÑˆĞ¸Ğ¹ ÑƒĞ´Ğ°Ñ€ Ã—2 + ÑˆĞ²Ğ¸Ğ´Ğº 1.4
            if (htype.passive === 'shadowstrike'){ this.firstBlood = true; this.speed = 1.4; this.armorPierce = true; } // ĞÑĞ°ÑÑ–Ğ½ II: + Ğ¿Ñ€Ğ¾Ğ±Ğ¸Ğ²Ğ°Ñ” Ğ±Ñ€Ğ¾Ğ½Ñ
            if (htype.passive === 'warcry2')    { this.heroPassive = 'warcry'; this.critChance = 0.15; } // Ğ’Ğ¾Ñ”Ğ½Ğ°Ñ‡Ğ°Ğ»ÑŒĞ½Ğ¸Ğº II: Ğ°ÑƒÑ€Ğ° + ĞºÑ€Ğ¸Ñ‚ 15%
            if (htype.passive === 'unstoppable'){ this.dmg *= 1.25; this.armorPierce = true; }        // Ğ§ĞµĞ¼Ğ¿Ñ–Ğ¾Ğ½ I: +25% dmg + Ğ¿Ñ€Ğ¾Ğ±Ğ¸Ğ²Ğ°Ñ” Ğ±Ñ€Ğ¾Ğ½Ñ
            if (htype.passive === 'conqueror')  { this.dmg *= 1.25; this.armorPierce = true; this.critChance = 0.20; } // Ğ§ĞµĞ¼Ğ¿Ñ–Ğ¾Ğ½ II: + ĞºÑ€Ğ¸Ñ‚ 20%

            // Ğ±Ğ°Ğ·Ğ¾Ğ²Ğ° Ğ¨Ğ Ğ³ĞµÑ€Ğ¾Ñ = 0.83 Ğ°Ñ‚Ğº/ÑĞµĞº
            this.baseAtkSpeed = 0.83;
            this.atkSpeedBonus = 0;
            // Ğ ÑƒĞ»ĞµÑ‚ĞºĞ° ÑˆĞ²Ğ¸Ğ´ĞºĞ¾ÑÑ‚Ñ– Â±10% (Ñ„Ñ–ĞºÑĞ¾Ğ²Ğ°Ğ½Ğ° Ğ¿Ñ€Ğ¸ ÑĞ¿Ğ°Ğ²Ğ½Ñ–)
            let hSpeedMult = 0.9 + Math.random() * 0.2; // 0.9 .. 1.1
            if (!this.speed) this.speed = 1.2 * hSpeedMult;
            else this.speed *= hSpeedMult; // swift Ğ²Ğ¶Ğµ Ğ²Ğ¸ÑÑ‚Ğ°Ğ²Ğ¸Ğ² speed=1.5
            this.color = '#ff3333';
            this.size  = 20;
        } else if (type === 'lord') {
            this.hp   = GAME.maxLordHP;
            this.dmg  = GAME.lordDmg;
            this.baseAtkSpeed = GAME.lordBaseAtkSpeed;
            this.atkSpeedBonus = GAME.lordAtkSpeedBonus;
            this.armor = GAME.lordArmor;
            this.speed = 0;
            this.color = '#aa00ff';
            this.size  = 40;
            this.level = 0;
        }

        this.maxHp = this.hp;
        this.state = 'idle';
        this.fightTarget = null;
        this.attackCooldown = 0;
    }

    update() {
        if (GAME.gameOver) return;

        // Ğ ĞµĞ³ĞµĞ½ Ğ¿Ğ°Ğ»Ğ°Ğ´Ñ–Ğ½Ğ° Ñ– Ğ»Ğ¾Ñ€Ğ´Ğ°
        if (this.regen > 0 && this.hp < this.maxHp)
            this.hp = Math.min(this.hp + this.regen / 60, this.maxHp);
        // Ğ ĞµĞ³ĞµĞ½ Ğ»Ğ¾Ñ€Ğ´Ğ° (% Ğ²Ñ–Ğ´ Ğ¼Ğ°ĞºÑ HP)
        if (this.type === 'lord' && GAME.lordRegenPct > 0 && this.hp > 0 && this.hp < this.maxHp)
            this.hp = Math.min(this.hp + GAME.lordRegenPct * this.maxHp / 60, this.maxHp);

        // â”€â”€ ĞŸĞ°ÑĞ¸Ğ² WARCRY (Ğ’Ğ¾Ñ”Ğ½Ğ°Ñ‡Ğ°Ğ»ÑŒĞ½Ğ¸Ğº): ÑÑƒÑÑ–Ğ´Ğ¸-Ğ³ĞµÑ€Ğ¾Ñ— +10% dmg â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        if (this.type === 'hero' && this.heroPassive === 'warcry') {
            units.forEach(u => {
                if (u === this || u.type !== 'hero' || u.floorIdx !== this.floorIdx) return;
                if (Math.abs(u.x - this.x) < 80 && !u._warcryBuff) {
                    u._warcryBuff = true;
                    u._warcryDmg = u.dmg;
                    u.dmg *= 1.10;
                }
            });
        }
        // Ğ¡ĞºĞ¸Ğ´Ğ°Ñ”Ğ¼Ğ¾ warcry buff ÑĞºÑ‰Ğ¾ Ğ²Ğ¾Ñ”Ğ½Ğ°Ñ‡Ğ°Ğ»ÑŒĞ½Ğ¸ĞºĞ° Ğ²Ğ¶Ğµ Ğ½ĞµĞ¼Ğ°Ñ”
        if (this.type === 'hero' && this._warcryBuff) {
            let warlord = units.find(u => u.type === 'hero' && u.heroPassive === 'warcry'
                && u.floorIdx === this.floorIdx && Math.abs(u.x - this.x) < 80 && u.hp > 0);
            if (!warlord) {
                this.dmg = this._warcryDmg || this.dmg;
                this._warcryBuff = false;
            }
        }

        // â”€â”€ ĞŸĞ°ÑĞ¸Ğ²Ğ½Ñ– Ğ·Ğ´Ñ–Ğ±Ğ½Ğ¾ÑÑ‚Ñ– Ğ¼Ğ¾Ğ½ÑÑ‚Ñ€Ñ–Ğ² â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        if (this.type === 'monster') {

            // SHADOW: ĞºĞ¾Ğ¶Ğ½Ñ– 6 ÑĞµĞº Ğ½ĞµĞ¿Ñ€Ğ¾Ğ½Ğ¸ĞºĞ½Ğ¸Ğ¹ 1 ÑĞµĞº
            if (this.ability === 'invis') {
                if (this.invisTimer > 0) { this.invisTimer--; }
                else if (this.invisActive) { this.invisActive = false; this.invisCooldown = 360; }
                if (!this.invisActive) {
                    if (this.invisCooldown > 0) this.invisCooldown--;
                    else { this.invisActive = true; this.invisTimer = 60; }
                }
            }

            // BANSHEE: ĞºĞ¾Ğ¶Ğ½Ñ– 8 ÑĞµĞº ĞºÑ€Ğ¸Ğº â€” Ğ¾Ğ´Ğ¸Ğ½ Ğ· 4 ĞµÑ„ĞµĞºÑ‚Ñ–Ğ² Ñƒ Ñ€Ğ°Ğ´Ñ–ÑƒÑÑ–
            if (this.ability === 'scream') {
                if (this.screamCooldown > 0) { this.screamCooldown--; }
                else {
                    this.screamCooldown = 480;
                    let fx = centerX - CFG.floorW/2; let fw = CFG.floorW;
                    let half = fw / 2;
                    let heroesNear = units.filter(u => u.type==='hero' && u.floorIdx===this.floorIdx
                        && Math.abs(u.x - this.x) < half && u.hp > 0);
                    if (heroesNear.length > 0) {
                        let effect = Math.floor(Math.random() * 4);
                        heroesNear.forEach(h => {
                            if (effect === 0) { h.hp -= h.maxHp * 0.08; spawnParticle(h.x, h.y-h.size, 'red'); }
                            else if (effect === 1) { h._stunTimer = (h._stunTimer||0) + 90; spawnParticle(h.x, h.y-h.size, 'cyan'); }
                            else if (effect === 2) { h._atkSlowMult = Math.max(0.4, (h._atkSlowMult||1) - 0.3); spawnParticle(h.x, h.y-h.size, 'blue'); }
                            else { h.speed = Math.max(0.4, (h.speed||1) * 0.5); h._screamSlow = true; spawnParticle(h.x, h.y-h.size, 'purple'); }
                        });
                    }
                }
            }

            // DRAGON: ĞºĞ¾Ğ¶Ğ½Ñ– 8 ÑĞµĞº â€” 3 ÑƒĞ´Ğ°Ñ€Ğ¸ Ğ¿Ğ¾ Ğ²ÑÑ–Ñ… Ğ³ĞµÑ€Ğ¾ÑÑ… Ğ·Ğ° 1 ÑĞµĞº
            if (this.ability === 'breath') {
                if (this.breathCooldown > 0) { this.breathCooldown--; }
                else {
                    this.breathCooldown = 480;
                    let allHeroes = units.filter(u => u.type==='hero' && u.floorIdx===this.floorIdx && u.hp>0);
                    if (allHeroes.length > 0) {
                        for (let wave=0; wave<3; wave++) {
                            setTimeout(() => {
                                allHeroes.forEach(h => {
                                    if (h.hp <= 0) return;
                                    let raw = this.dmg * 0.8;
                                    let dmgAfterArmor = applyArmor(raw, h.armor || 0, h.armorPierce);
                                    h.hp -= dmgAfterArmor;
                                    spawnParticle(h.x, h.y-h.size, 'orange');
                                });
                            }, wave * 333);
                        }
                    }
                }
            }

            // ABYSS: ĞºĞ¾Ğ¶Ğ½Ñ– 10 ÑĞµĞº â€” Ğ¿Ğ¾Ğ³Ğ»Ğ¸Ğ½Ğ°Ñ” Ğ¾Ğ´Ğ½Ğ¾Ğ³Ğ¾ Ğ³ĞµÑ€Ğ¾Ñ Ğ½Ğ° 3 ÑĞµĞº
            if (this.ability === 'absorb_hero') {
                if (this.absorbedHero) {
                    this.absorbTimer--;
                    if (this.absorbTimer <= 0) {
                        // ĞŸĞ¾Ğ²ĞµÑ€Ñ‚Ğ°Ñ”Ğ¼Ğ¾ Ğ³ĞµÑ€Ğ¾Ñ
                        let h = this.absorbedHero;
                        h._absorbedBy = null; h.hp = Math.min(h.hp, h.maxHp);
                        this.absorbedHero = null; this.absorbCooldown = 600;
                        // Ğ—Ğ½Ñ–Ğ¼Ğ°Ñ”Ğ¼Ğ¾ ÑÑ‚Ğ°Ñ‚-Ğ±ÑƒÑ„Ğ¸
                        this.dmg  = (this.dmg  - (this._absorbDmg||0));
                        this.maxHp= (this.maxHp - (this._absorbHp||0));
                        this._absorbDmg = 0; this._absorbHp = 0;
                    }
                } else if (this.absorbCooldown > 0) { this.absorbCooldown--; }
                else {
                    let target = units.find(u => u.type==='hero' && u.floorIdx===this.floorIdx && u.hp>0 && !u._absorbedBy);
                    if (target) {
                        this.absorbedHero = target; this.absorbTimer = 180;
                        target._absorbedBy = this;
                        // ĞÑ‚Ñ€Ğ¸Ğ¼ÑƒÑ”Ğ¼Ğ¾ 50% ÑÑ‚Ğ°Ñ‚Ñ–Ğ² Ğ³ĞµÑ€Ğ¾Ñ
                        let bonDmg = target.dmg * 0.5; let bonHp = target.maxHp * 0.5;
                        this._absorbDmg = bonDmg; this._absorbHp = bonHp;
                        this.dmg += bonDmg; this.maxHp += bonHp; this.hp += bonHp;
                        spawnParticle(this.x, this.y-this.size, 'purple');
                    }
                }
            }

            // ĞšÑƒĞ»Ğ´Ğ°ÑƒĞ½Ğ¸ Ğ´Ğ»Ñ Ğ³ĞµÑ€Ğ¾Ñ—Ğ²: stunTimer
            units.forEach(u => {
                if (u.type !== 'hero') return;
                if ((u._stunTimer||0) > 0) u._stunTimer--;
            });
        }

        // ĞšÑƒĞ»Ğ´Ğ°ÑƒĞ½ hero stun
        if (this.type === 'hero' && (this._stunTimer||0) > 0) {
            this._stunTimer--;
            return; // Ğ—Ğ°Ğ¼Ğ¾Ñ€Ğ¾Ğ¶ĞµĞ½Ñ– â€” Ğ½Ğµ Ñ€ÑƒÑ…Ğ°ÑÑ‚ÑŒÑÑ Ñ– Ğ½Ğµ Ğ°Ñ‚Ğ°ĞºÑƒÑÑ‚ÑŒ
        }

        // Ğ“ĞµÑ€Ğ¾Ğ¹ Ğ¿Ñ–Ğ´ Ğ´Ñ–Ñ”Ñ Ğ¿ĞµÑ€ĞµĞ»ÑĞºÑƒ (Ğ”ÑƒÑ…) â€” Ğ±Ñ–Ğ¶Ğ¸Ñ‚ÑŒ Ğ´Ğ¾ Ğ¼Ñ–ÑÑ‚Ğ° 2 ÑĞµĞº
        if (this.type === 'hero' && (this._scareTimer || 0) > 0) {
            this._scareTimer--;
            this.color = '#88ccff'; // ÑĞ¸Ğ½ÑĞ²Ğ°Ñ‚Ğ¸Ğ¹ Ğ²Ñ–Ğ´Ñ‚Ñ–Ğ½Ğ¾Ğº Ğ¿Ğ¾ĞºĞ¸ Ğ¿ĞµÑ€ĞµĞ»ÑĞºĞ°Ğ½Ğ¾
            if (this._scareTimer <= 0) {
                this.waveActive = false;
                this.color = '#ff3333'; // Ğ²Ñ–Ğ´Ğ½Ğ¾Ğ²Ğ¸Ñ‚Ğ¸ Ğ½Ğ¾Ñ€Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¸Ğ¹ ĞºĞ¾Ğ»Ñ–Ñ€
            } else {
                this.moveFeared();
                return;
            }
        }

        // Ğ“ĞµÑ€Ğ¾Ğ¹ Ğ¿Ñ–Ğ´ Ğ´Ñ–Ñ”Ñ Ğ·Ğ°Ğ¿Ğ°Ğ¼Ğ¾Ñ€Ğ¾Ñ‡ĞµĞ½Ğ½Ñ
        if (this.dazeMode) { this.moveMonster(); return; }

        // â”€â”€ Ğ Ğ°Ğ´Ñ–ÑƒÑ Ğ°Ñ‚Ğ°ĞºĞ¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        let enemyTypes = (this.type === 'hero') ? ['monster','lord'] : ['hero'];
        let range = this.type === 'lord' ? 60 : 38;

        // ĞŸÑ€Ğ¾Ğ¿ÑƒÑĞºĞ°Ñ”Ğ¼Ğ¾ Ğ½ĞµĞ¿Ñ€Ğ¾Ğ½Ğ¸ĞºĞ½Ğ¸Ñ… Ñ– Ğ¿Ğ¾Ğ³Ğ»Ğ¸Ğ½ĞµĞ½Ğ¸Ñ… Ğ¼Ğ¾Ğ½ÑÑ‚Ñ€Ñ–Ğ² Ğ¿Ñ€Ğ¸ Ğ²Ğ¸Ğ±Ğ¾Ñ€Ñ– Ñ†Ñ–Ğ»Ñ–
        const isTargetable = u => {
            if (u.hp <= 0) return false;
            if (u.type === 'monster' && u.invisActive) return false;
            if (u._absorbedBy) return false;
            return true;
        };

        // Bat: 10% ÑƒÑ…Ğ¸Ğ»ĞµĞ½Ğ½Ñ
        if (this.type === 'monster' && this.ability === 'dodge' && Math.random() < 0.10)
            return; // Ğ¿Ñ€Ğ¾Ğ¿ÑƒÑĞºĞ°Ñ”Ğ¼Ğ¾ Ñ†ĞµĞ¹ Ñ‚Ñ–Ğº Ğ¾Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ Ğ±Ğ¾Ğ¹Ğ¾Ğ²Ğ¾Ñ— Ğ»Ğ¾Ğ³Ñ–ĞºĞ¸

        // Ğ“ĞµÑ€Ğ¾Ñ— Ñ‚Ğ° Ğ¼Ğ¾Ğ½ÑÑ‚Ñ€Ğ¸ Ğ±'ÑÑ‚ÑŒÑÑ Ğ»Ğ¸ÑˆĞµ ÑÑ‚Ğ¾ÑÑ‡Ğ¸ Ğ½Ğ° Ğ·ĞµĞ¼Ğ»Ñ– Ğ¿Ğ¾Ğ²ĞµÑ€Ñ…Ñƒ (Ğ½Ğµ Ğ½Ğ° ÑÑ…Ğ¾Ğ´Ğ¸Ğ½ĞºĞ°Ñ…)
        if (this.isClimbing || this.isClimbingUp) {
            this.state = 'move';
            if (this.type === 'hero') this.moveHero();
            else this.moveMonster();
            return;
        }

        let enemy = null;
        if (this.type === 'monster') {
            // Ğ“ĞµÑ€Ğ¾Ñ—, Ñ‰Ğ¾ ÑÑ‚Ğ¾ÑÑ‚ÑŒ Ğ½Ğ° Ñ‚Ğ¾Ğ¼Ñƒ Ğ¶ Ğ¿Ğ¾Ğ²ĞµÑ€ÑÑ– (Ğ½Ğµ Ğ½Ğ° ÑÑ…Ğ¾Ğ´Ğ¸Ğ½ĞºĞ°Ñ…)
            let heroesOnFloor = units.filter(u =>
                u.type === 'hero' && u.floorIdx === this.floorIdx &&
                !u.isClimbing && isTargetable(u)
            );
            let inRange = heroesOnFloor.filter(u => Math.abs(u.x - this.x) < range && Math.abs(u.y - this.y) < 40);

            if (inRange.length > 0) {
                // ĞŸĞµÑ€ĞµĞ²Ñ–Ñ€ÑÑ”Ğ¼Ğ¾: Ñ‡Ğ¸ Ğ¿Ğ¾Ñ‚Ğ¾Ñ‡Ğ½Ğ° Ñ†Ñ–Ğ»ÑŒ Ñ‰Ğµ Ğ¶Ğ¸Ğ²Ğ° Ñ– Ğ² Ñ€Ğ°Ğ´Ñ–ÑƒÑÑ–
                if (this.fightTarget && this.fightTarget.hp > 0 && inRange.includes(this.fightTarget)) {
                    enemy = this.fightTarget;
                } else {
                    // Ğ’Ğ¸Ğ±Ğ¸Ñ€Ğ°Ñ”Ğ¼Ğ¾ Ğ½Ğ¾Ğ²Ñƒ Ñ†Ñ–Ğ»ÑŒ: 80% Ğ½Ğ°Ğ¹ÑĞ»Ğ°Ğ±ÑˆĞ¸Ğ¹, 20% Ğ²Ğ¸Ğ¿Ğ°Ğ´ĞºĞ¾Ğ²Ğ¸Ğ¹
                    if (Math.random() < 0.8) {
                        enemy = inRange.reduce((min, u) => u.hp < min.hp ? u : min, inRange[0]);
                    } else {
                        enemy = inRange[Math.floor(Math.random() * inRange.length)];
                    }
                    this.fightTarget = enemy;
                }
            }
        } else {
            enemy = units.find(u => enemyTypes.includes(u.type) && isTargetable(u)
                && u.floorIdx === this.floorIdx
                && Math.abs(u.x - this.x) < range && Math.abs(u.y - this.y) < 40);
        }

        if (enemy) {
            this.state = 'fight';
            if (this.attackCooldown <= 0) {
                let dmgDealt = this.dmg;

                // Ğ‘ĞµÑ€ÑĞµÑ€Ğº: ĞºÑ€Ğ¸Ñ‚ Ã—2
                let _isCrit = false;
                if (this.type === 'hero' && this.critChance && Math.random() < this.critChance) {
                    dmgDealt *= 2; _isCrit = true;
                    for (let _ci=0;_ci<5;_ci++) spawnParticle(enemy.x+(Math.random()-.5)*10, enemy.y-enemy.size-4, 'orange',{size:3+Math.random()*3,vy:-(1.5+Math.random())});
                }
                // ĞÑĞ°ÑÑ–Ğ½: Ğ¿ĞµÑ€ÑˆĞ¸Ğ¹ ÑƒĞ´Ğ°Ñ€ Ã—2
                if (this.type === 'hero' && this.firstBlood) {
                    dmgDealt *= 2; this.firstBlood = false; _isCrit = true;
                    for (let _fi=0;_fi<5;_fi++) spawnParticle(enemy.x+(Math.random()-.5)*8, enemy.y-enemy.size-4, 'red',{size:3+Math.random()*3,vy:-(1.5+Math.random())});
                }
                if (_isCrit) spawnDmgText(enemy.x, enemy.y - enemy.size - 10, 'âœ¦ĞšĞ Ğ˜Ğ¢ ' + Math.round(dmgDealt), '#ffcc00', true);

                // â”€â”€ Ğ‘Ñ€Ğ¾Ğ½Ñ (Dota-Ñ„Ğ¾Ñ€Ğ¼ÑƒĞ»Ğ°) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                // Ğ›Ñ–Ñ‡ Ñ–Ğ³Ğ½Ğ¾Ñ€ÑƒÑ” Ğ±Ñ€Ğ¾Ğ½Ñ; Ğ§ĞµĞ¼Ğ¿Ñ–Ğ¾Ğ½ Ñ–Ğ³Ğ½Ğ¾Ñ€ÑƒÑ” Ğ±Ñ€Ğ¾Ğ½Ñ
                let pierceArmor = (this.ability === 'armor_pierce') || (this.type === 'hero' && this.armorPierce);
                dmgDealt = applyArmor(dmgDealt, enemy.armor || 0, pierceArmor);

                // WATER_ELE: Ğ¿Ğ¾Ğ³Ğ»Ğ¸Ğ½Ğ°Ñ” 20% Ğ²Ñ…Ñ–Ğ´Ğ½Ğ¾Ğ³Ğ¾ ÑƒÑ€Ğ¾Ğ½Ñƒ (Ğ»Ğ¸ÑˆĞ¾Ğº Ğ½Ğµ Ğ½Ğ°ĞºĞ¾Ğ¿Ğ¸Ñ‡ÑƒÑ”Ñ‚ÑŒÑÑ)
                if (enemy.ability === 'absorb' && (enemy.absorbShield||0) > 0) {
                    let absorbed = Math.min(enemy.absorbShield, dmgDealt * 0.2);
                    enemy.absorbShield -= absorbed;
                    dmgDealt -= absorbed;
                    spawnParticle(enemy.x, enemy.y - enemy.size, 'blue');
                }

                // DARK KNIGHT: Ğ²Ñ–Ğ´Ğ±Ğ¸Ğ²Ğ°Ñ” 20% ÑƒÑ€Ğ¾Ğ½Ñƒ Ğ½Ğ°Ğ·Ğ°Ğ´ Ğ°Ñ‚Ğ°ĞºÑƒÑÑ‡Ğ¾Ğ¼Ñƒ
                if (enemy.ability === 'reflect' && enemy.type === 'monster') {
                    let reflected = dmgDealt * 0.20;
                    this.hp -= reflected;
                    spawnParticle(this.x, this.y - this.size, 'orange');
                }

                enemy.hp -= dmgDealt;
                // Ğ›Ğ¾Ñ€Ğ´ Ğ¾Ñ‚Ñ€Ğ¸Ğ¼Ğ°Ğ² ÑƒĞ´Ğ°Ñ€ â€” Ğ¼Ğ°Ğ»Ğµ Ñ‚Ñ€ĞµĞ¼Ñ‚Ñ–Ğ½Ğ½Ñ
                if (enemy.type === 'lord') triggerScreenShake(3);

                // â”€â”€ On-hit Ğ·Ğ´Ñ–Ğ±Ğ½Ğ¾ÑÑ‚Ñ– Ğ°Ñ‚Ğ°ĞºÑƒÑÑ‡Ğ¾Ğ³Ğ¾ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

                // SLIME: ÑĞ¿Ğ¾Ğ²Ñ–Ğ»ÑŒĞ½ĞµĞ½Ğ½Ñ Ğ°Ñ‚Ğ°ĞºĞ¸ -10% Ğ·Ğ° ÑƒĞ´Ğ°Ñ€ (Ğ¼Ğ°ĞºÑ 50%)
                if (this.ability === 'atk_slow' && enemy.type === 'hero') {
                    this.atkSlowStacks = Math.min(5, (this.atkSlowStacks||0) + 1);
                    enemy._atkSlowMult = Math.max(0.5, 1 - this.atkSlowStacks * 0.10);
                    spawnParticle(enemy.x, enemy.y - enemy.size, 'green');
                }

                // HOUNDS: 15% ĞºÑ€Ğ¾Ğ²Ğ¾Ñ‚ĞµÑ‡Ğ° â€” 1% maxHP/ÑĞµĞº Ğ½Ğ° 5 ÑĞµĞº
                if (this.ability === 'bleed' && Math.random() < 0.15 && enemy.type === 'hero') {
                    enemy._bleedTicks = (enemy._bleedTicks||0) + 300; // 5 ÑĞµĞº * 60
                    enemy._bleedDps   = enemy.maxHp * 0.01;
                    spawnParticle(enemy.x, enemy.y - enemy.size, 'red');
                }

                // ZOMBIE: 3% Ğ·Ğ°Ñ€Ğ°Ğ·Ğ¸Ñ‚Ğ¸ Ğ³ĞµÑ€Ğ¾Ñ (Ñ€ĞµĞ¹Ñ‚Ğ¸Ğ½Ğ³: boss=0, elite=1%, normal=3%)
                if (this.ability === 'infect' && enemy.type === 'hero' && enemy.hp > 0) {
                    let chance = enemy.heroRank==='boss'?0 : enemy.heroRank&&enemy.heroRank.startsWith('elite')?0.01:0.03;
                    if (Math.random() < chance) {
                        let floorMonsters = units.filter(u=>u.type==='monster'&&u.floorIdx===this.floorIdx).length;
                        let floorObj = floors[this.floorIdx];
                        if (floorObj && floorMonsters < floorObj.maxMonsters) {
                            enemy.type='monster'; enemy.monsterKind='zombie'; enemy.ability='infect';
                            enemy.color='#5a8c3a'; enemy.armor=3; enemy.baseAtkSpeed=0.55; enemy.atkSpeedBonus=0;
                            enemy.floorIdx=this.floorIdx;
                            spawnParticle(enemy.x, enemy.y-enemy.size, 'green');
                        }
                    }
                }

                // SPIRIT: 12% Ğ¿ĞµÑ€ĞµĞ»ÑĞº â€” Ğ³ĞµÑ€Ğ¾Ğ¹ Ğ±Ñ–Ğ¶Ğ¸Ñ‚ÑŒ Ğ´Ğ¾ Ğ¼Ñ–ÑÑ‚Ğ° 2 ÑĞµĞº
                if (this.ability === 'scare' && Math.random() < 0.12 && enemy.type === 'hero') {
                    enemy._scareTimer = 120; enemy.waveActive = true;
                    spawnParticle(enemy.x, enemy.y - enemy.size, 'cyan');
                }

                // STONE GOLEM: 12% ÑÑ‚Ğ°Ğ½ Ğ½Ğ° 2 ÑĞµĞº
                if (this.ability === 'stun' && Math.random() < 0.12 && enemy.type === 'hero') {
                    enemy._stunTimer = (enemy._stunTimer||0) + 120;
                    spawnParticle(enemy.x, enemy.y - enemy.size, 'cyan');
                }

                // MINOTAUR: ĞºĞ¾Ğ¶ĞµĞ½ 4-Ğ¹ ÑƒĞ´Ğ°Ñ€ â€” AĞĞ• 25% ÑƒÑ€Ğ¾Ğ½Ñƒ Ğ¿Ğ¾ Ğ²ÑÑ–Ñ… Ğ³ĞµÑ€Ğ¾ÑÑ… Ğ½Ğ° Ğ¿Ğ¾Ğ²ĞµÑ€ÑÑ–
                if (this.ability === 'aoe4th') {
                    this.aoeHitCount = ((this.aoeHitCount||0) + 1);
                    if (this.aoeHitCount % 4 === 0) {
                        units.filter(u=>u.type==='hero'&&u.floorIdx===this.floorIdx&&u.hp>0).forEach(h=>{
                            let aoeDmg = applyArmor(this.dmg*0.25, h.armor||0, false);
                            h.hp -= aoeDmg;
                            spawnParticle(h.x, h.y-h.size, 'orange');
                        });
                    }
                }

                // EARTH_ELE: 12% Ğ²Ñ–Ğ´ĞºĞ¸Ğ´Ğ°Ğ½Ğ½Ñ Ğ³ĞµÑ€Ğ¾Ñ Ğ´Ğ¾ ÑÑ‚Ñ–Ğ½Ğ¸ (3Ã— ÑƒÑ€Ğ¾Ğ½)
                if (this.ability === 'knockback' && Math.random() < 0.12 && enemy.type === 'hero') {
                    let wallX = (enemy.x < centerX) ? (centerX - CFG.floorW/2 + 15) : (centerX + CFG.floorW/2 - 15);
                    enemy.x = wallX;
                    let kbDmg = applyArmor(this.dmg * 2, enemy.armor||0, false); // Ã—3 total (1 Ğ²Ğ¶Ğµ Ğ½Ğ°Ğ½ĞµÑĞµĞ½Ğ¾)
                    enemy.hp -= kbDmg;
                    spawnParticle(enemy.x, enemy.y-enemy.size, 'red');
                }

                // LIGHTNING: 15% Ğ»Ğ°Ğ½Ñ†ÑĞ³Ğ¾Ğ²Ğ° Ğ±Ğ»Ğ¸ÑĞºĞ°Ğ²ĞºĞ° Ğ´Ğ¾ Ñ€Ğ°Ğ½Ğ´Ğ¾Ğ¼Ğ½Ğ¾Ğ³Ğ¾ Ğ³ĞµÑ€Ğ¾Ñ
                if (this.ability === 'chain' && Math.random() < 0.15) {
                    let others = units.filter(u=>u.type==='hero'&&u!==enemy&&u.floorIdx===this.floorIdx&&u.hp>0);
                    if (others.length > 0) {
                        let ch = others[Math.floor(Math.random()*others.length)];
                        let chDmg = applyArmor(this.dmg * 0.5, ch.armor||0, false);
                        ch.hp -= chDmg;
                        spawnParticle(ch.x, ch.y-ch.size, 'yellow');
                    }
                }

                // ĞšÑƒĞ»Ğ´Ğ°ÑƒĞ½ Ğ°Ñ‚Ğ°ĞºĞ¸ (Ğ²Ñ€Ğ°Ñ…Ğ¾Ğ²ÑƒÑ” ÑĞ¿Ğ¾Ğ²Ñ–Ğ»ÑŒĞ½ĞµĞ½Ğ½Ñ Ğ²Ñ–Ğ´ slime)
                {
                    let atkSpd = (this.baseAtkSpeed || 0.83) + (this.atkSpeedBonus || 0);
                    let slow = (this.type==='hero') ? (this._atkSlowMult || 1) : 1;
                    // ĞšÑ€Ğ¾Ğ²Ğ¾Ñ‚ĞµÑ‡Ğ° Ğ³ĞµÑ€Ğ¾Ñ
                    if (this.type==='hero' && (this._bleedTicks||0) > 0) {
                        this._bleedTicks--;
                        this.hp -= (this._bleedDps||0) / 60;
                    }
                    this.attackCooldown = Math.max(8, Math.round(60 / (atkSpd * slow)));
                }
                spawnParticle((this.x+enemy.x)/2, (this.y+enemy.y)/2, this.type==='lord'?'purple':'white');
                if (this.type !== 'lord') this.x += (Math.random()-.5)*4;
            } else {
                this.attackCooldown--;
            }
            return;
        }
        this.state = 'move';
        if (this.type === 'hero') this.moveHero();
        else if (this.type === 'monster') this.moveMonster();
    }

    moveHero() {
        if (this.floorIdx < 0) {
            // Ğ“ĞµÑ€Ğ¾Ğ¹ Ñ–Ğ´Ğµ Ğ´Ğ¾ Ğ²Ñ…Ğ¾Ğ´Ñƒ Ğ² Ğ¿ĞµÑ‡ĞµÑ€Ñƒ (CAVE_X)
            if (Math.abs(this.x - CAVE_X) > 5) {
                this.x += (CAVE_X - this.x > 0 ? 1 : -1) * this.speed;
            } else {
                this.y += 2; this.x = CAVE_X;
                if (floors[0] && this.y >= floors[0].y) {
                    this.y = floors[0].y; this.floorIdx = 0; this.isClimbing = false;
                }
            }
            return;
        }
        let cur = floors[this.floorIdx];
        if (!cur) return;

        // ĞŸĞ°ÑÑ‚ĞºĞ¸ â€” ÑˆĞ¸Ğ¿Ğ¸ Ñ– Ğ·Ğ°Ğ¿Ğ°Ğ¼Ğ¾Ñ€Ğ¾Ñ‡ĞµĞ½Ğ½Ñ (Ñ‚Ñ€Ğ¸Ğ³ĞµÑ€ÑƒÑÑ‚ÑŒÑÑ Ğ¿Ñ€Ğ¸ Ğ½Ğ°ÑÑ‚ÑƒĞ¿Ñ–)
        if (cur.hasTrap && !this.trapDamaged) {
            if (cur.trapType === 'spike') {
                this.hp -= 20;
                this.trapDamaged = true;
                spawnParticle(this.x, this.y, 'red');
            } else if (cur.trapType === 'daze') {
                if (Math.random() < 0.01 && !this.dazeMode) { // 1% ÑˆĞ°Ğ½Ñ
                    this.dazeMode = true;
                    this.color = '#ffaa00';
                    this.waveActive = true;
                    spawnParticle(this.x, this.y, 'gold');
                }
                this.trapDamaged = true;
            }
            // Ğ¢ĞµĞ»ĞµĞ¿Ğ¾Ñ€Ñ‚ ĞĞ• Ñ‚ÑƒÑ‚ â€” Ğ²Ñ–Ğ½ Ğ³Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ğ¸Ğ¹ Ñ‡ĞµÑ€ĞµĞ· tickTeleports()
        }

        let next = floors[this.floorIdx + 1];
        if (next) {
            let ladX = cur.ladderX;
            if (this.isClimbing) {
                this.y += 2;
                if (this.y >= next.y) { this.y = next.y; this.floorIdx++; this.isClimbing = false; this.trapDamaged = false; }
            } else {
                if (Math.abs(this.x - ladX) > 5) this.x += (ladX - this.x > 0 ? 1 : -1) * this.speed;
                else { this.x = ladX; this.isClimbing = true; }
            }
        } else {
            if (this.isClimbing) {
                this.y += 2;
                if (this.y >= cur.y) { this.y = cur.y; this.isClimbing = false; }
            } else {
                if (Math.abs(this.x - centerX) > 30) this.x += (centerX - this.x > 0 ? 1 : -1) * this.speed;
            }
        }
    }

    moveFeared() {
        // Ğ“ĞµÑ€Ğ¾Ğ¹ Ñ‚Ñ–ĞºĞ°Ñ” Ğ´Ğ¾ Ğ¼Ñ–ÑÑ‚Ğ° â€” Ğ´Ğ·ĞµÑ€ĞºĞ°Ğ»ÑŒĞ½Ğ¾ moveMonster, Ğ°Ğ»Ğµ Ğ±ĞµĞ· Ğ¿Ğ¾ÑˆĞºĞ¾Ğ´Ğ¶ĞµĞ½Ğ½Ñ Ğ¼Ñ–ÑÑ‚Ğ°
        if (this.floorIdx < 0) {
            // ĞĞ° Ğ¿Ğ¾Ğ²ĞµÑ€Ñ…Ğ½Ñ– â€” Ğ·ÑƒĞ¿Ğ¸Ğ½ÑÑ”Ñ‚ÑŒÑÑ Ğ±Ñ–Ğ»Ñ Ğ²Ğ¾Ñ€Ñ–Ñ‚, Ğ½Ğµ Ğ°Ñ‚Ğ°ĞºÑƒÑ” Ğ¼Ñ–ÑÑ‚Ğ¾
            this.y = CFG.surfaceY;
            if (this.x > CITY_GATE_X + 20) this.x -= this.speed;
            return;
        }
        if (this.floorIdx === 0) {
            // ĞŸĞ¾Ğ²ĞµÑ€Ñ… 0 â†’ Ğ¿Ñ–Ğ´Ğ½Ñ–Ğ¼Ğ°Ñ”Ñ‚ÑŒÑÑ Ñ‡ĞµÑ€ĞµĞ· CAVE_X Ğ½Ğ° Ğ¿Ğ¾Ğ²ĞµÑ€Ñ…Ğ½Ñ
            if (this.isClimbingUp) {
                this.y -= this.speed * 2; this.x = CAVE_X;
                if (this.y <= CFG.surfaceY) { this.y = CFG.surfaceY; this.floorIdx = -1; this.isClimbingUp = false; }
            } else {
                if (Math.abs(this.x - CAVE_X) > 10) this.x += (CAVE_X - this.x > 0 ? 1 : -1) * this.speed;
                else { this.x = CAVE_X; this.isClimbingUp = true; }
            }
            return;
        }
        // Ğ“Ğ»Ğ¸Ğ±ÑˆÑ– Ğ¿Ğ¾Ğ²ĞµÑ€Ñ…Ğ¸ â†’ Ğ´Ğ¾ ÑÑ…Ğ¾Ğ´Ñ–Ğ² Ğ¿Ğ¾Ğ²ĞµÑ€Ñ…Ñƒ Ğ²Ğ¸Ñ‰Ğµ
        let prev = floors[this.floorIdx - 1];
        let ladX = prev ? prev.ladderX : CAVE_X;
        if (this.isClimbingUp) {
            this.y -= this.speed * 2; this.x = ladX;
            let tY = prev ? prev.y : CFG.surfaceY;
            if (this.y <= tY) { this.y = tY; this.floorIdx--; this.isClimbingUp = false; }
        } else {
            if (Math.abs(this.x - ladX) > 10) this.x += (ladX - this.x > 0 ? 1 : -1) * this.speed;
            else { this.x = ladX; this.isClimbingUp = true; }
        }
    }

    moveMonster() {
        if (this.waveActive) {
            // ĞŸĞ¾Ğ²ĞµÑ€Ñ…Ğ½Ñ â€” Ğ±Ñ–Ğ¶Ğ¸Ñ‚ÑŒ Ğ´Ğ¾ Ğ¼Ñ–ÑÑ‚Ğ°
            if (this.floorIdx < 0) {
                this.y = CFG.surfaceY;
                if (this.x > CITY_GATE_X) { this.x -= this.speed * 2; }
                else { GAME.cityHP -= this.dmg * 5; this.hp = 0; spawnParticle(this.x, this.y, 'red'); }
                return;
            }
            // ĞŸĞ¾Ğ²ĞµÑ€Ñ… 0 â€” Ğ´Ğ¾ Ğ²Ğ¸Ñ…Ğ¾Ğ´Ñƒ (CAVE_X)
            if (this.floorIdx === 0) {
                if (this.isClimbingUp) {
                    this.y -= this.speed * 2; this.x = CAVE_X;
                    if (this.y <= CFG.surfaceY) { this.y = CFG.surfaceY; this.floorIdx = -1; this.isClimbingUp = false; }
                } else {
                    if (Math.abs(this.x - CAVE_X) > 10) this.x += (CAVE_X - this.x > 0 ? 1 : -1) * this.speed * 1.5;
                    else { this.x = CAVE_X; this.isClimbingUp = true; }
                }
                return;
            }
            // Ğ’Ğ¸Ñ‰Ñ– Ğ¿Ğ¾Ğ²ĞµÑ€Ñ…Ğ¸
            let prev = floors[this.floorIdx - 1];
            let ladX = prev ? prev.ladderX : CAVE_X;
            if (this.isClimbingUp) {
                this.y -= this.speed * 2; this.x = ladX;
                let tY = prev ? prev.y : CFG.surfaceY;
                if (this.y <= tY) { this.y = tY; this.floorIdx--; this.isClimbingUp = false; }
            } else {
                if (Math.abs(this.x - ladX) > 10) this.x += (ladX - this.x > 0 ? 1 : -1) * this.speed * 1.5;
                else { this.x = ladX; this.isClimbingUp = true; }
            }
        } else {
            // ĞĞ³Ñ€: ÑĞºÑ‰Ğ¾ Ğ³ĞµÑ€Ğ¾Ğ¹ Ğ½Ğ° Ñ†ÑŒĞ¾Ğ¼Ñƒ Ğ¿Ğ¾Ğ²ĞµÑ€ÑÑ– Ğ² Ñ€Ğ°Ğ´Ñ–ÑƒÑÑ– 210px (Ğ½Ğµ Ğ½Ğ° ÑÑ…Ğ¾Ğ´Ğ¸Ğ½ĞºĞ°Ñ…) â€” Ğ±Ñ–Ğ¶Ğ¸Ğ¼Ğ¾ Ğ´Ğ¾ Ğ½ÑŒĞ¾Ğ³Ğ¾
            let aggroTarget = units.find(u =>
                u.type === 'hero' && u.floorIdx === this.floorIdx &&
                u.hp > 0 && !u.isClimbing && Math.abs(u.x - this.x) < 210
            );
            if (aggroTarget) {
                // Ğ‘Ñ–Ğ¶Ğ¸Ğ¼Ğ¾ Ğ´Ğ¾ Ğ³ĞµÑ€Ğ¾Ñ
                let dir = aggroTarget.x > this.x ? 1 : -1;
                this.x += dir * this.speed * 0.9;
            } else {
                // ĞŸĞ°Ñ‚Ñ€ÑƒĞ»ÑŒ
                if (!this.patrolDir) this.patrolDir = 1;
                this.x += this.speed * 0.5 * this.patrolDir;
                let fx = centerX - CFG.floorW/2 + 30;
                let fw = CFG.floorW - 60;
                if (this.x > fx + fw) this.patrolDir = -1;
                if (this.x < fx)      this.patrolDir = 1;
            }
        }
    }

    draw(camY) {
        if (this.hp <= 0) return;
        let dx = this.x - this.size/2;
        let dy = this.y - this.size - camY;

        // ĞĞ±Ğ²Ğ¾Ğ´ĞºĞ¸ Ğ´Ğ»Ñ Ñ€Ğ°Ğ½Ğ³Ñ–Ğ² â€” Ñ‚Ñ–Ğ»ÑŒĞºĞ¸ Ğ´Ğ»Ñ Ğ±Ğ¾ÑĞ° (ĞµĞ»Ñ–Ñ‚Ğ¸ Ğ±ĞµĞ· ĞºĞ²Ğ°Ğ´Ñ€Ğ°Ñ‚Ñ–Ğ²)
        if (this.type === 'hero' && this.heroRank === 'boss') {
            let pulse = 0.6 + 0.4 * Math.sin(Date.now() / 200);
            ctx.strokeStyle = `rgba(255,0,255,${pulse})`; ctx.lineWidth = 4;
            ctx.beginPath(); ctx.arc(this.x, dy + this.size/2, this.size/2 + 6, 0, Math.PI*2); ctx.stroke();
        }

        // â”€â”€ Ğ’Ñ–Ğ´Ğ¼Ğ°Ğ»ÑŒĞ¾Ğ²ĞºĞ° Ñ‚Ñ–Ğ»Ğ° ÑĞ½Ñ–Ñ‚Ğ° (Ñ‡Ğ¾Ñ€Ğ½Ğ¸Ğ¹ ĞºĞ¾Ğ½Ñ‚ÑƒÑ€ Ñ‡ĞµÑ€ĞµĞ· shadow) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        ctx.shadowColor = '#000';
        ctx.shadowBlur  = 6;
        if (this.type === 'monster' && this.monsterKind === 'slime') {
            // Ğ¡Ğ»Ğ¸Ğ·ÑŒ â€” ĞºÑ€ÑƒĞ³Ğ»Ğ°, Ğ½Ğ°Ğ¿Ñ–Ğ²Ğ¿Ñ€Ğ¾Ğ·Ğ¾Ñ€Ğ°, Ğ¶ĞµĞ»ĞµĞ¿Ğ¾Ğ´Ñ–Ğ±Ğ½Ğ°
            let t = Date.now() / 600;
            let wobble = Math.sin(t) * 2;
            let rg = ctx.createRadialGradient(this.x - 4, dy + 6, 2, this.x, dy + this.size/2, this.size/2 + 2);
            rg.addColorStop(0,   'rgba(150,255,150,0.95)');
            rg.addColorStop(0.5, 'rgba(60,200,60,0.85)');
            rg.addColorStop(1,   'rgba(20,120,20,0.7)');
            ctx.fillStyle = rg;
            ctx.beginPath();
            ctx.ellipse(this.x, dy + this.size/2 + wobble*0.3, this.size/2 + wobble*0.4, this.size/2 - wobble*0.3, 0, 0, Math.PI*2);
            ctx.fill();
            // ĞÑ‡Ñ–
            ctx.fillStyle = '#000';
            ctx.beginPath(); ctx.arc(this.x - 5, dy + this.size/2 - 2, 2.5, 0, Math.PI*2); ctx.fill();
            ctx.beginPath(); ctx.arc(this.x + 5, dy + this.size/2 - 2, 2.5, 0, Math.PI*2); ctx.fill();
            ctx.fillStyle = '#fff';
            ctx.beginPath(); ctx.arc(this.x - 4, dy + this.size/2 - 3, 1, 0, Math.PI*2); ctx.fill();
            ctx.beginPath(); ctx.arc(this.x + 6, dy + this.size/2 - 3, 1, 0, Math.PI*2); ctx.fill();
            // Ğ‘Ğ»Ğ¸ÑĞº
            ctx.fillStyle = 'rgba(255,255,255,0.35)';
            ctx.beginPath(); ctx.ellipse(this.x - 6, dy + 7, 4, 2.5, -0.5, 0, Math.PI*2); ctx.fill();

        } else if (this.type === 'monster' && this.monsterKind === 'skeleton') {
            // Ğ¡ĞºĞµĞ»ĞµÑ‚ â€” ĞºÑ–ÑÑ‚ÑĞ½Ğ¸Ğ¹, ÑÑ–Ñ€ÑƒĞ²Ğ°Ñ‚Ğ¾-Ğ¶Ğ¾Ğ²Ñ‚Ğ¸Ğ¹, Ğ· Ñ‡ĞµÑ€ĞµĞ¿Ğ¾Ğ¼
            let s = this.size;
            // Ğ¢Ñ–Ğ»Ğ¾ (Ñ‚ÑƒĞ»ÑƒĞ±)
            ctx.fillStyle = '#c8b870';
            ctx.fillRect(dx + s*0.3, dy + s*0.45, s*0.4, s*0.4);
            // Ğ ĞµĞ±Ñ€Ğ°
            ctx.strokeStyle = '#a09050'; ctx.lineWidth = 1.5;
            for (let r = 0; r < 3; r++) {
                let ry = dy + s*0.5 + r*4;
                ctx.beginPath(); ctx.moveTo(dx+s*0.3, ry); ctx.lineTo(dx+s*0.1, ry+2); ctx.stroke();
                ctx.beginPath(); ctx.moveTo(dx+s*0.7, ry); ctx.lineTo(dx+s*0.9, ry+2); ctx.stroke();
            }
            // ĞĞ¾Ğ³Ğ¸
            ctx.fillStyle = '#c8b870';
            ctx.fillRect(dx + s*0.25, dy + s*0.82, s*0.18, s*0.18);
            ctx.fillRect(dx + s*0.57, dy + s*0.82, s*0.18, s*0.18);
            // Ğ ÑƒĞºĞ¸
            ctx.fillRect(dx + s*0.05, dy + s*0.48, s*0.18, s*0.1);
            ctx.fillRect(dx + s*0.77, dy + s*0.48, s*0.18, s*0.1);
            // Ğ§ĞµÑ€ĞµĞ¿
            ctx.fillStyle = '#ddd4a0';
            ctx.beginPath(); ctx.arc(this.x, dy + s*0.28, s*0.26, 0, Math.PI*2); ctx.fill();
            // ĞÑ‡Ğ½Ğ¸Ñ†Ñ–
            ctx.fillStyle = '#1a1408';
            ctx.beginPath(); ctx.ellipse(this.x - s*0.1, dy + s*0.26, s*0.08, s*0.1, 0, 0, Math.PI*2); ctx.fill();
            ctx.beginPath(); ctx.ellipse(this.x + s*0.1, dy + s*0.26, s*0.08, s*0.1, 0, 0, Math.PI*2); ctx.fill();
            // ĞŸĞ¾ÑĞ¼Ñ–ÑˆĞºĞ°
            ctx.strokeStyle = '#1a1408'; ctx.lineWidth = 1;
            ctx.beginPath(); ctx.arc(this.x, dy + s*0.34, s*0.1, 0.1, Math.PI-0.1); ctx.stroke();

        } else if (this.type === 'monster' && this.monsterKind === 'zombie') {
            // Ğ—Ğ¾Ğ¼Ğ±Ñ– â€” Ğ·ĞµĞ»ĞµĞ½ÑƒĞ²Ğ°Ñ‚Ğ¸Ğ¹, Ğ¿Ğ¾Ğ²Ñ–Ğ»ÑŒĞ½Ğ¸Ğ¹, Ñ€Ğ¾Ğ·Ñ…Ñ€Ğ¸ÑÑ‚Ğ°Ğ½Ğ¸Ğ¹
            let s = this.size;
            // Ğ¢Ñ–Ğ»Ğ¾
            ctx.fillStyle = '#4a7a30';
            ctx.fillRect(dx + s*0.2, dy + s*0.4, s*0.6, s*0.45);
            // Ğ“Ğ¾Ğ»Ğ¾Ğ²Ğ°
            ctx.fillStyle = '#5a8c3a';
            ctx.beginPath(); ctx.arc(this.x, dy + s*0.28, s*0.28, 0, Math.PI*2); ctx.fill();
            // Ğ¨Ğ¸Ñ
            ctx.fillStyle = '#4a7a30';
            ctx.fillRect(dx + s*0.38, dy + s*0.37, s*0.24, s*0.1);
            // Ğ ÑƒĞºĞ¸ (Ğ·Ğ¾Ğ¼Ğ±Ñ– Ñ‚ÑĞ³Ğ½ÑƒÑ‚ÑŒ Ğ²Ğ¿ĞµÑ€ĞµĞ´ Ğ¾Ğ´Ğ½Ñƒ Ñ€ÑƒĞºÑƒ)
            ctx.strokeStyle = '#4a7a30'; ctx.lineWidth = 4;
            ctx.beginPath(); ctx.moveTo(dx + s*0.1, dy + s*0.5); ctx.lineTo(dx - s*0.12, dy + s*0.45); ctx.stroke(); // Ğ»Ñ–Ğ²Ğ° â€” Ğ²Ğ½Ğ¸Ğ·
            ctx.beginPath(); ctx.moveTo(dx + s*0.9, dy + s*0.5); ctx.lineTo(dx + s*1.15, dy + s*0.3); ctx.stroke(); // Ğ¿Ñ€Ğ°Ğ²Ğ° â€” Ğ²Ğ¿ĞµÑ€ĞµĞ´
            // ĞĞ¾Ğ³Ğ¸
            ctx.fillStyle = '#3a6020';
            ctx.fillRect(dx + s*0.22, dy + s*0.82, s*0.22, s*0.18);
            ctx.fillRect(dx + s*0.56, dy + s*0.82, s*0.22, s*0.18);
            // ĞÑ‡Ñ– â€” Ğ¶Ğ¾Ğ²Ñ‚Ñ–, Ğ·Ğ°Ğ¿Ğ°Ğ»Ñ–
            ctx.fillStyle = '#aacc00';
            ctx.beginPath(); ctx.arc(this.x - s*0.1, dy + s*0.25, s*0.09, 0, Math.PI*2); ctx.fill();
            ctx.beginPath(); ctx.arc(this.x + s*0.1, dy + s*0.25, s*0.09, 0, Math.PI*2); ctx.fill();
            ctx.fillStyle = '#000';
            ctx.beginPath(); ctx.arc(this.x - s*0.1, dy + s*0.25, s*0.05, 0, Math.PI*2); ctx.fill();
            ctx.beginPath(); ctx.arc(this.x + s*0.1, dy + s*0.25, s*0.05, 0, Math.PI*2); ctx.fill();
            // Ğ Ğ¾Ñ‚ â€” ĞºÑ€Ğ¸Ğ²Ğ° Ñ‰Ñ–Ğ»Ğ¸Ğ½Ğ°
            ctx.strokeStyle = '#2a4a18'; ctx.lineWidth = 1.5;
            ctx.beginPath(); ctx.moveTo(this.x - s*0.12, dy + s*0.36); ctx.quadraticCurveTo(this.x, dy + s*0.42, this.x + s*0.12, dy + s*0.35); ctx.stroke();

        } else if (this.type === 'monster' && this.monsterKind === 'hounds') {
            // ĞŸĞµÑ â€” Ğ¿Ñ€Ğ¸Ğ·ĞµĞ¼ĞºÑƒĞ²Ğ°Ñ‚Ğ¸Ğ¹, ĞºĞ¾Ñ€Ğ¸Ñ‡Ğ½ĞµĞ²Ğ¸Ğ¹, 4 Ğ½Ğ¾Ğ³Ğ¸
            let s = this.size;
            ctx.fillStyle='#a05830'; ctx.fillRect(dx+s*0.08,dy+s*0.48,s*0.84,s*0.36);
            ctx.fillStyle='#c87040'; ctx.beginPath(); ctx.ellipse(this.x+s*0.3,dy+s*0.36,s*0.22,s*0.2,0,0,Math.PI*2); ctx.fill();
            ctx.fillStyle='#a05830';
            ctx.beginPath();ctx.moveTo(this.x+s*0.18,dy+s*0.22);ctx.lineTo(this.x+s*0.1,dy+s*0.06);ctx.lineTo(this.x+s*0.3,dy+s*0.2);ctx.closePath();ctx.fill();
            ctx.beginPath();ctx.moveTo(this.x+s*0.42,dy+s*0.22);ctx.lineTo(this.x+s*0.5,dy+s*0.06);ctx.lineTo(this.x+s*0.3,dy+s*0.2);ctx.closePath();ctx.fill();
            ctx.fillStyle='#000'; ctx.beginPath(); ctx.arc(this.x+s*0.3,dy+s*0.34,s*0.05,0,Math.PI*2); ctx.fill();
            ctx.strokeStyle='#a05830'; ctx.lineWidth=3;
            ctx.beginPath();ctx.moveTo(dx+s*0.08,dy+s*0.52);ctx.quadraticCurveTo(dx-s*0.1,dy+s*0.28,dx-s*0.05,dy+s*0.1);ctx.stroke();
            ctx.fillStyle='#804520'; ctx.fillRect(dx+s*0.12,dy+s*0.8,s*0.14,s*0.2); ctx.fillRect(dx+s*0.3,dy+s*0.8,s*0.14,s*0.2); ctx.fillRect(dx+s*0.48,dy+s*0.8,s*0.14,s*0.2); ctx.fillRect(dx+s*0.66,dy+s*0.8,s*0.14,s*0.2);

        } else if (this.type === 'monster' && this.monsterKind === 'spirit') {
            let s = this.size, t2=Date.now()/400;
            let origAlpha = ctx.globalAlpha;
            ctx.globalAlpha *= (0.6+0.2*Math.sin(t2));
            ctx.fillStyle='#aabbff';
            ctx.beginPath(); ctx.arc(this.x,dy+s*0.35,s*0.38,Math.PI,0); ctx.fill();
            ctx.beginPath(); ctx.moveTo(this.x-s*0.38,dy+s*0.35);
            for(let wx=-0.38;wx<=0.38;wx+=0.19){ctx.lineTo(this.x+s*(wx+0.095),dy+s*(0.35+0.12*Math.sin(t2+wx*8)));}
            ctx.closePath(); ctx.fill();
            ctx.globalAlpha = origAlpha;
            ctx.fillStyle='rgba(0,0,80,0.8)'; ctx.beginPath(); ctx.arc(this.x-s*0.12,dy+s*0.28,s*0.07,0,Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.arc(this.x+s*0.12,dy+s*0.28,s*0.07,0,Math.PI*2); ctx.fill();

        } else if (this.type === 'monster' && this.monsterKind === 'bat') {
            let s = this.size;
            ctx.fillStyle='#553366';
            ctx.beginPath();ctx.moveTo(this.x,dy+s*0.5);ctx.quadraticCurveTo(this.x-s*0.8,dy+s*0.1,this.x-s*0.5,dy+s*0.7);ctx.closePath();ctx.fill();
            ctx.beginPath();ctx.moveTo(this.x,dy+s*0.5);ctx.quadraticCurveTo(this.x+s*0.8,dy+s*0.1,this.x+s*0.5,dy+s*0.7);ctx.closePath();ctx.fill();
            ctx.fillStyle='#331144'; ctx.beginPath(); ctx.arc(this.x,dy+s*0.45,s*0.22,0,Math.PI*2); ctx.fill();
            ctx.fillStyle='#ff2255'; ctx.beginPath(); ctx.arc(this.x-s*0.08,dy+s*0.42,s*0.06,0,Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.arc(this.x+s*0.08,dy+s*0.42,s*0.06,0,Math.PI*2); ctx.fill();

        } else if (this.type === 'monster' && this.monsterKind === 'golem') {
            let s = this.size;
            ctx.fillStyle='#776655'; ctx.fillRect(dx+s*0.05,dy+s*0.35,s*0.9,s*0.6);
            ctx.fillStyle='#998877'; ctx.fillRect(dx+s*0.15,dy+s*0.15,s*0.7,s*0.3);
            ctx.strokeStyle='#554433'; ctx.lineWidth=2;
            ctx.beginPath();ctx.moveTo(this.x,dy+s*0.2);ctx.lineTo(this.x-s*0.1,dy+s*0.4);ctx.stroke();
            ctx.beginPath();ctx.moveTo(this.x+s*0.2,dy+s*0.5);ctx.lineTo(this.x+s*0.1,dy+s*0.7);ctx.stroke();
            ctx.fillStyle='#ff8800'; ctx.beginPath(); ctx.arc(this.x-s*0.18,dy+s*0.25,s*0.1,0,Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.arc(this.x+s*0.18,dy+s*0.25,s*0.1,0,Math.PI*2); ctx.fill();
            ctx.fillStyle='#665544'; ctx.fillRect(dx-s*0.1,dy+s*0.55,s*0.22,s*0.22); ctx.fillRect(dx+s*0.88,dy+s*0.55,s*0.22,s*0.22);

        } else if (this.type === 'monster' && this.monsterKind === 'minotaur') {
            let s = this.size;
            ctx.fillStyle='#774422'; ctx.fillRect(dx+s*0.1,dy+s*0.38,s*0.8,s*0.55);
            ctx.fillStyle='#996633'; ctx.beginPath(); ctx.arc(this.x,dy+s*0.25,s*0.3,0,Math.PI*2); ctx.fill();
            ctx.fillStyle='#ccaa66';
            ctx.beginPath();ctx.moveTo(this.x-s*0.22,dy+s*0.1);ctx.lineTo(this.x-s*0.4,dy-s*0.15);ctx.lineTo(this.x-s*0.15,dy+s*0.08);ctx.closePath();ctx.fill();
            ctx.beginPath();ctx.moveTo(this.x+s*0.22,dy+s*0.1);ctx.lineTo(this.x+s*0.4,dy-s*0.15);ctx.lineTo(this.x+s*0.15,dy+s*0.08);ctx.closePath();ctx.fill();
            ctx.fillStyle='#000'; ctx.beginPath(); ctx.arc(this.x-s*0.1,dy+s*0.22,s*0.09,0,Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.arc(this.x+s*0.1,dy+s*0.22,s*0.09,0,Math.PI*2); ctx.fill();
            ctx.fillStyle='#ff0000'; ctx.beginPath(); ctx.arc(this.x-s*0.1,dy+s*0.22,s*0.04,0,Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.arc(this.x+s*0.1,dy+s*0.22,s*0.04,0,Math.PI*2); ctx.fill();
            ctx.fillStyle='#663311'; ctx.fillRect(dx+s*0.18,dy+s*0.9,s*0.24,s*0.1); ctx.fillRect(dx+s*0.58,dy+s*0.9,s*0.24,s*0.1);

        } else if (this.type === 'monster' && this.monsterKind === 'shadow') {
            let s = this.size, tp=Date.now()/250;
            let alf = this.invisActive ? 0.15 : (0.5+0.25*Math.sin(tp));
            ctx.fillStyle='rgba(20,30,50,'+alf+')';
            ctx.beginPath(); ctx.ellipse(this.x,dy+s*0.5,s*0.45,s*0.55,0,0,Math.PI*2); ctx.fill();
            if(!this.invisActive){
                ctx.fillStyle='rgba(100,150,255,'+Math.min(1,alf*1.5)+')';
                ctx.beginPath(); ctx.arc(this.x-s*0.12,dy+s*0.32,s*0.09,0,Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.arc(this.x+s*0.12,dy+s*0.32,s*0.09,0,Math.PI*2); ctx.fill();
            }

        } else if (this.type === 'monster' && this.monsterKind === 'necromancer') {
            let s = this.size;
            ctx.fillStyle='#442266'; ctx.fillRect(dx+s*0.15,dy+s*0.3,s*0.7,s*0.65);
            ctx.fillStyle='#553388'; ctx.beginPath(); ctx.arc(this.x,dy+s*0.22,s*0.24,0,Math.PI*2); ctx.fill();
            ctx.strokeStyle='#886644'; ctx.lineWidth=3;
            ctx.beginPath();ctx.moveTo(dx+s*0.1,dy+s*0.4);ctx.lineTo(dx-s*0.05,dy);ctx.stroke();
            let orbP=0.4+0.3*Math.sin(Date.now()/200);
            ctx.fillStyle='rgba(200,50,255,'+orbP+')'; ctx.beginPath(); ctx.arc(dx-s*0.05,dy,s*0.14,0,Math.PI*2); ctx.fill();
            ctx.fillStyle='#cc44ff'; ctx.beginPath(); ctx.arc(this.x-s*0.1,dy+s*0.2,s*0.08,0,Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.arc(this.x+s*0.1,dy+s*0.2,s*0.08,0,Math.PI*2); ctx.fill();

        } else if (this.type === 'monster' && this.monsterKind === 'water_ele') {
            let s = this.size;
            ctx.fillStyle='rgba(30,100,255,0.7)'; ctx.beginPath(); ctx.arc(this.x,dy+s*0.5,s*0.44,0,Math.PI*2); ctx.fill();
            ctx.strokeStyle='rgba(100,200,255,0.6)'; ctx.lineWidth=2;
            for(let wi=0;wi<3;wi++){
                ctx.beginPath();
                let pts=[-0.3,-0.2,-0.1,0,0.1,0.2,0.3];
                pts.forEach((wx,pi)=>{if(pi===0)ctx.moveTo(this.x+s*wx,dy+s*(0.3+wi*0.12));else ctx.lineTo(this.x+s*wx,dy+s*(0.3+wi*0.12+0.06*Math.sin(Date.now()/300+wx*8)));});
                ctx.stroke();
            }
            ctx.fillStyle='#00ddff'; ctx.beginPath(); ctx.arc(this.x-s*0.12,dy+s*0.35,s*0.08,0,Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.arc(this.x+s*0.12,dy+s*0.35,s*0.08,0,Math.PI*2); ctx.fill();

        } else if (this.type === 'monster' && this.monsterKind === 'earth_ele') {
            let s = this.size;
            ctx.fillStyle='#776633';
            ctx.beginPath(); ctx.moveTo(this.x-s*0.38,dy+s*0.95); ctx.lineTo(this.x-s*0.45,dy+s*0.2); ctx.lineTo(this.x,dy); ctx.lineTo(this.x+s*0.45,dy+s*0.2); ctx.lineTo(this.x+s*0.38,dy+s*0.95); ctx.closePath(); ctx.fill();
            ctx.fillStyle='#aa9944';
            ctx.beginPath(); ctx.moveTo(this.x-s*0.25,dy+s*0.55); ctx.lineTo(this.x-s*0.3,dy+s*0.1); ctx.lineTo(this.x+s*0.3,dy+s*0.1); ctx.lineTo(this.x+s*0.25,dy+s*0.55); ctx.closePath(); ctx.fill();
            ctx.fillStyle='#ff6600'; ctx.beginPath(); ctx.arc(this.x-s*0.14,dy+s*0.28,s*0.1,0,Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.arc(this.x+s*0.14,dy+s*0.28,s*0.1,0,Math.PI*2); ctx.fill();

        } else if (this.type === 'monster' && this.monsterKind === 'air_ele') {
            let s = this.size, ta=Date.now()/200;
            let origA2 = ctx.globalAlpha;
            ctx.globalAlpha *= 0.75;
            ctx.save(); ctx.translate(this.x, dy+s*0.5); ctx.rotate(ta);
            for(let ai=0;ai<5;ai++){
                ctx.fillStyle='rgba(180,220,255,'+(0.35+0.15*Math.sin(ta+ai))+')';
                ctx.beginPath(); ctx.ellipse(s*0.3*Math.cos(ai*Math.PI*2/5),s*0.3*Math.sin(ai*Math.PI*2/5),s*0.18,s*0.1,ai*Math.PI*2/5,0,Math.PI*2); ctx.fill();
            }
            ctx.restore(); ctx.globalAlpha = origA2;
            ctx.fillStyle='rgba(200,240,255,0.5)'; ctx.beginPath(); ctx.arc(this.x,dy+s*0.5,s*0.15,0,Math.PI*2); ctx.fill();

        } else if (this.type === 'monster' && this.monsterKind === 'fire_ele') {
            let s = this.size, tf=Date.now()/150;
            ctx.fillStyle='#cc3300'; ctx.beginPath(); ctx.ellipse(this.x,dy+s*0.65,s*0.38,s*0.42,0,0,Math.PI*2); ctx.fill();
            for(let fi=0;fi<4;fi++){
                let fx2=this.x+s*(0.25*Math.cos(fi*Math.PI/2)+0.08*Math.sin(tf+fi));
                let fy2=dy+s*(0.25-0.18*Math.abs(Math.sin(tf*0.7+fi)));
                ctx.fillStyle='rgba(255,'+(180+fi*18)+',0,0.85)';
                ctx.beginPath(); ctx.arc(fx2,fy2,s*0.12,0,Math.PI*2); ctx.fill();
            }
            ctx.fillStyle='#ffdd00'; ctx.beginPath(); ctx.arc(this.x,dy+s*0.12,s*0.12,0,Math.PI*2); ctx.fill();

        } else if (this.type === 'monster' && this.monsterKind === 'lightning') {
            let s = this.size, tl=Date.now()/100;
            ctx.fillStyle='rgba(50,50,200,0.75)'; ctx.beginPath(); ctx.arc(this.x,dy+s*0.5,s*0.4,0,Math.PI*2); ctx.fill();
            ctx.strokeStyle='#ffff44'; ctx.lineWidth=2;
            for(let zi=0;zi<3;zi++){
                ctx.beginPath();
                let lx=this.x+s*(0.2*Math.sin(tl+zi*2)), ly=dy+s*0.1;
                ctx.moveTo(lx,ly);
                for(let seg=0;seg<4;seg++){lx+=s*(0.1*Math.sin(tl*2+seg+zi)); ly+=s*0.2; ctx.lineTo(lx,ly);}
                ctx.stroke();
            }
            ctx.fillStyle='#ffffff'; ctx.beginPath(); ctx.arc(this.x-s*0.12,dy+s*0.4,s*0.07,0,Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.arc(this.x+s*0.12,dy+s*0.4,s*0.07,0,Math.PI*2); ctx.fill();

        } else if (this.type === 'monster' && this.monsterKind === 'dark_knight') {
            let s = this.size;
            ctx.fillStyle='#112244'; ctx.fillRect(dx+s*0.12,dy+s*0.38,s*0.76,s*0.58);
            ctx.fillStyle='#223366'; ctx.fillRect(dx+s*0.18,dy+s*0.18,s*0.64,s*0.26);
            ctx.fillStyle='#1a2f55'; ctx.beginPath(); ctx.arc(this.x,dy+s*0.22,s*0.3,0,Math.PI*2); ctx.fill();
            ctx.fillStyle='#000'; ctx.fillRect(dx+s*0.18,dy+s*0.22,s*0.64,s*0.12);
            ctx.strokeStyle='#8899cc'; ctx.lineWidth=4;
            ctx.beginPath();ctx.moveTo(dx+s*0.85,dy+s*0.2);ctx.lineTo(dx+s*0.85,dy+s*0.9);ctx.stroke();
            ctx.strokeStyle='#554422'; ctx.lineWidth=8;
            ctx.beginPath();ctx.moveTo(dx+s*0.7,dy+s*0.48);ctx.lineTo(dx+s*1.0,dy+s*0.48);ctx.stroke();
            ctx.fillStyle='#ffdd00'; ctx.beginPath(); ctx.arc(this.x-s*0.1,dy+s*0.25,s*0.06,0,Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.arc(this.x+s*0.1,dy+s*0.25,s*0.06,0,Math.PI*2); ctx.fill();

        } else if (this.type === 'monster' && this.monsterKind === 'banshee') {
            let s = this.size, tb=Date.now()/350, pulseb=0.6+0.3*Math.sin(tb);
            ctx.fillStyle='rgba(120,160,200,'+pulseb+')';
            ctx.beginPath(); ctx.arc(this.x,dy+s*0.3,s*0.3,0,Math.PI*2); ctx.fill();
            ctx.fillStyle='rgba(100,140,180,0.4)';
            ctx.beginPath();ctx.moveTo(this.x-s*0.3,dy+s*0.3);ctx.quadraticCurveTo(this.x-s*0.45,dy+s*0.9,this.x,dy+s*1.0);ctx.quadraticCurveTo(this.x+s*0.45,dy+s*0.9,this.x+s*0.3,dy+s*0.3);ctx.closePath();ctx.fill();
            ctx.fillStyle='rgba(0,0,50,0.8)'; ctx.beginPath(); ctx.arc(this.x-s*0.1,dy+s*0.28,s*0.08,0,Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.arc(this.x+s*0.1,dy+s*0.28,s*0.08,0,Math.PI*2); ctx.fill();
            ctx.strokeStyle='rgba(0,0,40,0.8)'; ctx.lineWidth=2;
            ctx.beginPath(); ctx.arc(this.x,dy+s*0.38,s*0.08,0,Math.PI); ctx.stroke();

        } else if (this.type === 'monster' && this.monsterKind === 'lich') {
            let s = this.size;
            ctx.fillStyle='#220033'; ctx.fillRect(dx+s*0.18,dy+s*0.38,s*0.64,s*0.55);
            ctx.fillStyle='#6622aa'; ctx.beginPath(); ctx.arc(this.x,dy+s*0.26,s*0.26,0,Math.PI*2); ctx.fill();
            ctx.fillStyle='#aa8800';
            ctx.beginPath();ctx.moveTo(this.x-s*0.22,dy+s*0.08);ctx.lineTo(this.x-s*0.22,dy-s*0.06);ctx.lineTo(this.x-s*0.1,dy+s*0.02);ctx.lineTo(this.x,dy-s*0.1);ctx.lineTo(this.x+s*0.1,dy+s*0.02);ctx.lineTo(this.x+s*0.22,dy-s*0.06);ctx.lineTo(this.x+s*0.22,dy+s*0.08);ctx.closePath();ctx.fill();
            ctx.fillStyle='#ee44ff'; ctx.beginPath(); ctx.arc(this.x-s*0.1,dy+s*0.22,s*0.09,0,Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.arc(this.x+s*0.1,dy+s*0.22,s*0.09,0,Math.PI*2); ctx.fill();
            let lp=0.5+0.4*Math.sin(Date.now()/180);
            ctx.fillStyle='rgba(200,0,255,'+lp+')'; ctx.beginPath(); ctx.arc(this.x,dy+s*0.7,s*0.18,0,Math.PI*2); ctx.fill();

        } else if (this.type === 'monster' && this.monsterKind === 'abyss') {
            let s = this.size, tap2=Date.now()/400;
            ctx.fillStyle='rgba(5,0,15,0.95)'; ctx.beginPath(); ctx.arc(this.x,dy+s*0.5,s*0.48,0,Math.PI*2); ctx.fill();
            for(let ri=0;ri<3;ri++){
                ctx.strokeStyle='rgba(80,0,150,'+(0.6-ri*0.15)+')'; ctx.lineWidth=2;
                ctx.beginPath(); ctx.arc(this.x,dy+s*0.5,s*(0.15+ri*0.1)*(1+0.1*Math.sin(tap2+ri)),0,Math.PI*2); ctx.stroke();
            }
            ctx.fillStyle='rgba(150,0,255,0.8)'; ctx.beginPath(); ctx.arc(this.x-s*0.12,dy+s*0.38,s*0.09,0,Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.arc(this.x+s*0.12,dy+s*0.38,s*0.09,0,Math.PI*2); ctx.fill();
            if(this.absorbedHero){
                ctx.fillStyle='rgba(255,100,100,0.35)'; ctx.beginPath(); ctx.arc(this.x,dy+s*0.5,s*0.6,0,Math.PI*2); ctx.fill();
            }

        } else if (this.type === 'monster' && this.monsterKind === 'dragon') {
            let s = this.size, td=Date.now()/300;
            ctx.fillStyle='rgba(110,0,0,0.75)';
            ctx.beginPath();ctx.moveTo(this.x,dy+s*0.45);ctx.quadraticCurveTo(this.x-s*1.1,dy,this.x-s*0.65,dy+s*0.8);ctx.closePath();ctx.fill();
            ctx.beginPath();ctx.moveTo(this.x,dy+s*0.45);ctx.quadraticCurveTo(this.x+s*1.1,dy,this.x+s*0.65,dy+s*0.8);ctx.closePath();ctx.fill();
            ctx.fillStyle='#991100'; ctx.fillRect(dx+s*0.12,dy+s*0.38,s*0.76,s*0.58);
            ctx.fillStyle='#cc1100'; ctx.beginPath(); ctx.arc(this.x,dy+s*0.24,s*0.34,0,Math.PI*2); ctx.fill();
            ctx.fillStyle='#553300';
            ctx.beginPath();ctx.moveTo(this.x-s*0.22,dy+s*0.08);ctx.lineTo(this.x-s*0.38,dy-s*0.2);ctx.lineTo(this.x-s*0.12,dy+s*0.06);ctx.closePath();ctx.fill();
            ctx.beginPath();ctx.moveTo(this.x+s*0.22,dy+s*0.08);ctx.lineTo(this.x+s*0.38,dy-s*0.2);ctx.lineTo(this.x+s*0.12,dy+s*0.06);ctx.closePath();ctx.fill();
            ctx.fillStyle='#ffcc00'; ctx.beginPath(); ctx.arc(this.x-s*0.14,dy+s*0.2,s*0.12,0,Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.arc(this.x+s*0.14,dy+s*0.2,s*0.12,0,Math.PI*2); ctx.fill();
            ctx.fillStyle='#ff3300'; ctx.beginPath(); ctx.arc(this.x-s*0.14,dy+s*0.2,s*0.06,0,Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.arc(this.x+s*0.14,dy+s*0.2,s*0.06,0,Math.PI*2); ctx.fill();
            if((this.breathCooldown||480) < 12 || (this.breathCooldown||480) >= 470){
                let breathA=0.4+0.4*Math.sin(td*4);
                ctx.fillStyle='rgba(255,100,0,'+breathA+')'; ctx.beginPath(); ctx.arc(this.x,dy+s*0.44,s*0.5,0,Math.PI*2); ctx.fill();
            }

        } else if (this.type === 'monster') {
            // Fallback â€” Ğ¿Ñ€Ğ¾ÑÑ‚Ğµ ĞºĞ¾Ğ»Ğ¾
            let s = this.size;
            ctx.fillStyle = this.color || '#888';
            ctx.beginPath(); ctx.arc(this.x, dy+s*0.5, s*0.4, 0, Math.PI*2); ctx.fill();
            ctx.fillStyle='#000'; ctx.beginPath(); ctx.arc(this.x-s*0.1,dy+s*0.4,s*0.07,0,Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.arc(this.x+s*0.1,dy+s*0.4,s*0.07,0,Math.PI*2); ctx.fill();

        } else if (this.type === 'hero') {
            let s = this.size;
            let rank = this.heroRank || 'normal';
            let lv   = this.level || 1;

            // ĞšĞ¾Ğ»ÑŒĞ¾Ñ€Ğ¸ Ğ· Ñ‚Ğ¸Ğ¿Ñƒ Ğ³ĞµÑ€Ğ¾Ñ (Ğ°Ğ±Ğ¾ overrides Ğ´Ğ»Ñ ĞµĞ»Ñ–Ñ‚Ñ–Ğ²/Ğ±Ğ¾ÑÑ–Ğ²)
            let cloakCol  = this.heroCloakCol  || '#661122';
            let bodyCol   = this.heroBodyCol   || '#cc2233';
            let helmetCol = this.heroHelmetCol || '#666677';
            if (rank === 'elite_hp')  { cloakCol='#115533'; bodyCol='#22aa66'; helmetCol='#44cc88'; }
            if (rank === 'elite_atk') { cloakCol='#883300'; bodyCol='#ee6600'; helmetCol='#ffaa44'; }
            if (rank === 'boss')      { cloakCol='#550066'; bodyCol='#aa00cc'; helmetCol='#cc88ff'; }

            // ĞŸĞ»Ğ°Ñ‰
            ctx.fillStyle = cloakCol;
            ctx.beginPath(); ctx.moveTo(this.x, dy + s*0.3); ctx.lineTo(this.x - s*0.45, dy + s); ctx.lineTo(this.x + s*0.45, dy + s); ctx.closePath(); ctx.fill();

            // Ğ¢Ñ–Ğ»Ğ¾
            ctx.fillStyle = bodyCol;
            ctx.fillRect(dx + s*0.22, dy + s*0.42, s*0.56, s*0.42);

            // Ğ¨Ğ¾Ğ»Ğ¾Ğ¼
            ctx.fillStyle = helmetCol;
            ctx.beginPath(); ctx.arc(this.x, dy + s*0.27, s*0.27, 0, Math.PI*2); ctx.fill();
            ctx.fillStyle = '#333344';
            ctx.fillRect(dx + s*0.08, dy + s*0.3, s*0.84, s*0.1);

            // Ğ—Ğ±Ñ€Ğ¾Ñ Ğ¿Ğ¾ Ñ‚Ğ¸Ğ¿Ñƒ
            let wpn = this.heroWeapon || 'sword';
            ctx.lineWidth = lv >= 7 ? 3 : 2;
            if (wpn === 'sword') {
                ctx.strokeStyle = lv >= 8 ? '#aaeeff' : '#aaaaaa';
                ctx.beginPath(); ctx.moveTo(dx + s*1.0, dy + s*0.15); ctx.lineTo(dx + s*0.85, dy + s*0.72); ctx.stroke();
                // Ğ“Ğ°Ñ€Ğ´Ğ°
                ctx.strokeStyle = '#888'; ctx.lineWidth = 2;
                ctx.beginPath(); ctx.moveTo(dx + s*0.78, dy + s*0.5); ctx.lineTo(dx + s*1.05, dy + s*0.5); ctx.stroke();
            } else if (wpn === 'spear') {
                ctx.strokeStyle = '#88ccff';
                ctx.beginPath(); ctx.moveTo(dx + s*1.0, dy + s*0.02); ctx.lineTo(dx + s*0.85, dy + s*0.78); ctx.stroke();
                // Ğ’Ñ–ÑÑ‚Ñ€Ñ
                ctx.fillStyle = '#cceeff';
                ctx.beginPath(); ctx.moveTo(dx + s*1.0, dy + s*0.02); ctx.lineTo(dx + s*0.9, dy + s*0.18); ctx.lineTo(dx + s*1.08, dy + s*0.18); ctx.closePath(); ctx.fill();
            } else if (wpn === 'staff') {
                ctx.strokeStyle = '#cc88ff'; ctx.lineWidth = 2;
                ctx.beginPath(); ctx.moveTo(dx + s*1.0, dy + s*0.15); ctx.lineTo(dx + s*0.85, dy + s*0.85); ctx.stroke();
                let glow2 = 0.5 + 0.5*Math.sin(Date.now()/300);
                ctx.fillStyle = `rgba(180,100,255,${glow2})`;
                ctx.beginPath(); ctx.arc(dx + s*1.0, dy + s*0.1, s*0.1, 0, Math.PI*2); ctx.fill();
            } else if (wpn === 'axe') {
                ctx.strokeStyle = '#ff6644'; ctx.lineWidth = 2;
                ctx.beginPath(); ctx.moveTo(dx + s*1.0, dy + s*0.2); ctx.lineTo(dx + s*0.85, dy + s*0.75); ctx.stroke();
                ctx.fillStyle = '#cc4422';
                ctx.beginPath(); ctx.moveTo(dx + s*0.9, dy + s*0.2); ctx.lineTo(dx + s*1.12, dy + s*0.12); ctx.lineTo(dx + s*1.08, dy + s*0.38); ctx.closePath(); ctx.fill();
            } else if (wpn === 'dagger') {
                ctx.strokeStyle = '#88ffcc'; ctx.lineWidth = 1.5;
                ctx.beginPath(); ctx.moveTo(dx + s*1.0, dy + s*0.25); ctx.lineTo(dx + s*0.9, dy + s*0.6); ctx.stroke();
                ctx.beginPath(); ctx.moveTo(dx + s*0.78, dy + s*0.45); ctx.lineTo(dx + s*1.05, dy + s*0.38); ctx.stroke();
            }

            // ĞÑ‡Ñ–
            ctx.fillStyle = '#ffeecc';
            ctx.fillRect(this.x - s*0.12, dy + s*0.27, s*0.08, s*0.07);
            ctx.fillRect(this.x + s*0.04, dy + s*0.27, s*0.08, s*0.07);

            // Ğ†ĞºĞ¾Ğ½ĞºĞ° Ğ¿Ğ°ÑĞ¸Ğ²Ñƒ (Ğ¼Ğ°Ğ»ĞµĞ½ÑŒĞºĞ°, Ğ¿Ñ–Ğ´ HP Ğ±Ğ°Ñ€Ğ¾Ğ¼)
            const PASSIVE_ICONS = {
                toughness:'ğŸ›¡', swift:'ğŸ’¨', armor:'âš”', spellburn:'ğŸ”¥',
                holyaura:'âœ¨', rage:'ğŸ’¢', firstblood:'ğŸ—¡', warcry:'ğŸ“¯', unstoppable:'ğŸ‘'
            };
            if (this.heroPassive && PASSIVE_ICONS[this.heroPassive]) {
                ctx.font = '8px Arial'; ctx.textAlign = 'center';
                ctx.fillText(PASSIVE_ICONS[this.heroPassive], this.x + s*0.55, dy + s*0.08);
            }

            // ĞĞ°Ğ·Ğ²Ğ° Ñ‚Ğ¸Ğ¿Ñƒ (Ğ¼Ğ°Ğ»ĞµĞ½ÑŒĞºĞ°, Ğ½Ğ°Ğ´ Ğ³Ğ¾Ğ»Ğ¾Ğ²Ğ¾Ñ)
            if (this.heroLabel) {
                ctx.fillStyle = 'rgba(255,220,180,0.85)';
                ctx.font = '7px Arial'; ctx.textAlign = 'center';
                ctx.fillText(this.heroLabel, this.x, dy - 2);
            }

        } else if (this.type === 'lord') {
            // ĞŸĞ¾Ğ²Ğ½Ğ° Ñ‚ĞµĞºÑÑ‚ÑƒÑ€Ğ° Ğ›Ğ¾Ñ€Ğ´Ğ°
            let s = this.size; // 40
            // Ğ¢ĞµĞ¼Ğ½Ğ° Ğ°ÑƒÑ€Ğ° Ğ½Ğ°Ğ²ĞºĞ¾Ğ»Ğ¾
            let lordAura = ctx.createRadialGradient(this.x, dy + s*0.5, 5, this.x, dy + s*0.5, s*1.1);
            lordAura.addColorStop(0, 'rgba(160,0,255,0.25)');
            lordAura.addColorStop(1, 'rgba(80,0,160,0)');
            ctx.fillStyle = lordAura;
            ctx.beginPath(); ctx.arc(this.x, dy + s*0.5, s*1.1, 0, Math.PI*2); ctx.fill();
            // ĞœĞ°Ğ½Ñ‚Ñ–Ñ
            ctx.fillStyle = '#3d0066';
            ctx.beginPath(); ctx.moveTo(this.x, dy + s*0.3); ctx.lineTo(this.x - s*0.7, dy + s*1.05); ctx.lineTo(this.x + s*0.7, dy + s*1.05); ctx.closePath(); ctx.fill();
            ctx.fillStyle = '#280044';
            ctx.beginPath(); ctx.moveTo(this.x - s*0.25, dy + s*0.55); ctx.lineTo(this.x - s*0.7, dy + s*1.05); ctx.lineTo(this.x, dy + s*1.05); ctx.closePath(); ctx.fill();
            // Ğ¢Ñ–Ğ»Ğ¾ Ğ² Ğ¾Ğ±Ğ»Ğ°Ğ´ÑƒĞ½ĞºÑƒ
            ctx.fillStyle = '#551188';
            ctx.fillRect(this.x - s*0.28, dy + s*0.42, s*0.56, s*0.46);
            let armorGrad = ctx.createLinearGradient(this.x - s*0.25, dy + s*0.45, this.x + s*0.25, dy + s*0.45);
            armorGrad.addColorStop(0,   '#7700cc');
            armorGrad.addColorStop(0.4, '#aa44ff');
            armorGrad.addColorStop(1,   '#6600bb');
            ctx.fillStyle = armorGrad;
            ctx.fillRect(this.x - s*0.24, dy + s*0.44, s*0.48, s*0.38);
            ctx.strokeStyle = '#cc88ff'; ctx.lineWidth = 1;
            ctx.strokeRect(this.x - s*0.2, dy + s*0.47, s*0.4, s*0.28);
            ctx.beginPath(); ctx.moveTo(this.x, dy + s*0.47); ctx.lineTo(this.x, dy + s*0.75); ctx.stroke();
            // Ğ“Ğ¾Ğ»Ğ¾Ğ²Ğ°
            let headGrad = ctx.createRadialGradient(this.x - 4, dy + s*0.22, 2, this.x, dy + s*0.27, s*0.3);
            headGrad.addColorStop(0, '#cc66ff');
            headGrad.addColorStop(1, '#660099');
            ctx.fillStyle = headGrad;
            ctx.beginPath(); ctx.arc(this.x, dy + s*0.27, s*0.29, 0, Math.PI*2); ctx.fill();
            // ĞšĞ¾Ñ€Ğ¾Ğ½Ğ°
            ctx.fillStyle = '#ffcc00';
            ctx.fillRect(this.x - s*0.28, dy + s*0.06, s*0.56, s*0.1);
            let crownX = this.x - s*0.26;
            for (let c = 0; c < 5; c++) {
                let bx = crownX + c * s*0.13;
                let bh = (c % 2 === 0) ? s*0.16 : s*0.1;
                ctx.fillRect(bx, dy + s*0.06 - bh, s*0.1, bh);
            }
            ctx.fillStyle = '#ff2244';
            ctx.beginPath(); ctx.arc(this.x, dy + s*0.06 - s*0.11, s*0.05, 0, Math.PI*2); ctx.fill();
            ctx.fillStyle = '#44aaff';
            ctx.beginPath(); ctx.arc(this.x - s*0.26, dy + s*0.06 - s*0.11, s*0.04, 0, Math.PI*2); ctx.fill();
            ctx.beginPath(); ctx.arc(this.x + s*0.26, dy + s*0.06 - s*0.11, s*0.04, 0, Math.PI*2); ctx.fill();
            // ĞÑ‡Ñ–
            ctx.fillStyle = '#ddaaff';
            ctx.beginPath(); ctx.arc(this.x - s*0.12, dy + s*0.25, s*0.09, 0, Math.PI*2); ctx.fill();
            ctx.beginPath(); ctx.arc(this.x + s*0.12, dy + s*0.25, s*0.09, 0, Math.PI*2); ctx.fill();
            ctx.fillStyle = '#aa00ff';
            ctx.beginPath(); ctx.arc(this.x - s*0.12, dy + s*0.25, s*0.05, 0, Math.PI*2); ctx.fill();
            ctx.beginPath(); ctx.arc(this.x + s*0.12, dy + s*0.25, s*0.05, 0, Math.PI*2); ctx.fill();
            // Ğ‘Ğ¾Ñ€Ğ¾Ğ´Ğ°
            ctx.fillStyle = '#8844aa';
            ctx.beginPath(); ctx.moveTo(this.x - s*0.18, dy + s*0.37); ctx.quadraticCurveTo(this.x, dy + s*0.55, this.x + s*0.18, dy + s*0.37); ctx.quadraticCurveTo(this.x, dy + s*0.48, this.x - s*0.18, dy + s*0.37); ctx.closePath(); ctx.fill();
            // ĞŸĞ¾ÑĞ¾Ñ…
            ctx.strokeStyle = '#cc8800'; ctx.lineWidth = 3;
            ctx.beginPath(); ctx.moveTo(this.x + s*0.65, dy + s*0.4); ctx.lineTo(this.x + s*0.65, dy + s*1.05); ctx.stroke();
            let gemGlow = 0.5 + 0.5*Math.sin(Date.now()/400);
            ctx.fillStyle = 'rgba(200,100,255,' + gemGlow + ')';
            ctx.beginPath(); ctx.arc(this.x + s*0.65, dy + s*0.3, s*0.13, 0, Math.PI*2); ctx.fill();
            ctx.strokeStyle = '#ffaaff'; ctx.lineWidth = 1.5;
            ctx.stroke();

        } else {
            // Ğ”ĞµÑ„Ğ¾Ğ»Ñ‚ fallback
            ctx.fillStyle = this.color;
            ctx.fillRect(dx, dy, this.size, this.size);
            ctx.fillStyle = '#fff';
            ctx.font = 'bold ' + Math.floor(this.size * 0.65) + 'px Arial';
            ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
            ctx.fillText(this.level, this.x, dy + this.size/2);
            ctx.textBaseline = 'alphabetic';
        }

        // â”€â”€ HP Ğ±Ğ°Ñ€ Ğ· Ğ³Ñ€Ğ°Ğ´Ñ–Ñ”Ğ½Ñ‚Ğ¾Ğ¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        ctx.shadowBlur = 0;
        let pct = Math.max(0, this.hp / this.maxHp);
        let _isLord = this.type === 'lord';
        let _bw = _isLord ? 44 : 30, _bh = _isLord ? 6 : 4;
        let _bx = this.x - _bw / 2;
        // Ğ¤Ğ¾Ğ½
        ctx.fillStyle = '#220000'; ctx.fillRect(_bx, dy - 11, _bw, _bh + 1);
        // Ğ—Ğ°Ğ¿Ğ¾Ğ²Ğ½ĞµĞ½Ğ½Ñ Ğ· Ğ³Ñ€Ğ°Ğ´Ñ–Ñ”Ğ½Ñ‚Ğ¾Ğ¼ (Ğ·ĞµĞ»ĞµĞ½Ğ¸Ğ¹â†’Ğ¶Ğ¾Ğ²Ñ‚Ğ¸Ğ¹â†’Ñ‡ĞµÑ€Ğ²Ğ¾Ğ½Ğ¸Ğ¹)
        if (pct > 0) {
            let _hg = ctx.createLinearGradient(_bx, 0, _bx + _bw, 0);
            if (pct > 0.55) { _hg.addColorStop(0,'#1a9e1a'); _hg.addColorStop(1,'#44ff44'); }
            else if (pct > 0.28) { _hg.addColorStop(0,'#bb7700'); _hg.addColorStop(1,'#ffcc00'); }
            else { _hg.addColorStop(0,'#bb1100'); _hg.addColorStop(1,'#ff3300'); }
            if (_isLord) { _hg = ctx.createLinearGradient(_bx,0,_bx+_bw,0); _hg.addColorStop(0,'#7700bb'); _hg.addColorStop(1,pct>0.5?'#cc44ff':'#ff44cc'); }
            ctx.fillStyle = _hg;
            ctx.fillRect(_bx, dy - 11, _bw * pct, _bh + 1);
        }
        // Ğ’Ñ–Ğ´Ğ±Ğ»Ğ¸ÑĞº Ğ·Ğ²ĞµÑ€Ñ…Ñƒ
        ctx.fillStyle = 'rgba(255,255,255,0.18)'; ctx.fillRect(_bx, dy - 11, _bw * pct, 2);

        // Ğ†ĞºĞ¾Ğ½ĞºĞ° Ñ€Ğ°Ğ½Ğ³Ñƒ (Ğ³ĞµÑ€Ğ¾Ñ—)
        ctx.font = '10px Arial'; ctx.textAlign = 'center';
        if (this.heroRank === 'elite_hp')       ctx.fillText('ğŸ’š', this.x, dy - 12);
        else if (this.heroRank === 'elite_atk') ctx.fillText('ğŸ”¥', this.x, dy - 12);
        else if (this.heroRank === 'boss')      ctx.fillText('â˜ ï¸', this.x, dy - 14);

        // Ğ•Ğ¼Ğ¾Ğ´Ğ·Ñ– Ğ²Ğ¸Ğ´Ñƒ Ğ¼Ğ¾Ğ½ÑÑ‚Ñ€Ğ° Ğ½Ğ°Ğ´ Ğ³Ğ¾Ğ»Ğ¾Ğ²Ğ¾Ñ
        if (this.type === 'monster' && this.monsterEmoji) {
            ctx.font = '11px Arial';
            ctx.fillText(this.monsterEmoji, this.x, dy - 12);
        }

    }
}

// =================== Ğ†ĞĞ†Ğ¦Ğ†ĞĞ›Ğ†Ğ—ĞĞ¦Ğ†Ğ¯ ===================
function init() {
    resize();
    // iOS Safari Ñ€ĞµĞ½Ğ´ĞµÑ€Ğ¸Ñ‚ÑŒ flex Ğ¿Ñ–ÑĞ»Ñ JS â€” Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€Ğ½Ğ¸Ğ¹ resize Ğ²Ğ¸Ğ¿Ñ€Ğ°Ğ²Ğ»ÑÑ” Ğ²Ğ¸ÑĞ¾Ñ‚Ñƒ canvas
    setTimeout(resize, 50);
    setTimeout(resize, 200);
    setTimeout(resize, 600);
    setTimeout(resize, 1500);
    window.addEventListener('resize', resize);

    let saved = _store.get('DLSiege_v3');
    if (saved) {
        try {
            let d = JSON.parse(saved);
            GAME = Object.assign(GAME, d.game);
            GAME.eliteChance     = Math.min(GAME.eliteChance, 100);
            GAME.captainChance   = Math.min(GAME.captainChance, 100);
            GAME.extraHeroChance = Math.min(GAME.extraHeroChance, 100);
            floors = [];
            d.floors.forEach(fd => {
                let f = new Floor(fd.depth);
                f.hasTrap = fd.hasTrap || false;
                f.trapType = fd.trapType || null;
                f.maxMonsters = fd.maxMonsters || 2;
                f.floorUpgradeCost = fd.floorUpgradeCost || 60;
                floors.push(f);
            });
            // Ğ„ Ğ·Ğ±ĞµÑ€ĞµĞ¶ĞµĞ½Ğ½Ñ â€” Ğ¿Ğ¾Ğ²Ğ½Ñ–ÑÑ‚Ñ Ğ¿Ñ€Ğ¸Ğ±Ğ¸Ñ€Ğ°Ñ”Ğ¼Ğ¾ ÑÑ‚Ğ°Ñ€Ñ‚Ğ¾Ğ²Ğ¸Ğ¹ ĞµĞºÑ€Ğ°Ğ½ Ğ· DOM
            let ss = document.getElementById('start-screen');
            if (ss) ss.parentNode.removeChild(ss);
            beginGame();
        } catch(e) { hardReset(); return; }
    }
    // Ğ¯ĞºÑ‰Ğ¾ Ğ½ĞµĞ¼Ğ°Ñ” Ğ·Ğ±ĞµÑ€ĞµĞ¶ĞµĞ½Ğ½Ñ â€” ÑÑ‚Ğ°Ñ€Ñ‚Ğ¾Ğ²Ğ¸Ğ¹ ĞµĞºÑ€Ğ°Ğ½ Ğ²Ğ¶Ğµ Ğ²Ğ¸Ğ´Ğ¸Ğ¼Ğ¸Ğ¹, Ñ‡ĞµĞºĞ°Ñ”Ğ¼Ğ¾ Ğ½Ğ°Ñ‚Ğ¸ÑĞºĞ°Ğ½Ğ½Ñ
}

function startGame(diff) {
    const DIFFS = {
        1: { cityHP: 2000,  heroScale: 0,  maxThreat: 20 },
        2: { cityHP: 4000,  heroScale: 10, maxThreat: 40 },
        3: { cityHP: 8000,  heroScale: 20, maxThreat: 60 },
        4: { cityHP: 15000, heroScale: 30, maxThreat: 80 },
    };
    let d = DIFFS[diff] || DIFFS[1];
    GAME.cityHP = d.cityHP;
    GAME.maxCityHP = d.cityHP;
    GAME.heroScalePercent = d.heroScale;
    GAME.maxThreatLevel = d.maxThreat;
    document.getElementById('threat-cap-input').value = d.maxThreat;

    floors.push(new Floor(0));
    floors.push(new Floor(1));
    GAME.souls = 150;

    let ss = document.getElementById('start-screen');
    if (ss) ss.parentNode.removeChild(ss);
    beginGame();
}

function beginGame() {
    if (!units.some(u => u.type === 'lord')) spawnLord();
    resize(); // Ğ¿Ñ€Ğ¸Ğ¼ÑƒÑĞ¾Ğ²Ğ¾ Ğ¿ĞµÑ€ĞµÑ€Ğ°Ñ…Ğ¾Ğ²ÑƒÑ”Ğ¼Ğ¾ Ñ€Ğ¾Ğ·Ğ¼Ñ–Ñ€Ğ¸ canvas Ğ¿ĞµÑ€ĞµĞ´ Ğ¿ĞµÑ€ÑˆĞ¸Ğ¼ ĞºĞ°Ğ´Ñ€Ğ¾Ğ¼
    GAME.gameStarted = true;
    loop();
    scheduleNextEnemy();
    setInterval(spawnMinions, 1000);
}

function spawnLord() {
    units = units.filter(u => u.type !== 'lord');
    let last = floors[floors.length-1];
    units.push(new Unit('lord', centerX, last.y, floors.length-1));
}

// =================== Ğ¡ĞŸĞĞ’Ğ Ğ“Ğ•Ğ ĞĞ‡Ğ’ ===================
function scheduleNextEnemy() {
    if (GAME.gameOver) return;
    // 6 ÑĞµĞº Ğ±Ğ°Ğ·Ğ¾Ğ²Ğ¾ + 2.5 ÑĞµĞº Ğ·Ğ° ĞºĞ¾Ğ¶ĞµĞ½ Ğ¿Ğ¾Ğ²ĞµÑ€Ñ… Ğ· Ğ¼Ğ¾Ğ½ÑÑ‚Ñ€Ğ°Ğ¼Ğ¸
    let monsterFloors = Math.max(1, floors.length - 1);
    let delay = (6 + (monsterFloors - 1) * 2.5) * 1000;
    setTimeout(() => {
        // Ğ¯ĞºÑ‰Ğ¾ Ğ³Ñ€Ğ° Ğ½Ğ° Ğ¿Ğ°ÑƒĞ·Ñ– â€” Ñ‡ĞµĞºĞ°Ñ”Ğ¼Ğ¾ Ğ²Ğ¸Ñ…Ğ¾Ğ´Ñƒ Ğ· Ğ¿Ğ°ÑƒĞ·Ğ¸, Ğ¿Ğ¾Ñ‚Ñ–Ğ¼ ÑĞ¿Ğ°Ğ²Ğ½Ğ¸Ğ¼Ğ¾
        if (GAME_PAUSED) {
            let waitPause = setInterval(() => {
                if (!GAME_PAUSED) {
                    clearInterval(waitPause);
                    spawnEnemy();
                    scheduleNextEnemy();
                }
            }, 200);
        } else {
            spawnEnemy();
            scheduleNextEnemy();
        }
    }, delay);
}

function spawnEnemy() {
    if (GAME.gameOver) return;
    GAME.waveCount++;

    // ĞšÑ–Ğ»ÑŒĞºÑ–ÑÑ‚ÑŒ Ğ¿Ğ¾Ğ²ĞµÑ€Ñ…Ñ–Ğ² Ğ· Ğ¼Ğ¾Ğ½ÑÑ‚Ñ€Ğ°Ğ¼Ğ¸ (Ğ²ÑÑ– ĞºÑ€Ñ–Ğ¼ Ğ¿Ğ¾Ğ²ĞµÑ€Ñ…Ñƒ Ğ»Ğ¾Ñ€Ğ´Ğ°)
    let monsterFloors = Math.max(1, floors.length - 1);

    // ĞšÑ–Ğ»ÑŒĞºÑ–ÑÑ‚ÑŒ Ğ³ĞµÑ€Ğ¾Ñ—Ğ²: 1 Ğ¿Ğ¾Ğ²ĞµÑ€Ñ… = Ğ·Ğ°Ğ²Ğ¶Ğ´Ğ¸ 1; 2+ Ğ¿Ğ¾Ğ²ĞµÑ€Ñ…Ñ–Ğ² = Ğ²Ñ–Ğ´ 1 Ğ´Ğ¾ monsterFloors Ñ€Ñ–Ğ²Ğ½Ğ¾Ğ¼Ñ–Ñ€Ğ½Ğ¾
    let heroCount = 1;
    if (monsterFloors >= 2) {
        heroCount = 1 + Math.floor(Math.random() * monsterFloors);
    }

    // Ğ‘Ğ¾Ğ½ÑƒÑ Ğ²Ñ–Ğ´ Ñ€Ñ–Ğ²Ğ½Ñ Ğ·Ğ°Ğ³Ñ€Ğ¾Ğ·Ğ¸ (+2% Ğ·Ğ° Ñ€Ñ–Ğ²ĞµĞ½ÑŒ, Ğ¼Ğ°ĞºÑ 60%) â€” Ğ¾Ğ´Ğ¸Ğ½ ÑˆĞ°Ğ½Ñ Ğ½Ğ° +1 Ğ³ĞµÑ€Ğ¾Ñ
    if (GAME.extraHeroChance > 0 && Math.random() * 100 < GAME.extraHeroChance) {
        heroCount++;
    }

    // ĞĞ±Ğ¼ĞµĞ¶ĞµĞ½Ğ½Ñ: Ğ½Ğµ Ğ±Ñ–Ğ»ÑŒÑˆĞµ ĞºÑ–Ğ»ÑŒĞºĞ¾ÑÑ‚Ñ– Ğ¿Ğ¾Ğ²ĞµÑ€Ñ…Ñ–Ğ² Ğ· Ğ¼Ğ¾Ğ½ÑÑ‚Ñ€Ğ°Ğ¼Ğ¸
    heroCount = Math.min(heroCount, monsterFloors);
    heroCount = Math.max(1, heroCount);

    for (let i = 0; i < heroCount; i++) {
        // Ğ—Ğ²Ğ°Ğ¶ĞµĞ½Ğ¸Ğ¹ Ñ€Ğ°Ğ½Ğ´Ğ¾Ğ¼ Ñ€Ñ–Ğ²Ğ½Ñ: Ğ²Ğ¸Ñ‰Ñ– Ñ€Ñ–Ğ²Ğ½Ñ– Ğ¼Ğ°ÑÑ‚ÑŒ Ğ±Ñ–Ğ»ÑŒÑˆĞ¸Ğ¹ ÑˆĞ°Ğ½Ñ
        // Ğ’Ğ°Ğ³Ğ¸: Ñ€Ñ–Ğ²ĞµĞ½ÑŒ 1 = 1, Ñ€Ñ–Ğ²ĞµĞ½ÑŒ 2 = 2, ..., Ñ€Ñ–Ğ²ĞµĞ½ÑŒ N = N (Ñ‚Ñ€Ğ¸ĞºÑƒÑ‚Ğ½Ğ¸Ğ¹ Ñ€Ğ¾Ğ·Ğ¿Ğ¾Ğ´Ñ–Ğ»)
        let totalWeight = monsterFloors * (monsterFloors + 1) / 2;
        let roll = Math.random() * totalWeight;
        let level = 1;
        let cumulative = 0;
        for (let lv = 1; lv <= monsterFloors; lv++) {
            cumulative += lv;
            if (roll < cumulative) { level = lv; break; }
        }
        // Ğ“ĞµÑ€Ğ¾Ñ— ÑĞ¿Ğ°Ğ²Ğ½ÑÑ‚ÑŒÑÑ Ğ· Ğ²Ğ¾Ñ€Ñ–Ñ‚ Ğ¼Ñ–ÑÑ‚Ğ°
        let hero = new Unit('hero', CITY_GATE_X + i*10, CFG.surfaceY, -1, level);
        let r = Math.random() * 100;
        if (r < GAME.captainChance)                          makeEliteAtk(hero);
        else if (r < GAME.captainChance + GAME.eliteChance)  makeEliteHp(hero);
        units.push(hero);
    }

    // Ğ‘Ğ¾ÑĞ¸ Ğ·Ğ° HP Ğ¼Ñ–ÑÑ‚Ğ°
    checkCityBoss();
}

function checkCityBoss() {
    let pct = GAME.cityHP / GAME.maxCityHP * 100;
    let monsterFloors = Math.max(1, floors.length - 1);
    let bossLevel = monsterFloors; // Ğ¼Ğ°ĞºÑĞ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¸Ğ¹ Ñ€Ñ–Ğ²ĞµĞ½ÑŒ

    if (!GAME.bossSent75 && pct < 75) {
        GAME.bossSent75 = true;
        spawnBoss(bossLevel, 3);
    }
    if (!GAME.bossSent50 && pct < 50) {
        GAME.bossSent50 = true;
        spawnBoss(bossLevel, 4);
    }
    if (!GAME.bossSent20 && pct < 20) {
        GAME.bossSent20 = true;
        spawnBoss(bossLevel, 5);
    }
}

function spawnBoss(level, mult) {
    let boss = new Unit('hero', CITY_GATE_X, CFG.surfaceY, -1, level);
    boss.hp *= mult; boss.maxHp = boss.hp;
    boss.dmg *= mult;
    boss.speed *= 0.85;
    boss.heroRank = 'boss';
    boss.color = '#cc00cc';
    boss.size = 34 + mult * 2;
    boss.soulReward = 30 * mult;
    units.push(boss);
}

function makeEliteHp(hero) {
    hero.heroRank = 'elite_hp';
    hero.hp *= 2; hero.maxHp = hero.hp;
    hero.color = '#33cc88';
    hero.size = 24;
    hero.soulReward = 25;
}

function makeEliteAtk(hero) {
    hero.heroRank = 'elite_atk';
    hero.dmg *= 2;
    hero.color = '#ff6600';
    hero.size = 24;
    hero.soulReward = 25;
}

// =================== Ğ¡ĞŸĞĞ’Ğ ĞœĞĞĞ¡Ğ¢Ğ Ğ†Ğ’ ===================
function spawnMinions() {
    if (GAME.gameOver || GAME_PAUSED) return;
    let lordFloor = floors.length - 1;
    floors.forEach(f => {
        if (f.depth === lordFloor) return;
        let count = units.filter(u => u.type==='monster' && u.floorIdx===f.depth).length;
        if (count < f.maxMonsters) {
            // 1-Ğ¹ Ğ¿Ğ¾Ğ²ĞµÑ€Ñ…: 4 ÑĞµĞº, ĞºĞ¾Ğ¶ĞµĞ½ Ğ½Ğ°ÑÑ‚ÑƒĞ¿Ğ½Ğ¸Ğ¹ +3 ÑĞµĞº (Ğ² Ñ‚Ñ–ĞºĞ°Ñ… Ğ¿Ğ¾ 1 ÑĞµĞº)
            let spawnInterval = 4 + f.depth * 3;
            f.spawnTimer++;
            if (f.spawnTimer >= spawnInterval) {
                units.push(new Unit('monster', centerX, f.y, f.depth, f.depth + 1));
                f.spawnTimer = 0;
            }
        }
    });
}

// =================== Ğ“ĞĞ›ĞĞ’ĞĞ˜Ğ™ Ğ¦Ğ˜ĞšĞ› ===================
let heroScaleTimer = 0;

function loop() {
    if (GAME_PAUSED || GAME.gameOver) return;

    // Ğ¢Ğ°Ğ¹Ğ¼ĞµÑ€ ÑĞºĞ»Ğ°Ğ´Ğ½Ğ¾ÑÑ‚Ñ–
    heroScaleTimer++;
    if (heroScaleTimer >= 60) {
        heroScaleTimer = 0;
        GAME.gameTime++;
        if (GAME.gameTime % 60 === 0) { // ĞºĞ¾Ğ¶Ğ½Ñ– 60 ÑĞµĞº
            // Ğ Ñ–Ğ²ĞµĞ½ÑŒ Ğ·Ğ°Ğ³Ñ€Ğ¾Ğ·Ğ¸ Ğ·Ñ€Ğ¾ÑÑ‚Ğ°Ñ” Ñ‚Ñ–Ğ»ÑŒĞºĞ¸ Ğ´Ğ¾ maxThreatLevel
            if (GAME.difficultyLevel < GAME.maxThreatLevel) {
                GAME.difficultyLevel++;
                GAME.eliteChance   = Math.min(100, GAME.eliteChance + 1);
                GAME.captainChance = Math.min(100, GAME.captainChance + 1);
            }
            // extraHeroChance Ñ– heroScalePercent Ñ‚ĞµĞ¶ Ğ¾Ğ±Ğ¼ĞµĞ¶ĞµĞ½Ñ– Ñ€Ñ–Ğ²Ğ½ĞµĞ¼ ÑĞºĞ»Ğ°Ğ´Ğ½Ğ¾ÑÑ‚Ñ–
            GAME.extraHeroChance = Math.min(100, GAME.difficultyLevel * 4);
            let maxScalePercent  = GAME.maxThreatLevel * 4;
            if (GAME.heroScalePercent < maxScalePercent) GAME.heroScalePercent += 4;
        }
    }

    // Ğ¢ĞµĞ»ĞµĞ¿Ğ¾Ñ€Ñ‚: Ğ³Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ğ¸Ğ¹ Ñ‚Ñ–Ğº (ĞºĞ¾Ğ¶Ğ½Ñ– 10 ÑĞµĞº â€” Ğ¾Ğ´Ğ¸Ğ½ Ğ³ĞµÑ€Ğ¾Ğ¹ Ğ· ĞºĞ¾Ğ¶Ğ½Ğ¾Ğ³Ğ¾ Ğ¿Ğ¾Ğ²ĞµÑ€Ñ…Ñƒ Ğ· Ñ‚ĞµĞ»ĞµĞ¿Ğ¾Ñ€Ñ‚Ğ¾Ğ¼)
    tickTeleports();

    // Ğ¡ĞºĞ¸Ğ´Ğ°Ñ”Ğ¼Ğ¾ Ñ‚Ñ€Ğ°Ğ½ÑÑ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ñ–Ñ Ñ– Ğ¿ĞµÑ€ĞµĞ²ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ÑÑ”Ğ¼Ğ¾ dpr scale ĞºĞ¾Ğ¶ĞµĞ½ ĞºĞ°Ğ´Ñ€
    let _dpr = Math.min(window.devicePixelRatio || 1, 2);
    if (screenShake > 0) screenShake--;
    let _sx = screenShake > 0 ? (Math.random() - 0.5) * screenShake * 2 : 0;
    let _sy = screenShake > 0 ? (Math.random() - 0.5) * screenShake * 2 : 0;
    ctx.setTransform(_dpr, 0, 0, _dpr, _sx * _dpr, _sy * _dpr);

    ctx.fillStyle = '#0d0820';
    ctx.fillRect(0, 0, gW, gH);

    // ĞšĞ°Ğ¼ĞµÑ€Ğ°
    if (manualCameraY !== null) {
        GAME.cameraY = manualCameraY;
    } else {
        let target = floors.length * CFG.floorH - gH/2;
        GAME.cameraY += (target - GAME.cameraY) * 0.1;
    }
    let maxCam = Math.max(0, floors[floors.length-1].y - gH + 150);
    GAME.cameraY = Math.max(0, Math.min(GAME.cameraY, maxCam));

    // â”€â”€ ĞÑ–Ñ‡Ğ½Ğµ Ğ½ĞµĞ±Ğ¾ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let skyGrad = ctx.createLinearGradient(0, 0, 0, CFG.surfaceY - GAME.cameraY);
    skyGrad.addColorStop(0,   '#03020a');
    skyGrad.addColorStop(0.5, '#08041a');
    skyGrad.addColorStop(1,   '#14082e');
    ctx.fillStyle = skyGrad;
    ctx.fillRect(0, -500 - GAME.cameraY, gW, CFG.surfaceY + 500);

    // â”€â”€ ĞœÑ–ÑÑÑ†ÑŒ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    {
        let mx = gW * 0.76, my = 55 - GAME.cameraY * 0.08;
        let mr = 26;
        // ĞÑ€ĞµĞ¾Ğ» Ğ¼Ñ–ÑÑÑ†Ñ
        let mg = ctx.createRadialGradient(mx, my, mr * 0.6, mx, my, mr * 3.5);
        mg.addColorStop(0, 'rgba(210,195,160,0.18)'); mg.addColorStop(1, 'rgba(210,195,160,0)');
        ctx.fillStyle = mg; ctx.beginPath(); ctx.arc(mx, my, mr*3.5, 0, Math.PI*2); ctx.fill();
        // Ğ¢Ñ–Ğ»Ğ¾ Ğ¼Ñ–ÑÑÑ†Ñ
        let mbg = ctx.createRadialGradient(mx-7, my-7, 2, mx, my, mr);
        mbg.addColorStop(0, '#fffff2'); mbg.addColorStop(0.5, '#e8dfc0'); mbg.addColorStop(1, '#c0aa80');
        ctx.fillStyle = mbg; ctx.beginPath(); ctx.arc(mx, my, mr, 0, Math.PI*2); ctx.fill();
        // ĞšÑ€Ğ°Ñ‚ĞµÑ€Ğ¸
        [[mx-8,my-6,5],[mx+7,my+8,3],[mx-4,my+11,4]].forEach(([cx,cy,cr])=>{
            ctx.fillStyle='rgba(150,130,90,0.22)'; ctx.beginPath(); ctx.arc(cx,cy,cr,0,Math.PI*2); ctx.fill();
        });
    }

    // â”€â”€ Ğ—Ñ–Ñ€ĞºĞ¸ (Ñ€Ñ–Ğ·Ğ½Ğ¸Ñ… Ñ€Ğ¾Ğ·Ğ¼Ñ–Ñ€Ñ–Ğ², Ñ€Ñ–Ğ·Ğ½Ğ¾Ğ³Ğ¾ ĞºĞ¾Ğ»ÑŒĞ¾Ñ€Ñƒ) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    for (let i = 0; i < 90; i++) {
        let sx = (i * 347 + 11) % gW;
        let sy = (i * 193 + 7) % (CFG.surfaceY - 20) - GAME.cameraY;
        if (sy > CFG.surfaceY - GAME.cameraY - 5) continue;
        let blink = 0.25 + 0.75 * Math.sin(Date.now() / (600 + i * 20) + i * 2.3);
        let sr = i % 14 === 0 ? 2.2 : i % 7 === 0 ? 1.5 : 0.9;
        ctx.globalAlpha = blink * 0.85;
        ctx.fillStyle = i % 17 === 0 ? '#ffeedd' : i % 11 === 0 ? '#cce0ff' : '#ffffff';
        ctx.beginPath(); ctx.arc(sx, sy, sr, 0, Math.PI * 2); ctx.fill();
    }
    ctx.globalAlpha = 1;

    // â”€â”€ Ğ¡Ğ¸Ğ»ÑƒĞµÑ‚ Ğ³Ñ–Ñ€ Ğ½Ğ° Ğ³Ğ¾Ñ€Ğ¸Ğ·Ğ¾Ğ½Ñ‚Ñ– â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let groundY = CFG.surfaceY - GAME.cameraY;
    ctx.fillStyle = '#0a0618';
    ctx.beginPath(); ctx.moveTo(0, groundY + 2);
    [[0,0],[gW*.07,-48],[gW*.15,-18],[gW*.25,-75],[gW*.33,-35],
     [gW*.42,-92],[gW*.5,-44],[gW*.58,-65],[gW*.67,-28],[gW*.76,-82],
     [gW*.84,-40],[gW*.92,-60],[gW,0]].forEach(([mx,my])=>ctx.lineTo(mx, groundY+my));
    ctx.lineTo(gW, groundY+2); ctx.closePath(); ctx.fill();

    // Ğ”Ñ€ÑƒĞ³Ğ¸Ğ¹ ÑˆĞ°Ñ€ Ğ³Ñ–Ñ€ (Ğ±Ğ»Ğ¸Ğ¶Ñ‡Ğ¸Ğ¹, Ñ‚Ñ€Ğ¾Ñ…Ğ¸ ÑĞ²Ñ–Ñ‚Ğ»Ñ–ÑˆĞ¸Ğ¹)
    ctx.fillStyle = '#0f0820';
    ctx.beginPath(); ctx.moveTo(0, groundY + 2);
    [[0,0],[gW*.1,-22],[gW*.2,-8],[gW*.3,-38],[gW*.4,-14],
     [gW*.5,-28],[gW*.62,-10],[gW*.72,-35],[gW*.82,-15],[gW*.9,-24],[gW,0]].forEach(([mx,my])=>ctx.lineTo(mx, groundY+my));
    ctx.lineTo(gW, groundY+2); ctx.closePath(); ctx.fill();

    // â”€â”€ Ğ—ĞµĞ¼Ğ»Ñ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let groundGrad = ctx.createLinearGradient(0, groundY, 0, groundY + 32);
    groundGrad.addColorStop(0, '#3a2850'); groundGrad.addColorStop(1, '#180e22');
    ctx.fillStyle = groundGrad; ctx.fillRect(0, groundY, gW, 32);

    // â”€â”€ Ğ¢ÑƒĞ¼Ğ°Ğ½ Ğ½Ğ° Ğ³Ğ¾Ñ€Ğ¸Ğ·Ğ¾Ğ½Ñ‚Ñ– â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let fogG = ctx.createLinearGradient(0, groundY - 35, 0, groundY + 5);
    fogG.addColorStop(0, 'rgba(50,20,90,0)'); fogG.addColorStop(1, 'rgba(30,12,60,0.5)');
    ctx.fillStyle = fogG; ctx.fillRect(0, groundY - 35, gW, 40);

    // â”€â”€ ĞŸÑ–Ğ´Ğ·ĞµĞ¼Ğ½Ğ° Ğ¿Ğ¾Ñ€Ğ¾Ğ´Ğ° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    ctx.fillStyle = '#0c0814';
    ctx.fillRect(0, groundY + 32, gW, 5000);

    // â”€â”€ ĞŸĞµÑ‡ĞµÑ€Ğ½Ğ¸Ğ¹ Ğ²Ñ…Ñ–Ğ´ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let caveX  = CAVE_X;  // Ğ·Ğ¼Ñ–Ñ‰ĞµĞ½Ğ¾ Ğ¿Ñ€Ğ°Ğ²Ğ¾Ñ€ÑƒÑ‡ Ğ²Ñ–Ğ´ Ñ†ĞµĞ½Ñ‚Ñ€Ñƒ (Ğ³Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ğ° Ğ·Ğ¼Ñ–Ğ½Ğ½Ğ°)
    let caveW  = 80;
    let caveH  = 70;
    let caveY  = groundY + 2;

    // Ğ¢Ñ–Ğ½ÑŒ Ğ½Ğ°Ğ²ĞºĞ¾Ğ»Ğ¾ Ğ²Ñ…Ğ¾Ğ´Ñƒ
    let caveShadow = ctx.createRadialGradient(caveX, caveY + caveH/2, 10, caveX, caveY + caveH/2, 90);
    caveShadow.addColorStop(0, 'rgba(0,0,0,0.6)');
    caveShadow.addColorStop(1, 'rgba(0,0,0,0)');
    ctx.fillStyle = caveShadow;
    ctx.beginPath(); ctx.arc(caveX, caveY + caveH*0.6, 90, 0, Math.PI*2); ctx.fill();

    // ĞÑ€ĞºĞ° Ğ²Ñ…Ğ¾Ğ´Ñƒ â€” Ñ‚ĞµĞ¼Ğ½Ğ° Ğ´Ñ–Ñ€Ğ°
    ctx.fillStyle = '#000';
    ctx.beginPath();
    ctx.arc(caveX, caveY + 4, caveW/2, Math.PI, 0);
    ctx.lineTo(caveX + caveW/2, caveY + caveH);
    ctx.lineTo(caveX - caveW/2, caveY + caveH);
    ctx.closePath(); ctx.fill();

    // ĞĞ±Ğ²Ğ¾Ğ´ĞºĞ° Ğ°Ñ€ĞºĞ¸ â€” ĞºĞ°Ğ¼Ñ–Ğ½ÑŒ
    ctx.strokeStyle = '#5a3e70'; ctx.lineWidth = 4;
    ctx.beginPath();
    ctx.arc(caveX, caveY + 4, caveW/2, Math.PI, 0);
    ctx.lineTo(caveX + caveW/2, caveY + caveH);
    ctx.stroke();
    ctx.beginPath();
    ctx.arc(caveX, caveY + 4, caveW/2, Math.PI, 0);
    ctx.lineTo(caveX - caveW/2, caveY + caveH);
    ctx.stroke();

    // ĞšĞ°Ğ¼Ñ–Ğ½Ñ†Ñ– Ğ½Ğ°Ğ²ĞºĞ¾Ğ»Ğ¾ Ğ°Ñ€ĞºĞ¸
    let arcStones = [[-38,18,12,9], [-30,-8,10,8], [-12,-20,9,7],
                     [12,-20,9,7],  [30,-8,10,8],  [38,18,12,9]];
    arcStones.forEach(([ox,oy,sw2,sh2]) => {
        ctx.fillStyle = '#4a3260';
        ctx.beginPath();
        ctx.ellipse(caveX + ox, caveY + 4 + oy, sw2, sh2, ox*0.02, 0, Math.PI*2);
        ctx.fill();
        ctx.strokeStyle = '#2e1e40'; ctx.lineWidth = 1; ctx.stroke();
    });

    // ĞŸÑ–Ğ´Ğ¿Ğ¸Ñ
    ctx.fillStyle = 'rgba(200,160,255,0.7)';
    ctx.font = 'bold 11px Arial'; ctx.textAlign = 'center';
    ctx.fillText('â› ĞŸĞ†Ğ”Ğ—Ğ•ĞœĞ•Ğ›Ğ›Ğ¯', caveX, caveY - 10);

    // â”€â”€ ĞœÑ–ÑÑ‚Ğ¾ â€” Ñ„Ñ–ĞºÑĞ¾Ğ²Ğ°Ğ½Ğ¾ Ğ·Ğ»Ñ–Ğ²Ğ° Ğ²Ñ–Ğ´ ĞµĞºÑ€Ğ°Ğ½Ñƒ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let _cityAvail = centerX - CFG.floorW / 2 - 10;
    let _cityScale = Math.min(1, Math.max(0.35, _cityAvail / 210));
    let cityX = 4;
    // ĞĞ½Ğ¾Ğ²Ğ»ÑÑ”Ğ¼Ğ¾ Ğ³Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ñƒ X Ğ²Ğ¾Ñ€Ñ–Ñ‚ Ğ´Ğ»Ñ ÑĞ¿Ğ°Ğ²Ğ½Ñƒ Ğ³ĞµÑ€Ğ¾Ñ—Ğ²
    CITY_GATE_X = cityX + 100 * _cityScale;
    // ĞœĞ°Ğ»ÑÑ”Ğ¼Ğ¾ Ğ¼Ñ–ÑÑ‚Ğ¾ Ğ· Ğ¼Ğ°ÑÑˆÑ‚Ğ°Ğ±ÑƒĞ²Ğ°Ğ½Ğ½ÑĞ¼ Ñ‡ĞµÑ€ĞµĞ· ctx.save/scale
    ctx.save();
    ctx.translate(cityX, groundY); // Ñ‚Ğ¾Ñ‡ĞºĞ° Ğ²Ñ–Ğ´Ğ»Ñ–ĞºÑƒ â€” Ğ¿Ñ–Ğ´Ğ¾ÑˆĞ²Ğ° Ğ¼Ñ–ÑÑ‚Ğ° Ğ½Ğ° Ñ€Ñ–Ğ²Ğ½Ñ– Ğ·ĞµĞ¼Ğ»Ñ–
    ctx.scale(_cityScale, _cityScale);
    // Ğ’ÑÑ– ĞºĞ¾Ğ¾Ñ€Ğ´Ğ¸Ğ½Ğ°Ñ‚Ğ¸ Ğ²Ñ–Ğ´Ğ½Ğ¾ÑĞ½Ğ¾ (0,0) = Ğ½Ğ¸Ğ¶Ğ½Ñ–Ğ¹ Ğ»Ñ–Ğ²Ğ¸Ğ¹ ĞºÑƒÑ‚ Ğ¼Ñ–ÑÑ‚Ğ°
    let _cy = -140; // Ğ²ĞµÑ€Ñ… Ğ¼Ñ–ÑÑ‚Ğ° Ğ²Ñ–Ğ´Ğ½Ğ¾ÑĞ½Ğ¾ Ğ·ĞµĞ¼Ğ»Ñ–
    // ĞÑĞ½Ğ¾Ğ²Ğ°
    ctx.fillStyle = '#2a2035';
    ctx.fillRect(0, _cy + 80, 200, 60);
    // Ğ’ĞµĞ¶Ğ° Ğ»Ñ–Ğ²Ğ°
    ctx.fillStyle = '#352848';
    ctx.fillRect(10, _cy + 20, 40, 100);
    ctx.fillStyle = '#4a3660';
    ctx.beginPath(); ctx.moveTo(10,_cy+20); ctx.lineTo(30,_cy); ctx.lineTo(50,_cy+20); ctx.closePath(); ctx.fill();
    // Ğ’ĞµĞ¶Ğ° Ğ¿Ñ€Ğ°Ğ²Ğ°
    ctx.fillStyle = '#352848';
    ctx.fillRect(150, _cy + 20, 40, 100);
    ctx.fillStyle = '#4a3660';
    ctx.beginPath(); ctx.moveTo(150,_cy+20); ctx.lineTo(170,_cy); ctx.lineTo(190,_cy+20); ctx.closePath(); ctx.fill();
    // ĞŸÑ€Ğ°Ğ¿Ğ¾Ñ€
    ctx.fillStyle = '#cc2244';
    ctx.fillRect(29, _cy, 2, 20);
    ctx.beginPath(); ctx.moveTo(31,_cy); ctx.lineTo(44,_cy+7); ctx.lineTo(31,_cy+14); ctx.closePath(); ctx.fill();
    // Ğ’Ğ¾Ñ€Ğ¾Ñ‚Ğ°
    ctx.fillStyle = '#000';
    ctx.beginPath(); ctx.arc(100, _cy+140, 22, Math.PI, 0); ctx.rect(78, _cy+140, 44, 20); ctx.fill();
    // Ğ’Ğ¾Ğ³Ğ½Ğ¸ĞºĞ¸
    ['#ff8800','#ffaa00'].forEach((c,i) => {
        let fa = 0.7 + 0.3*Math.sin(Date.now()/300 + i*2);
        ctx.fillStyle = c; ctx.globalAlpha = fa;
        ctx.beginPath(); ctx.arc(i===0?30:170, _cy - 3, 4, 0, Math.PI*2); ctx.fill();
        ctx.globalAlpha = 1;
    });
    ctx.fillStyle = '#ffcc88';
    ctx.font = 'bold 12px Arial';
    ctx.textAlign = 'center';
    ctx.fillText('ğŸ° ĞœĞ†Ğ¡Ğ¢Ğ', 100, _cy + 15);
    ctx.restore();

    floors.forEach(f => f.draw(GAME.cameraY));

    // Ğ ĞµĞ³ĞµĞ½ Ğ›Ğ¾Ñ€Ğ´Ğ° (Ğ·Ğ°Ğ²Ğ¶Ğ´Ğ¸ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ¸Ğ¹, Ğ±Ğ°Ğ·Ğ¾Ğ²Ğ¾ 1 HP/ÑĞµĞº)
    {
        let lord = units.find(u => u.type==='lord');
        if (lord && lord.hp > 0 && lord.hp < GAME.maxLordHP)
            lord.hp = Math.min(lord.hp + GAME.lordRegen/60, GAME.maxLordHP);
    }

    // â”€â”€ Ğ¡Ñ‚ĞµĞº-Ğ±ĞµĞ¹Ğ´Ğ¶: Ğ¿Ğ¾ĞºĞ°Ğ·ÑƒÑ”Ğ¼Ğ¾ ĞºÑ–Ğ»ÑŒĞºÑ–ÑÑ‚ÑŒ ÑĞ½Ñ–Ñ‚Ñ–Ğ² Ñƒ ĞºÑƒĞ¿Ñ†Ñ– â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // Ğ“Ñ€ÑƒĞ¿ÑƒÑ”Ğ¼Ğ¾ ÑĞ½Ñ–Ñ‚Ñ–Ğ² Ğ¿Ğ¾ (floorIdx, Ñ‚Ğ¸Ğ¿) Ñ– Ğ¼Ğ°Ğ»ÑÑ”Ğ¼Ğ¾ Ğ±ĞµĞ¹Ğ´Ğ¶ ÑĞºÑ‰Ğ¾ >1 Ğ² Ñ€Ğ°Ğ´Ñ–ÑƒÑÑ– 14px
    {
        let drawn = new Set();
        for (let i = 0; i < units.length; i++) {
            if (drawn.has(i)) continue;
            let a = units[i];
            if (a.hp <= 0) continue;
            let cluster = [i];
            for (let j = i + 1; j < units.length; j++) {
                if (drawn.has(j)) continue;
                let b = units[j];
                if (b.hp <= 0 || b.floorIdx !== a.floorIdx || b.type !== a.type) continue;
                if (Math.abs(b.x - a.x) < 14 && Math.abs(b.y - a.y) < 14) {
                    cluster.push(j);
                    drawn.add(j);
                }
            }
            drawn.add(i);
            if (cluster.length > 1) {
                // ĞœĞ°Ğ»ÑÑ”Ğ¼Ğ¾ Ğ±ĞµĞ¹Ğ´Ğ¶ Ã—N Ğ½Ğ°Ğ´ Ğ¿ĞµÑ€ÑˆĞ¸Ğ¼ ÑĞ½Ñ–Ñ‚Ğ¾Ğ¼ Ñƒ ĞºĞ»Ğ°ÑÑ‚ĞµÑ€Ñ–
                let u = units[cluster[0]];
                let bdy = u.y - u.size - GAME.cameraY - 18;
                let bdx = u.x;
                ctx.fillStyle = 'rgba(20,10,40,0.82)';
                ctx.beginPath(); ctx.roundRect(bdx - 13, bdy - 10, 26, 14, 5); ctx.fill();
                ctx.fillStyle = '#ffcc00';
                ctx.font = 'bold 11px Arial'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
                ctx.fillText('Ã—' + cluster.length, bdx, bdy - 3);
                ctx.textBaseline = 'alphabetic';
            }
        }
    }

    // Ğ®Ğ½Ñ–Ñ‚Ğ¸
    for (let i = units.length - 1; i >= 0; i--) {
        let u = units[i];
        u.update(); u.draw(GAME.cameraY);
        if (u.hp <= 0) {
            // â”€â”€ SKELETON: 30% Ğ²Ñ–Ğ´Ñ€Ğ¾Ğ´Ğ¶ĞµĞ½Ğ½Ñ Ğ¿Ñ€Ğ¸ Ğ¿ĞµÑ€ÑˆÑ–Ğ¹ ÑĞ¼ĞµÑ€Ñ‚Ñ– (Ğ¿Ñ€Ğ¸ â‰¤30% HP) â”€â”€
            if (u.type === 'monster' && u.ability === 'rebirth' && !u.rebirthUsed) {
                u.rebirthUsed = true;
                u.hp = u.maxHp * 0.30;
                spawnParticle(u.x, u.y - u.size, 'white');
                continue;
            }
            // â”€â”€ AIR_ELE: 40% ÑˆĞ°Ğ½Ñ Ğ¿ĞµÑ€ĞµĞ¶Ğ¸Ñ‚Ğ¸ ÑĞ¼ĞµÑ€Ñ‚ÑŒ Ğ¾Ğ´Ğ¸Ğ½ Ñ€Ğ°Ğ· (Ğ½Ğ°Ğ¿Ñ–Ğ²Ğ¿Ñ€Ğ¾Ğ·Ğ¾Ñ€Ğ¸Ğ¹ 5 ÑĞµĞº) â”€â”€
            if (u.type === 'monster' && u.ability === 'no_die' && !u.noDieUsed) {
                if (Math.random() < 0.40) {
                    u.noDieUsed = true; u.hp = 1;
                    u._transparent = true; u._transparentTimer = 300;
                    spawnParticle(u.x, u.y - u.size, 'cyan');
                    continue;
                }
            }
            // â”€â”€ FIRE_ELE: Ğ²Ğ¸Ğ±ÑƒÑ… â€” 20% maxHP AĞĞ• Ğ¿Ğ¾ Ğ³ĞµÑ€Ğ¾ÑÑ… Ğ½Ğ° Ğ¿Ğ¾Ğ²ĞµÑ€ÑÑ– â”€â”€â”€â”€â”€â”€
            if (u.type === 'monster' && u.ability === 'explode') {
                units.filter(h=>h.type==='hero'&&h.floorIdx===u.floorIdx&&h.hp>0).forEach(h=>{
                    let exDmg = applyArmor(u.maxHp * 0.20, h.armor||0, false);
                    h.hp -= exDmg;
                    spawnParticle(h.x, h.y-h.size, 'orange');
                });
            }
            // â”€â”€ NECROMANCER: 50% Ğ¿Ñ–Ğ´Ğ½ÑÑ‚Ğ¸ Ğ¼ĞµÑ€Ñ†Ñ ÑĞº ÑĞ»Ğ°Ğ±ĞºĞ¾Ğ³Ğ¾ ÑĞºĞµĞ»ĞµÑ‚Ğ° â”€â”€â”€â”€â”€â”€â”€â”€
            if (u.type === 'monster' && u.ability === 'raise_dead') {
                if (Math.random() < 0.50) {
                    let deadHero = units.find(h=>h.type==='hero'&&h.hp<=0&&h.floorIdx===u.floorIdx);
                    if (deadHero) {
                        let sk = new Unit('monster', deadHero.x, deadHero.y, u.floorIdx, 2);
                        sk.hp = sk.maxHp * 0.4; sk.dmg *= 0.5;
                        units.push(sk);
                        spawnParticle(deadHero.x, deadHero.y-sk.size, 'purple');
                    }
                }
            }
            // Ğ¡Ğ¼ĞµÑ€Ñ‚ÑŒ Ğ³ĞµÑ€Ğ¾Ñ â€” Ğ½Ğ°Ğ³Ğ¾Ñ€Ğ¾Ğ´Ğ° + ÑĞ¿Ğ°Ğ»Ğ°Ñ… Ñ‡Ğ°ÑÑ‚Ğ¸Ğ½Ğ¾Ğº
            if (u.type === 'hero') {
                let reward = u.soulReward || (u.heroRank === 'boss' ? 80 : u.heroRank.startsWith('elite') ? 25 : 15);
                GAME.souls += reward;
                let pcol = u.heroRank === 'boss' ? 'purple' : u.heroRank.startsWith('elite') ? 'orange' : 'gold';
                let pcount = u.heroRank === 'boss' ? 16 : u.heroRank.startsWith('elite') ? 9 : 5;
                for (let p = 0; p < pcount; p++) {
                    let ang = (p / pcount) * Math.PI * 2;
                    let spd = 1.5 + Math.random() * 2.5;
                    spawnParticle(u.x, u.y - u.size * 0.4, pcol, {
                        vx: Math.cos(ang) * spd, vy: Math.sin(ang) * spd - 1.5,
                        size: 3 + Math.random() * 3.5, life: 40 + Math.random() * 20
                    });
                }
                if (u.heroRank === 'boss')            triggerScreenShake(10);
                else if (u.heroRank.startsWith('elite')) triggerScreenShake(5);
                spawnDmgText(u.x, u.y - u.size, '+' + reward + 'ğŸ’€', '#ffcc00', u.heroRank !== 'normal');
                updateUI();
            } else if (u.type === 'lord') { gameOver(); }
            units.splice(i, 1);
        } else {
            // AIR_ELE Ğ½Ğ°Ğ¿Ñ–Ğ²Ğ¿Ñ€Ğ¾Ğ·Ğ¾Ñ€Ğ¸Ğ¹ Ñ‚Ğ°Ğ¹Ğ¼ĞµÑ€
            if (u._transparentTimer > 0) { u._transparentTimer--; if (u._transparentTimer <= 0) u._transparent = false; }
        }
    }

    // â”€â”€ Ğ§Ğ°ÑÑ‚Ğ¸Ğ½ĞºĞ¸: ĞºĞ¾Ğ»Ğ° Ğ· Ğ°Ğ»ÑŒÑ„Ğ°-Ğ·Ğ³Ğ°ÑĞ°Ğ½Ğ½ÑĞ¼ Ñ– Ñ„Ñ–Ğ·Ğ¸ĞºĞ¾Ñ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const _PC = {gold:'#ffcc00',orange:'#ff8800',purple:'#cc44ff',blue:'#4488ff',
                 green:'#44ee88',cyan:'#00ffff',red:'#ff3333',white:'#ffffff',yellow:'#ffff55'};
    for (let i = particles.length - 1; i >= 0; i--) {
        let p = particles[i];
        p.life--; p.x += p.vx; p.y += p.vy; p.vy += 0.06;
        let a = Math.pow(p.life / p.maxLife, 0.8);
        let col = _PC[p.color] || p.color;
        ctx.globalAlpha = a;
        ctx.fillStyle = col;
        ctx.beginPath(); ctx.arc(p.x, p.y - GAME.cameraY, p.size, 0, Math.PI * 2); ctx.fill();
        if (p.size > 4) { // ĞÑ€ĞµĞ¾Ğ» Ğ´Ğ»Ñ Ğ²ĞµĞ»Ğ¸ĞºĞ¸Ñ… Ñ‡Ğ°ÑÑ‚Ğ¸Ğ½Ğ¾Ğº
            ctx.globalAlpha = a * 0.25;
            ctx.beginPath(); ctx.arc(p.x, p.y - GAME.cameraY, p.size * 2, 0, Math.PI * 2); ctx.fill();
        }
        if (p.life <= 0) particles.splice(i, 1);
    }
    ctx.globalAlpha = 1;

    // â”€â”€ Ğ§Ğ¸ÑĞ»Ğ° Ğ¿Ğ¾ÑˆĞºĞ¾Ğ´Ğ¶ĞµĞ½ÑŒ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    for (let i = dmgTexts.length - 1; i >= 0; i--) {
        let d = dmgTexts[i];
        d.life--; d.x += d.vx; d.y += d.vy; d.vy *= 0.94;
        let a = Math.min(1, d.life / (d.maxLife * 0.4));
        ctx.globalAlpha = a;
        ctx.font = d.big ? 'bold 15px Arial' : 'bold 11px Arial';
        ctx.textAlign = 'center';
        ctx.shadowColor = 'rgba(0,0,0,0.9)'; ctx.shadowBlur = 4;
        ctx.fillStyle = d.color;
        ctx.fillText(d.text, d.x, d.y - GAME.cameraY);
        ctx.shadowBlur = 0;
        if (d.life <= 0) dmgTexts.splice(i, 1);
    }
    ctx.globalAlpha = 1;

    // â”€â”€ Ğ¢Ğ¾Ğ¿Ğ¾Ñ€Ğ¸ Ğ³Ğ¾Ğ±Ğ»Ñ–Ğ½Ñ–Ğ² â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    for (let i = axeProjectiles.length - 1; i >= 0; i--) {
        let a = axeProjectiles[i];
        let dx2 = a.tx - a.x, dy2 = a.ty - a.y;
        let dist = Math.sqrt(dx2*dx2 + dy2*dy2);
        if (dist < a.speed) {
            // Ğ’Ğ»ÑƒÑ‡Ğ¸Ğ² â€” Ğ½Ğ°Ğ½Ğ¾ÑĞ¸Ğ¼Ğ¾ ÑƒÑ€Ğ¾Ğ½
            let target = units.find(u => u.type === 'hero' && u.floorIdx === a.floorIdx
                && Math.abs(u.x - a.tx) < 20 && u.hp > 0);
            if (target) {
                let blocked = target.blockChance > 0 && Math.random() < target.blockChance;
                if (!blocked) {
                    target.hp -= a.dmg;
                    let isCrit = a.dmg > 8; // ĞºÑ€Ğ¸Ñ‚ ÑĞºÑ‰Ğ¾ dmg Ğ¿Ğ¾Ğ´Ğ²Ğ¾Ñ”Ğ½Ğ¸Ğ¹
                    spawnParticle(target.x, target.y - target.size, isCrit ? 'orange' : 'white');
                }
            }
            axeProjectiles.splice(i, 1);
            continue;
        }
        // Ğ ÑƒÑ…Ğ°Ñ”Ğ¼Ğ¾
        a.x += (dx2 / dist) * a.speed;
        a.y += (dy2 / dist) * a.speed;
        a.angle += 0.3;
        // ĞœĞ°Ğ»ÑÑ”Ğ¼Ğ¾ Ñ‚Ğ¾Ğ¿Ñ–Ñ€
        ctx.save();
        ctx.translate(a.x, a.y - GAME.cameraY);
        ctx.rotate(a.angle);
        ctx.font = '14px Arial'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
        ctx.fillText('ğŸª“', 0, 0);
        ctx.restore();
    }

    updateUI();

    if (GAME.cityHP <= 0 && !GAME.gameOver) {
        document.getElementById('go-title').innerText = 'ĞŸĞ•Ğ Ğ•ĞœĞĞ“Ğ!';
        document.getElementById('go-title').style.color = 'lime';
        document.getElementById('go-desc').innerText = 'ĞœÑ–ÑÑ‚Ğ¾ Ğ·Ğ½Ğ¸Ñ‰ĞµĞ½Ğ¾!';
        document.getElementById('game-over').style.display = 'flex';
        GAME.gameOver = true;
        return;
    }


    requestAnimationFrame(loop);
}

// =================== ĞœĞ•ĞĞ® ===================
let openMenu = null;

function toggleMenu(name) {
    if (openMenu === name) {
        closeAllMenus();
    } else {
        closeAllMenus();
        openMenu = name;
        document.getElementById('sub-' + name).classList.add('open');
        let mainBtn = document.getElementById('menu-' + name).querySelector('.circle-main-btn');
        if (mainBtn) mainBtn.classList.add('active');
    }
}

function closeAllMenus() {
    ['lord','monster','trap'].forEach(n => {
        let sub = document.getElementById('sub-' + n);
        let menu = document.getElementById('menu-' + n);
        let btn = menu ? menu.querySelector('.circle-main-btn') : null;
        if (sub) sub.classList.remove('open');
        if (btn) btn.classList.remove('active');
    });
    openMenu = null;
}

document.addEventListener('click', e => {
    if (openMenu && !e.target.closest('.circle-menu')) closeAllMenus();
});
document.addEventListener('touchend', e => {
    if (openMenu && !e.target.closest('.circle-menu')) closeAllMenus();
});

// =================== ĞĞŸĞ“Ğ Ğ•Ğ™Ğ”Ğ˜ Ğ›ĞĞ Ğ”Ğ ===================
function upgradeLordAttack() {
    if (GAME.souls < GAME.lordAtkCost) return;
    GAME.souls -= GAME.lordAtkCost;
    GAME.lordDmg += 5;
    GAME.lordAtkSpeedBonus += 0.1;
    let lord = units.find(u => u.type==='lord');
    if (lord) {
        lord.dmg = GAME.lordDmg;
        lord.atkSpeedBonus = GAME.lordAtkSpeedBonus;
    }
    GAME.lordAtkCost = Math.floor(GAME.lordAtkCost * 1.45);
    updateUI(); saveGame();
}

function upgradeLordVit() {
    if (GAME.souls < GAME.lordVitCost) return;
    GAME.souls -= GAME.lordVitCost;
    GAME.maxLordHP += 100;
    GAME.lordArmor += 2;
    GAME.lordRegenPct += 0.001; // +0.1% Ğ¼Ğ°ĞºÑ HP/ÑĞµĞº
    let lord = units.find(u => u.type==='lord');
    if (lord) {
        lord.maxHp = GAME.maxLordHP;
        lord.hp = Math.min(lord.hp + 100, GAME.maxLordHP);
        lord.armor = GAME.lordArmor;
    }
    GAME.lordVitCost = Math.floor(GAME.lordVitCost * 1.35);
    updateUI(); saveGame();
}

// =================== ĞĞŸĞ“Ğ Ğ•Ğ™Ğ”Ğ˜ ĞœĞĞĞ¡Ğ¢Ğ Ğ†Ğ’ ===================
function upgradeMonsterAtk() {
    if (GAME.souls < GAME.mobAtkCost) return;
    GAME.souls -= GAME.mobAtkCost;
    GAME.monsterDmgBonus += 0.6;
    // +0.15 Ğ´Ğ¾ Ğ¨Ğ (Dota2-ÑÑ‚Ğ¸Ğ»ÑŒ: ĞºĞ¾Ğ¶ĞµĞ½ Ğ±Ğ¾Ğ½ÑƒÑ Ğ·Ğ¼ĞµĞ½ÑˆÑƒÑ” cooldown Ğ½ĞµĞ»Ñ–Ğ½Ñ–Ğ¹Ğ½Ğ¾)
    GAME.monsterAtkSpeedBonus += 0.15;
    units.filter(u => u.type === 'monster').forEach(m => {
        m.dmg += 0.6;
        m.atkSpeedBonus = GAME.monsterAtkSpeedBonus;
        // Ğ¿ĞµÑ€ĞµÑ€Ğ°Ñ…Ğ¾Ğ²ÑƒÑ”Ğ¼Ğ¾ cooldown Ğ¾Ğ´Ñ€Ğ°Ğ·Ñƒ Ğ´Ğ»Ñ Ğ¶Ğ¸Ğ²Ğ¸Ñ… Ğ¼Ğ¾Ğ½ÑÑ‚Ñ€Ñ–Ğ²
        let atkSpd = (m.baseAtkSpeed || 0.83) + m.atkSpeedBonus;
        m.attackCooldownBase = Math.max(8, Math.round(60 / atkSpd));
    });
    GAME.mobAtkCost = Math.floor(GAME.mobAtkCost * 1.4);
    updateUI(); saveGame();
}

function upgradeMonsterVit() {
    if (GAME.souls < GAME.mobVitCost) return;
    GAME.souls -= GAME.mobVitCost;
    GAME.monsterHpBonus += 25;
    GAME.monsterArmorBonus += 1;
    units.filter(u => u.type==='monster').forEach(m => { m.maxHp += 25; m.hp = Math.min(m.hp+25, m.maxHp); m.armor = (m.armor||0) + 1; });
    GAME.mobVitCost = Math.floor(GAME.mobVitCost * 1.35);
    updateUI(); saveGame();
}

// =================== Ğ¢Ğ•Ğ›Ğ•ĞŸĞĞ Ğ¢ â€” Ğ“Ğ›ĞĞ‘ĞĞ›Ğ¬ĞĞ˜Ğ™ Ğ¢Ğ†Ğš ===================
function tickTeleports() {
    floors.forEach(f => {
        if (!f.hasTrap || f.trapType !== 'teleport') return;

        // Ğ—Ğ¼ĞµĞ½ÑˆÑƒÑ”Ğ¼Ğ¾ cooldown (10 ÑĞµĞº = 600 ĞºĞ°Ğ´Ñ€Ñ–Ğ²)
        if (f.teleportCooldown > 0) { f.teleportCooldown--; return; }

        // Ğ—Ğ½Ğ°Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ğ¾ Ğ¾Ğ´Ğ½Ğ¾Ğ³Ğ¾ Ğ³ĞµÑ€Ğ¾Ñ Ğ½Ğ° Ñ†ÑŒĞ¾Ğ¼Ñƒ Ğ¿Ğ¾Ğ²ĞµÑ€ÑÑ–
        let victims = units.filter(u => u.type === 'hero' && u.floorIdx === f.depth && !u.dazeMode);
        if (victims.length === 0) return;

        let victim = victims[Math.floor(Math.random() * victims.length)];

        // Ğ Ğ°Ğ½Ğ´Ğ¾Ğ¼Ğ½Ğ¸Ğ¹ Ğ¿Ğ¾Ğ²ĞµÑ€Ñ… (Ğ½Ğµ Ğ¿Ğ¾Ğ²ĞµÑ€Ñ… Ğ»Ğ¾Ñ€Ğ´Ğ°, Ğ½Ğµ Ñ‚Ğ¾Ğ¹ ÑĞ°Ğ¼Ğ¸Ğ¹)
        let available = floors.filter(fl => fl.depth !== floors.length - 1 && fl.depth !== f.depth);
        if (available.length === 0) return;
        let dest = available[Math.floor(Math.random() * available.length)];

        // Ğ¢ĞµĞ»ĞµĞ¿Ğ¾Ñ€Ñ‚ÑƒÑ”Ğ¼Ğ¾ Ğ² Ñ†ĞµĞ½Ñ‚Ñ€ ĞºÑ–Ğ¼Ğ½Ğ°Ñ‚Ğ¸
        spawnParticle(victim.x, victim.y, 'blue');
        victim.floorIdx = dest.depth;
        victim.y = dest.y;
        victim.x = centerX; // Ñ†ĞµĞ½Ñ‚Ñ€ ĞºÑ–Ğ¼Ğ½Ğ°Ñ‚Ğ¸
        victim.isClimbing = false;
        victim.trapDamaged = false;
        spawnParticle(victim.x, victim.y, 'blue');

        f.teleportCooldown = 10 * 60; // 10 ÑĞµĞº
    });
}

function showTrapPlacementHint(type) {
    const icons = { spike: 'ğŸ—¡ï¸', teleport: 'ğŸŒ€', daze: 'ğŸ’«' };
    document.getElementById('trap-hint-icon').innerText = icons[type] || 'ğŸª¤';
    document.getElementById('trap-hint').style.display = 'block';
    document.body.classList.add('trap-placement-mode');
}

function hideTrapPlacementHint() {
    document.getElementById('trap-hint').style.display = 'none';
    document.body.classList.remove('trap-placement-mode');
}

// =================== ĞŸĞĞ¡Ğ¢ĞšĞ˜ ===================
const TRAP_COSTS = { spike: 50, teleport: 120, daze: 200 };

// Ğ ĞµĞ¶Ğ¸Ğ¼ Ğ²Ğ¸Ğ±Ğ¾Ñ€Ñƒ Ğ¿Ğ¾Ğ²ĞµÑ€Ñ…Ñƒ Ğ´Ğ»Ñ Ğ¿Ğ°ÑÑ‚ĞºĞ¸
let pendingTrapType = null; // ÑĞºÑ‰Ğ¾ Ğ½Ğµ null â€” Ñ‡ĞµĞºĞ°Ñ”Ğ¼Ğ¾ ĞºĞ»Ñ–ĞºÑƒ Ğ½Ğ° Ğ¿Ğ¾Ğ²ĞµÑ€Ñ…

function buyTrap(type) {
    let cost = TRAP_COSTS[type];
    if (GAME.souls < cost) return;

    // ĞŸĞµÑ€ĞµĞ²Ñ–Ñ€ÑÑ”Ğ¼Ğ¾ Ñ‡Ğ¸ Ñ” Ğ²Ñ–Ğ»ÑŒĞ½Ñ– Ğ¿Ğ¾Ğ²ĞµÑ€Ñ…Ğ¸
    let available = floors.slice(0, floors.length - 1).filter(f => !f.hasTrap);
    if (available.length === 0) return;

    // Ğ¯ĞºÑ‰Ğ¾ Ñ‚Ñ–Ğ»ÑŒĞºĞ¸ Ğ¾Ğ´Ğ¸Ğ½ Ğ¿Ğ¾Ğ²ĞµÑ€Ñ… Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¸Ğ¹ â€” ÑÑ‚Ğ°Ğ²Ğ¸Ğ¼Ğ¾ Ğ¾Ğ´Ñ€Ğ°Ğ·Ñƒ
    if (available.length === 1) {
        GAME.souls -= cost;
        available[0].hasTrap = true;
        available[0].trapType = type;
        updateUI(); saveGame();
        return;
    }

    // Ğ†Ğ½Ğ°ĞºÑˆĞµ Ğ²Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ğ¾ Ğ² Ñ€ĞµĞ¶Ğ¸Ğ¼ Ğ²Ğ¸Ğ±Ğ¾Ñ€Ñƒ
    pendingTrapType = type;
    showTrapPlacementHint(type);
}

// =================== ĞŸĞĞ’Ğ•Ğ Ğ¥ / Ğ¥Ğ’Ğ˜Ğ›Ğ¯ ===================
function buyFloor() {
    if (GAME.souls < GAME.floorCost) return;
    GAME.souls -= GAME.floorCost;
    floors.push(new Floor(floors.length));
    GAME.floorCost = Math.floor(GAME.floorCost * 1.3);
    // ĞŸĞµÑ€ĞµĞ¼Ñ–Ñ‰ÑƒÑ”Ğ¼Ğ¾ Ğ»Ğ¾Ñ€Ğ´Ğ° Ğ½Ğ° Ğ½Ğ¾Ğ²Ğ¸Ğ¹ (Ğ½Ğ¸Ğ¶Ğ½Ñ–Ğ¹) Ğ¿Ğ¾Ğ²ĞµÑ€Ñ… â€” ĞĞ• Ğ¿ĞµÑ€ĞµÑÑ‚Ğ²Ğ¾Ñ€ÑÑ”Ğ¼Ğ¾, HP Ğ·Ğ±ĞµÑ€Ñ–Ğ³Ğ°Ñ”Ñ‚ÑŒÑÑ
    let lord = units.find(u => u.type === 'lord');
    let last = floors[floors.length - 1];
    if (lord) {
        lord.x = centerX; lord.y = last.y;
        lord.floorIdx = floors.length - 1;
    } else {
        spawnLord(); // Ñ‚Ñ–Ğ»ÑŒĞºĞ¸ ÑĞºÑ‰Ğ¾ Ğ»Ğ¾Ñ€Ğ´Ğ° Ğ²Ğ·Ğ°Ğ³Ğ°Ğ»Ñ– Ğ½ĞµĞ¼Ğ°Ñ”
    }
    updateUI(); saveGame();
}

function triggerWave() {
    if (GAME.isWave) return;
    GAME.isWave = true;
    // Ğ¢Ñ–Ğ»ÑŒĞºĞ¸ Ğ¿Ğ¾Ñ‚Ğ¾Ñ‡Ğ½Ñ– Ğ¼Ğ¾Ğ½ÑÑ‚Ñ€Ğ¸ Ğ¾Ñ‚Ñ€Ğ¸Ğ¼ÑƒÑÑ‚ÑŒ waveActive â€” Ğ½Ğ¾Ğ²Ñ– ÑĞ¿Ğ°Ğ²Ğ½ Ğ½Ğµ Ğ¾Ñ‚Ñ€Ğ¸Ğ¼Ğ°ÑÑ‚ÑŒ
    units.forEach(u => { if (u.type === 'monster') u.waveActive = true; });
    setTimeout(() => { GAME.isWave = false; }, 8000);
}

// =================== UI ===================
function updateUI() {
    let s = GAME.souls;
    document.getElementById('souls-display').innerText = Math.floor(s);
    document.getElementById('floor-cost-lbl').innerText = GAME.floorCost + 'ğŸ’€';
    document.getElementById('difficulty-level').innerText = GAME.difficultyLevel;
    document.getElementById('hero-scale').innerText = GAME.heroScalePercent;

    // ĞŸĞ¾Ğ²ĞµÑ€Ñ… ĞºĞ½Ğ¾Ğ¿ĞºĞ°
    let btnFloor = document.getElementById('btn-floor');
    if (btnFloor) btnFloor.disabled = s < GAME.floorCost;

    // Ğ›Ğ¾Ñ€Ğ´
    document.getElementById('lord-atk-cost').innerText = GAME.lordAtkCost + 'ğŸ’€';
    document.getElementById('lord-vit-cost').innerText = GAME.lordVitCost + 'ğŸ’€';
    document.getElementById('btn-lord-atk').disabled = s < GAME.lordAtkCost;
    document.getElementById('btn-lord-vit').disabled = s < GAME.lordVitCost;

    // ĞœĞ¾Ğ½ÑÑ‚Ñ€Ğ¸
    document.getElementById('mob-atk-cost').innerText = GAME.mobAtkCost + 'ğŸ’€';
    document.getElementById('mob-vit-cost').innerText = GAME.mobVitCost + 'ğŸ’€';
    document.getElementById('btn-mob-atk').disabled = s < GAME.mobAtkCost;
    document.getElementById('btn-mob-vit').disabled = s < GAME.mobVitCost;

    // ĞŸĞ°ÑÑ‚ĞºĞ¸
    document.getElementById('btn-trap-spike').disabled = s < 50;
    document.getElementById('btn-trap-tele').disabled  = s < 120;
    document.getElementById('btn-trap-daze').disabled  = s < 200;

    // ĞĞ½Ñ–Ğ¼Ğ°Ñ†Ñ–Ñ: Ğ¿Ñ–Ğ´ÑĞ²Ñ–Ñ‡ÑƒÑ”Ğ¼Ğ¾ ĞºĞ¾Ğ»Ğ° ÑĞºÑ‰Ğ¾ Ñ” Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ñ– Ğ°Ğ¿Ğ³Ñ€ĞµĞ¹Ğ´Ğ¸
    const lordAfford  = s >= GAME.lordAtkCost  || s >= GAME.lordVitCost;
    const mobAfford   = s >= GAME.mobAtkCost   || s >= GAME.mobVitCost;
    const trapAfford  = s >= 50;
    document.querySelectorAll('.cmain-lord').forEach(b => b.classList.toggle('can-afford', lordAfford));
    document.querySelectorAll('.cmain-monster').forEach(b => b.classList.toggle('can-afford', mobAfford));
    document.querySelectorAll('.cmain-trap').forEach(b => b.classList.toggle('can-afford', trapAfford));

    // HP bars
    document.getElementById('city-hp').style.width = Math.max(0, GAME.cityHP/GAME.maxCityHP*100) + '%';
    let lord = units.find(u => u.type==='lord');
    if (lord) document.getElementById('lord-hp').style.width = Math.max(0, lord.hp/GAME.maxLordHP*100) + '%';
}

// =================== Ğ£Ğ¢Ğ˜Ğ›Ğ†Ğ¢Ğ˜ ===================
function spawnParticle(x, y, color, opts = {}) {
    particles.push({
        x, y, color,
        vx:  opts.vx  !== undefined ? opts.vx  : (Math.random() - 0.5) * 3,
        vy:  opts.vy  !== undefined ? opts.vy  : -(1 + Math.random() * 2.5),
        size: opts.size || (2 + Math.random() * 3),
        life: opts.life || 35,
        maxLife: opts.life || 35,
    });
}
function spawnDmgText(x, y, text, color = '#ffffff', big = false) {
    dmgTexts.push({ x, y, text, color, big, life: 50, maxLife: 50,
        vx: (Math.random() - 0.5) * 0.8, vy: -1.4 });
}
function triggerScreenShake(intensity) {
    screenShake = Math.max(screenShake, intensity || 6);
}

// Dota2-ÑÑ‚Ğ¸Ğ»ÑŒ Ğ±Ñ€Ğ¾Ğ½Ñ–: ĞµÑ„ĞµĞºÑ‚Ğ¸Ğ²Ğ½Ğµ Ğ·Ğ½Ğ¸Ğ¶ĞµĞ½Ğ½Ñ = armor*0.06/(1+armor*0.06)
function applyArmor(dmg, armor, pierce) {
    if (pierce || !armor || armor <= 0) return dmg;
    let reduction = armor * 0.06 / (1 + armor * 0.06);
    return dmg * (1 - reduction);
}

// â”€â”€ localStorage Ğ· fallback (Telegram / Ğ¿Ñ€Ğ¸Ğ²Ğ°Ñ‚Ğ½Ğ¸Ğ¹ Ñ€ĞµĞ¶Ğ¸Ğ¼ Ğ¼Ğ¾Ğ¶ÑƒÑ‚ÑŒ Ğ±Ğ»Ğ¾ĞºÑƒĞ²Ğ°Ñ‚Ğ¸) â”€â”€
const _store = (() => {
    let mem = {};
    try {
        localStorage.setItem('__test', '1');
        localStorage.removeItem('__test');
        return {
            get: k => localStorage.getItem(k),
            set: (k, v) => localStorage.setItem(k, v),
            del: k => localStorage.removeItem(k),
        };
    } catch(e) {
        // fallback â€” Ğ·Ğ±ĞµÑ€Ñ–Ğ³Ğ°Ñ”Ğ¼Ğ¾ Ğ² Ğ¿Ğ°Ğ¼'ÑÑ‚Ñ– (Ğ¿Ñ€Ğ¾Ğ³Ñ€ĞµÑ Ğ²Ñ‚Ñ€Ğ°Ñ‡Ğ°Ñ”Ñ‚ÑŒÑÑ Ğ¿Ñ€Ğ¸ Ğ¿ĞµÑ€ĞµĞ·Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ĞµĞ½Ğ½Ñ–)
        return {
            get: k => mem[k] ?? null,
            set: (k, v) => { mem[k] = v; },
            del: k => { delete mem[k]; },
        };
    }
})();

function saveGame() {
    try {
        _store.set('DLSiege_v3', JSON.stringify({
            game: GAME,
            floors: floors.map(f => ({ depth:f.depth, hasTrap:f.hasTrap, trapType:f.trapType, maxMonsters:f.maxMonsters, floorUpgradeCost:f.floorUpgradeCost }))
        }));
    } catch(e) { /* Ñ–Ğ³Ğ½Ğ¾Ñ€ÑƒÑ”Ğ¼Ğ¾ Ğ¿Ğ¾Ğ¼Ğ¸Ğ»ĞºÑƒ ÑĞµÑ€Ñ–Ğ°Ğ»Ñ–Ğ·Ğ°Ñ†Ñ–Ñ— */ }
}

function hardReset() { _store.del('DLSiege_v3'); location.reload(); }
function gameOver() { GAME.gameOver = true; document.getElementById('game-over').style.display = 'flex'; }

function resize() {
    let dpr = Math.min(window.devicePixelRatio || 1, 2);
    let controls = document.getElementById('controls');
    let controlsH = controls ? controls.getBoundingClientRect().height : 0;
    if (controlsH < 10) controlsH = 120;
    // ĞĞ½Ğ¾Ğ²Ğ»ÑÑ”Ğ¼Ğ¾ CSS Ğ·Ğ¼Ñ–Ğ½Ğ½Ñƒ Ñ‰Ğ¾Ğ± #canvas-wrap Ğ·Ğ½Ğ°Ğ² Ğ²Ğ¸ÑĞ¾Ñ‚Ñƒ controls
    document.documentElement.style.setProperty('--controls-h', controlsH + 'px');
    gW = window.innerWidth;
    gH = window.innerHeight - controlsH;
    if (gH < 100) gH = window.innerHeight * 0.6;
    canvas.width  = Math.round(gW * dpr);
    canvas.height = Math.round(gH * dpr);
    canvas.style.width  = gW + 'px';
    canvas.style.height = gH + 'px';
    ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
    centerX = gW / 2;
    CFG.floorW = Math.min(gW - 60, 380);
    CAVE_X = centerX + CFG.floorW * 0.35;
}

// =================== DRAG/TOUCH ===================
canvas.addEventListener('mousedown',  e => { isDragging=true; lastDragY=e.clientY; });
canvas.addEventListener('mousemove',  e => { if(!isDragging)return; let d=lastDragY-e.clientY; lastDragY=e.clientY; if(manualCameraY===null)manualCameraY=GAME.cameraY; manualCameraY+=d; cameraReturnTimer=0; });
canvas.addEventListener('mouseup',    ()=> isDragging=false);
canvas.addEventListener('mouseleave', ()=> isDragging=false);
let _touchStartX=0, _touchStartY=0, _touchMoved=false;

canvas.addEventListener('touchstart', e => {
    if (e.touches.length === 1) {
        isDragging   = true;
        lastDragY    = e.touches[0].clientY;
        _touchStartX = e.touches[0].clientX;
        _touchStartY = e.touches[0].clientY;
        _touchMoved  = false;
        // ĞĞ• Ğ²Ğ¸ĞºĞ»Ğ¸ĞºĞ°Ñ”Ğ¼Ğ¾ preventDefault Ñ‚ÑƒÑ‚ â€” Ñ†Ğµ Ğ»Ğ°Ğ¼Ğ°Ñ” touch delivery Ğ² Telegram WKWebView.
        // Scroll Ğ±Ğ»Ğ¾ĞºÑƒÑ”Ñ‚ÑŒÑÑ Ğ² touchmove Ğ½Ğ¸Ğ¶Ñ‡Ğµ.
    }
}, { passive: true }); // passive:true â€” iOS Ğ¼Ğ¾Ğ¶Ğµ Ğ¾Ğ±Ñ€Ğ¾Ğ±Ğ»ÑÑ‚Ğ¸ inertia scroll Ğ¿Ğ°Ñ€Ğ°Ğ»ĞµĞ»ÑŒĞ½Ğ¾

canvas.addEventListener('touchmove', e => {
    if (isDragging && e.touches.length === 1) {
        e.preventDefault();
        let d = lastDragY - e.touches[0].clientY;
        if (Math.abs(d) > 4) _touchMoved = true;
        lastDragY = e.touches[0].clientY;
        if (manualCameraY === null) manualCameraY = GAME.cameraY;
        manualCameraY += d;
        cameraReturnTimer = 0;
    }
}, { passive: false });

canvas.addEventListener('touchend', e => {
    isDragging = false;
    if (!_touchMoved && e.changedTouches.length === 1) {
        // Ğ’Ğ¸ĞºĞ»Ğ¸ĞºĞ°Ñ”Ğ¼Ğ¾ Ğ¾Ğ±Ñ€Ğ¾Ğ±Ğ½Ğ¸Ğº ĞºĞ»Ñ–ĞºÑƒ Ğ½Ğ°Ğ¿Ñ€ÑĞ¼Ñƒ â€” Ğ±ĞµĞ· dispatchEvent (iOS Ñ–Ğ³Ğ½Ğ¾Ñ€ÑƒÑ”)
        let t = e.changedTouches[0];
        _handleCanvasTap(t.clientX, t.clientY);
    }
}, { passive: true });

canvas.addEventListener('touchcancel', () => { isDragging = false; }, { passive: true });

// â”€â”€â”€ ĞĞ±Ñ€Ğ¾Ğ±Ğ½Ğ¸Ğº ĞºĞ»Ñ–ĞºÑƒ / Ñ‚Ğ°Ğ¿Ñƒ Ğ¿Ğ¾ canvas â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Ğ’Ğ¸ĞºĞ»Ğ¸ĞºĞ°Ñ”Ñ‚ÑŒÑÑ Ñ– Ğ· 'click' (desktop), Ñ– Ğ· touchend (iOS/Android)
function _handleCanvasTap(clientX, clientY) {
    let rect = canvas.getBoundingClientRect();
    let cx   = clientX - rect.left;
    let cy   = (clientY - rect.top) + GAME.cameraY;
    let lordIdx = floors.length - 1;

    // Ğ ĞµĞ¶Ğ¸Ğ¼ Ğ²Ğ¸Ğ±Ğ¾Ñ€Ñƒ Ğ¿Ğ¾Ğ²ĞµÑ€Ñ…Ñƒ Ğ´Ğ»Ñ Ğ¿Ğ°ÑÑ‚ĞºĞ¸
    if (pendingTrapType !== null) {
        let cost = TRAP_COSTS[pendingTrapType];
        let clicked = false;
        floors.forEach(f => {
            if (f.depth === lordIdx || f.hasTrap) return;
            let fx1 = centerX - CFG.floorW / 2;
            let fx2 = centerX + CFG.floorW / 2;
            // cy Ğ²Ğ¶Ğµ Ğ² world-ĞºĞ¾Ğ¾Ñ€Ğ´Ğ¸Ğ½Ğ°Ñ‚Ğ°Ñ…
            if (cx >= fx1 && cx <= fx2 && cy >= f.y - CFG.floorH && cy <= f.y) {
                if (GAME.souls >= cost) {
                    GAME.souls -= cost;
                    f.hasTrap = true;
                    f.trapType = pendingTrapType;
                    if (f.trapType === 'teleport') f.teleportCooldown = 0;
                    updateUI(); saveGame();
                }
                pendingTrapType = null;
                hideTrapPlacementHint();
                clicked = true;
            }
        });
        if (!clicked) {
            pendingTrapType = null;
            hideTrapPlacementHint();
        }
        return;
    }

    // ĞšĞ½Ğ¾Ğ¿ĞºĞ¸ Ğ°Ğ¿Ğ³Ñ€ĞµĞ¹Ğ´Ñƒ Ğ¿Ğ¾Ğ²ĞµÑ€Ñ…Ñƒ (Ğ¿Ñ€Ğ°Ğ²Ğ° ÑÑ‚Ğ¾Ñ€Ğ¾Ğ½Ğ°)
    floors.forEach(f => {
        if (f.depth === lordIdx || f.maxMonsters >= 5 || f._btnX == null) return;
        let pad = (typeof _TAP_PAD !== 'undefined') ? _TAP_PAD : 0;
        if (cx >= f._btnX - pad && cx <= f._btnX + f._btnW + pad &&
            cy >= f._btnY - pad && cy <= f._btnY + f._btnH + pad) {
            if (GAME.souls >= f.floorUpgradeCost) {
                GAME.souls -= f.floorUpgradeCost;
                f.maxMonsters++;
                f.floorUpgradeCost = Math.floor(f.floorUpgradeCost * 1.5);
                updateUI(); saveGame();
            }
        }
    });

    // ĞšĞ½Ğ¾Ğ¿ĞºĞ¸ "ĞšÑƒĞ¿Ğ¸Ñ‚Ğ¸ Ğ¼Ğ¾Ğ½ÑÑ‚Ñ€Ğ°" (Ğ»Ñ–Ğ²Ğ° ÑÑ‚Ğ¾Ñ€Ğ¾Ğ½Ğ°)
    floors.forEach(f => {
        if (f.depth === lordIdx || f._buyBtnX == null) return;
        let pad = (typeof _TAP_PAD !== 'undefined') ? _TAP_PAD : 0;
        if (cx >= f._buyBtnX - pad && cx <= f._buyBtnX + f._buyBtnW + pad &&
            cy >= f._buyBtnY - pad && cy <= f._buyBtnY + f._buyBtnH + pad) {
            let count = units.filter(u => u.type === 'monster' && u.floorIdx === f.depth).length;
            let buyCost = 15 + f.depth * 5;
            if (GAME.souls >= buyCost && count < f.maxMonsters) {
                GAME.souls -= buyCost;
                units.push(new Unit('monster', centerX, f.y, f.depth, f.depth + 1));
                updateUI(); saveGame();
            }
        }
    });
}

// Desktop click â†’ Ñ‚Ğ¾Ğ¹ ÑĞ°Ğ¼Ğ¸Ğ¹ Ğ¾Ğ±Ñ€Ğ¾Ğ±Ğ½Ğ¸Ğº
canvas.addEventListener('click', e => _handleCanvasTap(e.clientX, e.clientY));

// =================== ĞŸĞĞ£Ğ—Ğ ===================
let GAME_PAUSED = false;

function togglePause() {
    GAME_PAUSED = !GAME_PAUSED;
    document.getElementById('pause-overlay').style.display = GAME_PAUSED ? 'flex' : 'none';
    // ĞĞ½Ğ¾Ğ²Ğ»ÑÑ”Ğ¼Ğ¾ Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ½Ñ Ñ–Ğ½Ğ¿ÑƒÑ‚Ğ° Ğ¿Ñ€Ğ¸ Ğ²Ñ–Ğ´ĞºÑ€Ğ¸Ñ‚Ñ‚Ñ–
    if (GAME_PAUSED) {
        document.getElementById('threat-cap-input').value = GAME.maxThreatLevel >= 999 ? 999 : GAME.maxThreatLevel;
    } else {
        requestAnimationFrame(loop);
    }
}

// ĞĞ²Ñ‚Ğ¾-Ğ¿Ğ°ÑƒĞ·Ğ° Ğ¿Ñ€Ğ¸ Ğ·Ğ³Ğ¾Ñ€Ñ‚Ğ°Ğ½Ğ½Ñ– Ğ²ĞºĞ»Ğ°Ğ´ĞºĞ¸ (Ñ‚Ñ–Ğ»ÑŒĞºĞ¸ ÑĞºÑ‰Ğ¾ Ğ³Ñ€Ğ° Ğ²Ğ¶Ğµ Ğ·Ğ°Ğ¿ÑƒÑ‰ĞµĞ½Ğ°)
document.addEventListener('visibilitychange', () => {
    if (!GAME.gameStarted || GAME.gameOver) return;
    if (document.hidden && !GAME_PAUSED) {
        togglePause();
    }
});

function setThreatCap() {
    let val = parseInt(document.getElementById('threat-cap-input').value);
    GAME.maxThreatLevel = isNaN(val) || val < 0 ? 999 : val;
}

// Escape â€” ÑĞºĞ°ÑÑƒĞ²Ğ°Ñ‚Ğ¸ Ğ²Ğ¸Ğ±Ñ–Ñ€ Ğ¿Ğ°ÑÑ‚ĞºĞ¸
document.addEventListener('keydown', e => {
    if (e.key === 'Escape' && pendingTrapType !== null) {
        pendingTrapType = null;
        hideTrapPlacementHint();
    }
});

// =================== Ğ¡Ğ¢ĞĞ Ğ¢ĞĞ’Ğ˜Ğ™ Ğ•ĞšĞ ĞĞ â€” Ğ¾Ğ±Ñ€Ğ¾Ğ±Ğ½Ğ¸ĞºĞ¸ ===================
// Ğ’Ğ¸Ğ±Ñ–Ñ€ ÑĞºĞ»Ğ°Ğ´Ğ½Ğ¾ÑÑ‚Ñ– Ñ‡ĞµÑ€ĞµĞ· startGame(diff)

// Ğ’ÑÑ– ĞºĞ½Ğ¾Ğ¿ĞºĞ¸ Ğ¼Ğ°ÑÑ‚ÑŒ onclick Ğ°Ñ‚Ñ€Ğ¸Ğ±ÑƒÑ‚Ğ¸ Ğ² HTML â€” Ñ†Ğµ Ğ¾ÑĞ½Ğ¾Ğ²Ğ½Ğ¸Ğ¹ Ğ¼ĞµÑ…Ğ°Ğ½Ñ–Ğ·Ğ¼ Ğ´Ğ»Ñ iOS.
// ĞĞ¸Ğ¶Ñ‡Ğµ Ğ½Ñ–Ñ‡Ğ¾Ğ³Ğ¾ Ğ´Ğ¾Ğ´Ğ°Ñ‚ĞºĞ¾Ğ²Ğ¾Ğ³Ğ¾ Ğ½Ğµ Ğ¿Ğ¾Ñ‚Ñ€Ñ–Ğ±Ğ½Ğ¾.

// FPS throttle Ğ²Ğ¸Ğ´Ğ°Ğ»ĞµĞ½Ğ¾ â€” loop Ğ²Ğ¸ĞºĞ¾Ñ€Ğ¸ÑÑ‚Ğ¾Ğ²ÑƒÑ” Ğ¿Ñ€ÑĞ¼Ğ¸Ğ¹ requestAnimationFrame

// â”€â”€ Canvas tap-Ğ·Ğ¾Ğ½Ğ¸: Ğ·Ğ±Ñ–Ğ»ÑŒÑˆÑƒÑ”Ğ¼Ğ¾ Ñ…Ñ–Ñ‚-Ğ±Ğ¾ĞºÑ ĞºĞ½Ğ¾Ğ¿Ğ¾Ğº Ğ°Ğ¿Ğ³Ñ€ĞµĞ¹Ğ´Ñƒ Ñ‚Ğ° ĞºÑƒĞ¿Ñ–Ğ²Ğ»Ñ– â”€â”€â”€â”€â”€â”€â”€â”€
// Ğ—Ğ±ĞµÑ€Ñ–Ğ³Ğ°Ñ”Ğ¼Ğ¾ Ğ¾Ñ€Ğ¸Ğ³Ñ–Ğ½Ğ°Ğ»ÑŒĞ½Ğ¸Ğ¹ _btnH/W Ğ´Ğ»Ñ Ğ·Ğ±Ñ–Ğ»ÑŒÑˆĞµĞ½Ğ½Ñ Ğ·Ğ¾Ğ½Ğ¸ Ğ½Ğ° Â±10px Ğ· ĞºĞ¾Ğ¶Ğ½Ğ¾Ğ³Ğ¾ Ğ±Ğ¾ĞºÑƒ
const _TAP_PAD = isMobile ? 12 : 0;

init();
</script>
</body>
</html>
